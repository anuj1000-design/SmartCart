rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- HELPER FUNCTIONS ---
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isAdmin() {
      return request.auth != null && 
        (request.auth.token.email == 'admin1@example.com' || 
         request.auth.token.email == 'admin2@example.com');
    }

    // ðŸ‘‘ GOD MODE: Admins can do ANYTHING, ANYWHERE, ANYTIME
    // This rule MUST come first to override everything else
    match /{document=**} {
      allow read, write, list, get, create, update, delete: if isAdmin();
    }

    // --- RULES FOR REGULAR USERS (Admins bypass all of these) ---

    // Products: Must be signed in to view
    match /products/{productId} {
      allow read, list: if isSignedIn();
      // Allow users to update stock quantities during checkout
      allow update: if isSignedIn() && 
                      request.resource.data.diff(resource.data).affectedKeys().hasOnly(['stockQuantity', 'purchaseCount', 'updatedAt', 'averageRating', 'reviewCount']);
      
      // Reviews subcollection
      match /reviews/{reviewId} {
        allow read, list: if isSignedIn();
        allow create: if isSignedIn() && 
                        request.resource.data.userId == request.auth.uid &&
                        request.resource.data.userName != null && 
                        request.resource.data.rating != null;
        allow delete: if isSignedIn() && resource.data.userId == request.auth.uid;
        allow update: if isSignedIn() && resource.data.userId == request.auth.uid;
      }
      
      // Price History subcollection
      match /price_history/{historyId} {
        allow read, list: if isSignedIn();
        // Only admins can write price history (via admin bypass rule)
      }
      
      // Stock History subcollection
      match /stock_history/{historyId} {
        allow read, list: if isSignedIn();
        // Only admins can write stock history (via admin bypass rule)
      }
    }

    // Orders: Owner can see/create their own orders
    match /orders/{orderId} {
      allow read: if isSignedIn() && resource.data.userId == request.auth.uid;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if isSignedIn() && resource.data.userId == request.auth.uid && request.resource.data.userId == request.auth.uid;
      allow list: if isSignedIn();
    }

    // Receipts: Owner can see their own
    match /receipts/{receiptId} {
      allow read: if isSignedIn() && resource.data.userId == request.auth.uid;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if isSignedIn() && resource.data.userId == request.auth.uid && request.resource.data.userId == request.auth.uid;
      allow list: if isSignedIn();
    }

    // Users: Only owner can access their own data
    match /users/{userId} {
      allow read, write: if isOwner(userId);
      
      // Loyalty Transactions subcollection
      match /loyalty_transactions/{transactionId} {
        allow read, list: if isOwner(userId);
        // Only admins and LoyaltyProgramService can write (via authenticated user context)
      }
      
      match /{allSubcollections=**} {
        allow read, write, list: if isOwner(userId);
      }
    }

    // Feedback & Bug Reports: Users can manage their own
    match /feedbacks/{id} {
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow read, delete: if isSignedIn() && resource.data.userId == request.auth.uid;
      allow update: if isSignedIn() && resource.data.userId == request.auth.uid && request.resource.data.userId == request.auth.uid;
      allow list: if isSignedIn();
    }
    
    match /bug_reports/{id} {
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow read, delete: if isSignedIn() && resource.data.userId == request.auth.uid;
      allow update: if isSignedIn() && resource.data.userId == request.auth.uid && request.resource.data.userId == request.auth.uid;
      allow list: if isSignedIn();
    }

    // Analytics: Users can write, only visible to them
    match /analytics/{document=**} {
      allow write: if isSignedIn();
    }

    // Budgets: Users manage their own
    match /budgets/{budgetId} {
      allow read: if isSignedIn() && resource.data.userId == request.auth.uid;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if isSignedIn() && resource.data.userId == request.auth.uid && request.resource.data.userId == request.auth.uid;
      allow delete: if isSignedIn() && resource.data.userId == request.auth.uid;
      allow list: if isSignedIn();
    }

    // Addresses: Users manage their own
    match /addresses/{addressId} {
      allow read: if isSignedIn() && resource.data.userId == request.auth.uid;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if isSignedIn() && resource.data.userId == request.auth.uid && request.resource.data.userId == request.auth.uid;
      allow delete: if isSignedIn() && resource.data.userId == request.auth.uid;
      allow list: if isSignedIn();
    }

    // Shopping Lists: Users manage their own
    match /shopping_lists/{userId} {
      allow read, write: if isOwner(userId);
      match /items/{itemId} {
        allow read, write, list: if isOwner(userId);
      }
    }

    // Recently Viewed: Users manage their own
    match /recently_viewed/{userId} {
      allow read, write: if isOwner(userId);
      match /products/{productId} {
        allow read, write, list: if isOwner(userId);
      }
    }

    // Categories: Everyone can read, only admins can write (via bypass)
    match /categories/{categoryId} {
      allow read, list: if isSignedIn();
    }

    // Notifications: Users can read their own notifications
    match /notifications/{notificationId} {
      allow read: if isSignedIn() && resource.data.userId == request.auth.uid;
      allow list: if isSignedIn();
      // Only admins and Cloud Functions can create notifications
    }
    
    // Activity Logs: Only admins can access (via bypass rule)
    match /activity_logs/{logId} {
      allow read, write: if false;
      // Only accessible via admin bypass
    }
    
    // Suppliers: Users can read, only admins can write
    match /suppliers/{supplierId} {
      allow read, list: if isSignedIn();
      // Only admins can create/update/delete (via bypass rule)
    }
    
    // Support Tickets: Users can create and view their own
    match /support_tickets/{ticketId} {
      allow read, list: if isSignedIn() && resource.data.userId == request.auth.uid;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      // Only admins can update status (via bypass rule)
    }
    
    // Settings: Everyone can read app settings
    match /settings/{settingId} {
      allow read, list: if isSignedIn();
      // Only admins can write (via bypass rule)
    }
  }
}
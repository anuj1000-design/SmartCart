<!DOCTYPE html>
<html class="dark" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>SmartCart425 Admin-login</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="icons/favicon.png">
    <link rel="shortcut icon" href="icons/favicon.png" type="image/png">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet" />
    
    <!-- Tailwind CSS -->
    <link rel="stylesheet" href="/styles.css">
    
    <!-- Tailwind JS for config -->
    <script src="https://cdn.tailwindcss.com/"></script>
    
    <!-- Firebase SDK v8 -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    
    <!-- Chart.js for Analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    
    <!-- Config -->
    <script src="Config.js"></script>
    
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ["Inter", "sans-serif"],
                        mono: ["JetBrains Mono", "monospace"]
                    },
                    colors: {
                        slate: {
                            850: '#151e2e',
                            900: '#0f172a',
                            950: '#020617',
                        },
                        primary: {
                            400: "#34d399", // Emerald 400
                            500: "#10b981", // Emerald 500
                            600: "#059669", // Emerald 600
                        }
                    },
                    boxShadow: {
                        'glow': '0 0 20px rgba(16, 185, 129, 0.15)',
                        'glow-hover': '0 0 30px rgba(16, 185, 129, 0.3)',
                    },
                    animation: {
                        'shimmer': 'shimmer 2.5s infinite',
                    },
                    keyframes: {
                        shimmer: {
                            '0%': { backgroundPosition: '-1000px 0' },
                            '100%': { backgroundPosition: '1000px 0' }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        body {
            background-color: #020617; /* Slate 950 */
            background-image: 
                radial-gradient(circle at 15% 50%, rgba(16, 185, 129, 0.08), transparent 25%),
                radial-gradient(circle at 85% 30%, rgba(59, 130, 246, 0.08), transparent 25%);
            min-height: 100vh;
        }

        /* Glassmorphism Utilities */
        .glass-panel {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .glass-header {
            background: rgba(2, 6, 23, 0.8);
            backdrop-filter: blur(16px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* Spotlight Card Effect (Premium Hover) */
        .spotlight-card {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.08);
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(12px);
            transition: transform 0.3s ease, background 0.3s ease;
        }
        
        .spotlight-card::before {
            content: "";
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            border-radius: inherit;
            padding: 1px;
            background: radial-gradient(
                800px circle at var(--mouse-x) var(--mouse-y),
                rgba(52, 211, 153, 0.4),
                transparent 40%
            );
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }

        .spotlight-card:hover::before { opacity: 1; }
        .spotlight-card:hover { transform: translateY(-3px); background: rgba(30, 41, 59, 0.6); }

        /* Icon Hover Scale */
        .hover-scale-icon { transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .group:hover .hover-scale-icon { transform: scale(1.2) rotate(5deg); }

        /* Button Shimmer Effect */
        .btn-shimmer {
            background: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.1) 50%, rgba(255,255,255,0) 100%);
            background-size: 200% 100%;
            animation: shimmer 3s infinite;
            position: absolute;
            inset: 0;
            pointer-events: none;
        }

        /* Animations */
        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.98) translateY(10px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
        .animate-enter { animation: fadeInScale 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

        @keyframes slideInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-slide-up { animation: slideInUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

        /* Table row stagger animation */
        tbody tr {
            animation: slideInUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
            opacity: 0;
        }
        tbody tr:nth-child(1) { animation-delay: 0.05s; }
        tbody tr:nth-child(2) { animation-delay: 0.1s; }
        tbody tr:nth-child(3) { animation-delay: 0.15s; }
        tbody tr:nth-child(4) { animation-delay: 0.2s; }
        tbody tr:nth-child(5) { animation-delay: 0.25s; }
        
        /* Stagger glass panels */
        .glass-panel, .spotlight-card {
            animation: slideInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
            opacity: 0;
        }
        .spotlight-card:nth-child(1) { animation-delay: 0.1s; }
        .spotlight-card:nth-child(2) { animation-delay: 0.2s; }
        .spotlight-card:nth-child(3) { animation-delay: 0.3s; }
        .spotlight-card:nth-child(4) { animation-delay: 0.4s; }

        /* Loader */
        .loader {
            border: 2px solid rgba(255,255,255,0.1);
            border-left-color: #34d399;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="text-slate-300 antialiased selection:bg-primary-500/30 selection:text-primary-400" onmousemove="updateMouse(event)">

    <!-- Login Screen -->
    <div id="login-screen" class="fixed inset-0 z-50 flex items-center justify-center p-4">
        <!-- Background decorative elements -->
        <div class="absolute inset-0 bg-[url('https://grainy-gradients.vercel.app/noise.svg')] opacity-20 pointer-events-none"></div>
        <div class="absolute top-1/4 left-1/4 w-96 h-96 bg-primary-500/20 rounded-full blur-[100px] pointer-events-none"></div>

        <div class="glass-panel relative rounded-2xl p-10 max-w-md w-full text-center shadow-2xl border border-white/10 animate-enter">
            <div class="w-20 h-20 rounded-2xl flex items-center justify-center mx-auto mb-8 ring-1 ring-white/10 shadow-glow bg-slate-900/50">
                <img src="icons/favicon.png" alt="SmartCart Logo" class="w-16 h-16 object-contain drop-shadow-lg" onerror="this.src='https://cdn-icons-png.flaticon.com/512/3759/3759041.png'">
            </div>
            <h1 class="text-4xl font-bold mb-3 text-white tracking-tight">SmartCart<span class="text-primary-400">425</span></h1>
            <p class="text-slate-400 mb-10 text-lg">Admin Command Center</p>
            
            <button onclick="signIn()" class="group w-full relative overflow-hidden bg-white text-slate-900 font-bold py-4 px-6 rounded-xl hover:bg-slate-200 transition-all duration-300 flex items-center justify-center gap-3 shadow-lg hover:shadow-xl hover:scale-[1.02]">
                <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/50 to-transparent translate-x-[-100%] group-hover:translate-x-[100%] transition-transform duration-700"></div>
                <img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-6 h-6" alt="Google">
                <span>Sign in with Google</span>
            </button>
        </div>
    </div>

    <!-- Main App -->
    <div id="app-container" class="hidden min-h-screen flex flex-col">
        
        <!-- Header -->
        <header class="glass-header sticky top-0 z-40 transition-all duration-300">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-20">
                    <!-- Logo -->
                    <div class="flex items-center gap-4 group cursor-default">
                        <img src="icons/favicon.png" alt="Logo" class="w-10 h-10 rounded-lg shadow-lg object-contain bg-slate-900/50" onerror="this.src='https://cdn-icons-png.flaticon.com/512/3759/3759041.png'">
                        <div>
                            <h1 class="text-lg font-bold text-white tracking-tight group-hover:text-primary-400 transition-colors">SmartCart<span class="text-primary-400">425</span></h1>
                            <div class="flex items-center gap-2">
                                <span class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></span>
                                <p class="text-[10px] text-slate-400 font-mono uppercase tracking-wider">Live System</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Global Search -->
                    <div class="flex-1 max-w-md mx-8 hidden md:block">
                        <div class="relative group">
                            <input type="text" id="global-search" placeholder="Search products, orders, users..." class="w-full pl-10 pr-4 py-2.5 bg-slate-900/50 border border-white/10 rounded-xl text-white placeholder:text-slate-500 focus:outline-none focus:border-primary-500/50 focus:bg-slate-900/80 transition-all shadow-inner"/>
                            <span class="material-symbols-rounded absolute left-3 top-1/2 -translate-y-1/2 text-slate-500 text-lg pointer-events-none group-focus-within:text-primary-400 transition-colors">search</span>
                        </div>
                    </div>
                    
                    <!-- Right Actions -->
                    <div class="flex items-center gap-3">
                        <button onclick="toggleTheme()" class="p-2.5 text-slate-400 hover:text-white hover:bg-white/5 rounded-full transition-colors hidden">
                            <span class="material-symbols-rounded" id="theme-icon">light_mode</span>
                        </button>
                    </div>
                </div>
                
                <!-- Hamburger Menu Button -->
                <div class="flex items-center gap-4">
                    <button onclick="toggleMenu()" id="menu-btn" class="relative p-2 text-slate-400 hover:text-white hover:bg-white/5 rounded-lg transition-all duration-300 group">
                        <span class="material-symbols-rounded text-xl">menu</span>
                    </button>
                    
                    <!-- Current Tab Indicator -->
                    <div class="hidden md:flex items-center gap-2 px-3 py-1.5 bg-slate-800/50 rounded-lg border border-white/10">
                        <span class="material-symbols-rounded text-sm text-primary-400" id="current-tab-icon">dashboard</span>
                        <span class="text-sm font-medium text-white" id="current-tab-name">Dashboard</span>
                    </div>
                </div>
                
                <!-- Slide-out Navigation Menu -->
                <div id="slide-menu" class="fixed top-0 left-0 h-full w-80 bg-slate-900/95 backdrop-blur-xl border-r border-white/10 transform -translate-x-full transition-transform duration-300 ease-in-out z-50 shadow-2xl" style="display: none;">
                    <div class="flex flex-col h-full">
                        <!-- Menu Header -->
                        <div class="flex items-center justify-between p-6 border-b border-white/10">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 bg-primary-500 rounded-lg flex items-center justify-center">
                                    <span class="material-symbols-rounded text-white text-sm">shopping_cart</span>
                                </div>
                                <div>
                                    <h3 class="text-white font-bold text-lg">SmartCart</h3>
                                    <p class="text-slate-400 text-xs">Admin Panel</p>
                                </div>
                            </div>
                            <button onclick="toggleMenu()" class="p-2 text-slate-400 hover:text-white hover:bg-white/5 rounded-lg transition-all duration-300">
                                <span class="material-symbols-rounded">close</span>
                            </button>
                        </div>
                        
                        <!-- Menu Items -->
                        <div class="flex-1 py-6">
                            <div class="px-4 space-y-2">
                                <button onclick="selectMenuItem('dashboard', 'dashboard', 'Dashboard')" class="menu-item w-full flex items-center gap-3 px-4 py-3 text-left text-slate-300 hover:text-white hover:bg-white/5 rounded-lg transition-all duration-300 group active-menu" data-target="dashboard">
                                    <span class="material-symbols-rounded text-lg group-hover:scale-110 transition-transform">dashboard</span>
                                    <span class="font-medium">Dashboard</span>
                                </button>
                                
                                <button onclick="selectMenuItem('notify', 'notifications_active', 'Notify')" class="menu-item w-full flex items-center gap-3 px-4 py-3 text-left text-slate-300 hover:text-white hover:bg-white/5 rounded-lg transition-all duration-300 group" data-target="notify">
                                    <span class="material-symbols-rounded text-lg group-hover:scale-110 transition-transform">notifications_active</span>
                                    <span class="font-medium">Notify</span>
                                </button>
                                
                                <button onclick="selectMenuItem('products', 'inventory_2', 'Products')" class="menu-item w-full flex items-center gap-3 px-4 py-3 text-left text-slate-300 hover:text-white hover:bg-white/5 rounded-lg transition-all duration-300 group" data-target="products">
                                    <span class="material-symbols-rounded text-lg group-hover:scale-110 transition-transform">inventory_2</span>
                                    <span class="font-medium">Products</span>
                                </button>
                                
                                <button onclick="selectMenuItem('orders', 'shopping_bag', 'Orders')" class="menu-item w-full flex items-center gap-3 px-4 py-3 text-left text-slate-300 hover:text-white hover:bg-white/5 rounded-lg transition-all duration-300 group" data-target="orders">
                                    <span class="material-symbols-rounded text-lg group-hover:scale-110 transition-transform">shopping_bag</span>
                                    <span class="font-medium">Orders</span>
                                </button>
                                
                                <button onclick="selectMenuItem('users', 'people', 'Users')" class="menu-item w-full flex items-center gap-3 px-4 py-3 text-left text-slate-300 hover:text-white hover:bg-white/5 rounded-lg transition-all duration-300 group" data-target="users">
                                    <span class="material-symbols-rounded text-lg group-hover:scale-110 transition-transform">people</span>
                                    <span class="font-medium">Users</span>
                                </button>
                                
                                <button onclick="selectMenuItem('ratings', 'star', 'Ratings')" class="menu-item w-full flex items-center gap-3 px-4 py-3 text-left text-slate-300 hover:text-white hover:bg-white/5 rounded-lg transition-all duration-300 group" data-target="ratings">
                                    <span class="material-symbols-rounded text-lg group-hover:scale-110 transition-transform">star</span>
                                    <span class="font-medium">Ratings</span>
                                </button>
                                
                                <button onclick="selectMenuItem('analytics', 'analytics', 'Analytics')" class="menu-item w-full flex items-center gap-3 px-4 py-3 text-left text-slate-300 hover:text-white hover:bg-white/5 rounded-lg transition-all duration-300 group" data-target="analytics">
                                    <span class="material-symbols-rounded text-lg group-hover:scale-110 transition-transform">analytics</span>
                                    <span class="font-medium">Analytics</span>
                                </button>
                                
                                <button onclick="selectMenuItem('feedbacks', 'feedback', 'Feedbacks')" class="menu-item w-full flex items-center gap-3 px-4 py-3 text-left text-slate-300 hover:text-white hover:bg-white/5 rounded-lg transition-all duration-300 group" data-target="feedbacks">
                                    <span class="material-symbols-rounded text-lg group-hover:scale-110 transition-transform">feedback</span>
                                    <span class="font-medium">Feedbacks</span>
                                </button>
                                
                                <button onclick="selectMenuItem('support', 'support_agent', 'Support')" class="menu-item w-full flex items-center gap-3 px-4 py-3 text-left text-slate-300 hover:text-white hover:bg-white/5 rounded-lg transition-all duration-300 group" data-target="support">
                                    <span class="material-symbols-rounded text-lg group-hover:scale-110 transition-transform">support_agent</span>
                                    <span class="font-medium">Support</span>
                                </button>
                                
                                <button onclick="selectMenuItem('settings', 'settings', 'Settings')" class="menu-item w-full flex items-center gap-3 px-4 py-3 text-left text-slate-300 hover:text-white hover:bg-white/5 rounded-lg transition-all duration-300 group" data-target="settings">
                                    <span class="material-symbols-rounded text-lg group-hover:scale-110 transition-transform">settings</span>
                                    <span class="font-medium">Settings</span>
                                </button>
                                
                                <button onclick="selectMenuItem('bug-reports', 'bug_report', 'Bug Reports')" class="menu-item w-full flex items-center gap-3 px-4 py-3 text-left text-slate-300 hover:text-white hover:bg-white/5 rounded-lg transition-all duration-300 group" data-target="bug-reports">
                                    <span class="material-symbols-rounded text-lg group-hover:scale-110 transition-transform">bug_report</span>
                                    <span class="font-medium">Bug Reports</span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Menu Footer -->
                        <div class="p-6 border-t border-white/10">
                            <button onclick="signOut()" class="w-full flex items-center gap-3 px-4 py-3 text-left text-red-400 hover:text-red-300 hover:bg-red-500/10 rounded-lg transition-all duration-300 group">
                                <span class="material-symbols-rounded text-lg group-hover:rotate-180 transition-transform duration-500">logout</span>
                                <span class="font-medium">Sign Out</span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Menu Overlay -->
                <div id="menu-overlay" class="fixed inset-0 bg-black/50 backdrop-blur-sm opacity-0 invisible transition-all duration-300 z-40" onclick="toggleMenu()" style="display: none;"></div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 max-w-7xl mx-auto w-full px-4 sm:px-6 lg:px-8 py-8">

            <!-- Notify Tab -->
            <div id="tab-notify" class="tab-content hidden animate-enter">
                <div class="flex flex-col lg:flex-row gap-8">
                    <div class="glass-panel rounded-2xl p-8 w-full lg:max-w-md">
                        <h2 class="text-2xl font-bold text-white mb-6 flex items-center gap-2">
                            <span class="material-symbols-rounded text-primary-400">notifications_active</span>
                            Send Notification to All Users
                        </h2>
                        <form id="notify-form" onsubmit="sendNotificationToAll(event)">
                            <div class="mb-4">
                                <label class="block text-slate-400 mb-2 font-medium">Title</label>
                                <input type="text" id="notify-title" required class="w-full bg-slate-900/50 border border-white/10 rounded-lg px-4 py-2.5 text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all" placeholder="Notification title">
                            </div>
                            <div class="mb-6">
                                <label class="block text-slate-400 mb-2 font-medium">Message</label>
                                <textarea id="notify-message" required class="w-full bg-slate-900/50 border border-white/10 rounded-lg px-4 py-2.5 text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all" rows="4" placeholder="Notification message"></textarea>
                            </div>
                            <button type="submit" class="px-6 py-3 bg-primary-600 hover:bg-primary-500 text-white rounded-xl font-bold shadow-lg shadow-primary-500/20 transition-all w-full">Send Notification</button>
                        </form>
                        <div id="notify-status" class="mt-4 text-center text-sm"></div>
                    </div>
                    <div class="glass-panel rounded-2xl p-6 w-full">
                        <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                            <span class="material-symbols-rounded text-primary-400">history</span>
                            Notification History
                        </h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left border-collapse">
                                <thead class="bg-slate-900/80 text-xs uppercase text-slate-400 font-medium tracking-wider">
                                    <tr>
                                        <th class="px-4 py-3">Title</th>
                                        <th class="px-4 py-3">Message</th>
                                        <th class="px-4 py-3">Sent At</th>
                                        <th class="px-4 py-3 text-right">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="notification-history-table" class="divide-y divide-white/5 text-sm">
                                    <tr><td colspan="4" class="px-4 py-8 text-center text-slate-500">Loading history...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dashboard Tab -->
            <div id="tab-dashboard" class="tab-content animate-enter">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-3xl font-bold text-white tracking-tight">Dashboard & Sales</h2>
                        <p class="text-slate-400 text-sm mt-1">Revenue analytics and inventory overview</p>
                    </div>
                    <button onclick="loadSalesData()" class="px-6 py-2.5 bg-primary-600 hover:bg-primary-700 text-white rounded-xl font-semibold shadow-lg shadow-primary-500/20 transition-all flex items-center gap-2">
                        <span class="material-symbols-rounded text-sm">refresh</span>
                        <span>Refresh</span>
                    </button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
                    <!-- Spotlight Stat Cards -->
                    <div class="spotlight-card p-6 rounded-2xl group cursor-default">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-12 h-12 rounded-xl bg-blue-500/10 flex items-center justify-center text-blue-400 border border-blue-500/20 group-hover:scale-110 transition-transform duration-300">
                                <span class="material-symbols-rounded text-2xl hover-scale-icon">inventory_2</span>
                            </div>
                            <span class="text-[10px] font-bold tracking-widest text-emerald-400 bg-emerald-500/10 border border-emerald-500/20 px-2 py-1 rounded-full">ACTIVE</span>
                        </div>
                        <h3 class="text-3xl font-bold text-white mb-1 tracking-tight" id="stat-total-products">0</h3>
                        <p class="text-slate-400 text-sm font-medium">Total Inventory</p>
                    </div>
                    
                    <div class="spotlight-card p-6 rounded-2xl group cursor-default">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-12 h-12 rounded-xl bg-orange-500/10 flex items-center justify-center text-orange-400 border border-orange-500/20 group-hover:scale-110 transition-transform duration-300">
                                <span class="material-symbols-rounded text-2xl hover-scale-icon">warning</span>
                            </div>
                        </div>
                        <h3 class="text-3xl font-bold text-orange-400 mb-1 tracking-tight" id="stat-low-stock">0</h3>
                        <p class="text-slate-400 text-sm font-medium">Low Stock Alerts</p>
                    </div>
                    
                    <div class="spotlight-card p-6 rounded-2xl group cursor-default">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-12 h-12 rounded-xl bg-emerald-500/10 flex items-center justify-center text-emerald-400 border border-emerald-500/20 group-hover:scale-110 transition-transform duration-300">
                                <span class="material-symbols-rounded text-2xl hover-scale-icon">shopping_bag</span>
                            </div>
                        </div>
                        <h3 class="text-3xl font-bold text-white mb-1 tracking-tight" id="stat-total-orders">0</h3>
                        <p class="text-slate-400 text-sm font-medium">Total Orders</p>
                    </div>
                    
                    <div class="spotlight-card p-6 rounded-2xl group cursor-default relative">
                        <div class="absolute top-0 right-0 w-32 h-32 bg-purple-500/10 rounded-full blur-3xl -mr-16 -mt-16 pointer-events-none"></div>
                        <div class="flex items-center justify-between mb-4 relative z-10">
                            <div class="w-12 h-12 rounded-xl bg-purple-500/10 flex items-center justify-center text-purple-400 border border-purple-500/20 group-hover:scale-110 transition-transform duration-300">
                                <span class="material-symbols-rounded text-2xl hover-scale-icon">currency_rupee</span>
                            </div>
                        </div>
                        <h3 class="text-3xl font-bold text-white mb-1 tracking-tight relative z-10" id="stat-total-revenue">₹0</h3>
                        <p class="text-slate-400 text-sm font-medium relative z-10">Total Revenue</p>
                    </div>
                    
                    <div class="spotlight-card p-6 rounded-2xl group cursor-default">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-12 h-12 rounded-xl bg-cyan-500/10 flex items-center justify-center text-cyan-400 border border-cyan-500/20 group-hover:scale-110 transition-transform duration-300">
                                <span class="material-symbols-rounded text-2xl hover-scale-icon">avg_pace</span>
                            </div>
                        </div>
                        <h3 class="text-3xl font-bold text-white mb-1 tracking-tight" id="avg-order-value">₹0</h3>
                        <p class="text-slate-400 text-sm font-medium">Avg Order Value</p>
                    </div>
                </div>
                
                <!-- Top Selling Products -->
                <div class="glass-panel rounded-2xl p-6 mb-8">
                    <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                        <span class="material-symbols-rounded text-primary-400">leaderboard</span>
                        Top Selling Products
                    </h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="text-xs text-slate-400 uppercase border-b border-white/5">
                                <tr>
                                    <th class="px-6 py-4">Product</th>
                                    <th class="px-6 py-4">Sales</th>
                                    <th class="px-6 py-4">Revenue</th>
                                    <th class="px-6 py-4">Stock</th>
                                </tr>
                            </thead>
                            <tbody id="top-products-tbody" class="divide-y divide-white/5 text-sm">
                                <tr><td colspan="4" class="px-6 py-8 text-center text-slate-500">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Low Stock Alerts -->
                <div class="glass-panel rounded-2xl p-6 md:p-8">
                    <h2 class="text-xl font-bold text-white mb-6 flex items-center gap-3">
                        <span class="flex h-3 w-3 relative">
                            <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-orange-400 opacity-75"></span>
                            <span class="relative inline-flex rounded-full h-3 w-3 bg-orange-500"></span>
                        </span>
                        Low Stock Attention
                    </h2>
                    <div id="low-stock-list" class="space-y-3">
                        <p class="text-slate-500 italic text-sm py-4">All systems normal. Stock levels sufficient.</p>
                    </div>
                </div>
            </div>

            <!-- Products Tab -->
            <div id="tab-products" class="tab-content hidden animate-enter">
                <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                    <div>
                        <h2 class="text-3xl font-bold text-white tracking-tight">Inventory</h2>
                        <p class="text-slate-400 text-sm mt-1">Manage your product catalog</p>
                    </div>
                    <div class="flex flex-col md:flex-row gap-3 w-full md:w-auto">
                        <input type="file" id="import-csv-file" accept=".csv" class="hidden" onchange="handleCSVImport(event)">
                        <button onclick="document.getElementById('import-csv-file').click()" class="px-6 py-2.5 bg-slate-800 hover:bg-slate-700 text-white rounded-xl font-semibold border border-white/10 shadow-lg transition-all flex items-center justify-center gap-2 group">
                            <span class="material-symbols-rounded text-sm">upload</span>
                            Import CSV
                        </button>
                        <button onclick="exportProductsCSV()" class="px-6 py-2.5 bg-slate-800 hover:bg-slate-700 text-white rounded-xl font-semibold border border-white/10 shadow-lg transition-all flex items-center justify-center gap-2 group">
                            <span class="material-symbols-rounded text-sm">download</span>
                            Export CSV
                        </button>
                        <button onclick="printProducts()" class="px-6 py-2.5 bg-slate-800 hover:bg-slate-700 text-white rounded-xl font-semibold border border-white/10 shadow-lg transition-all flex items-center justify-center gap-2 group">
                            <span class="material-symbols-rounded text-sm">print</span>
                            Print
                        </button>
                        <button onclick="openAddProductModal()" class="relative px-6 py-2.5 bg-primary-600 hover:bg-primary-500 text-white rounded-xl font-bold shadow-lg shadow-primary-500/20 hover:shadow-primary-500/40 transition-all flex items-center justify-center gap-2 group overflow-hidden">
                            <span class="relative z-10 flex items-center gap-2">
                                <span class="material-symbols-rounded group-hover:rotate-90 transition-transform">add</span>
                                Add Product
                            </span>
                            <div class="btn-shimmer"></div>
                        </button>
                    </div>
                </div>
                
                <div class="glass-panel rounded-2xl overflow-hidden border border-white/5">
                    <div class="p-4 border-b border-white/5 bg-slate-900/50">
                        <div class="relative">
                            <span class="material-symbols-rounded absolute left-4 top-3 text-slate-500">search</span>
                            <input type="text" id="search-products" onkeyup="filterProducts()" placeholder="Search by barcode, name, or category..." 
                                class="w-full pl-12 pr-4 py-2.5 bg-slate-900/50 border border-white/10 rounded-xl text-white placeholder-slate-500 focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all">
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead class="bg-slate-900/80 text-xs uppercase text-slate-400 font-medium tracking-wider">
                                <tr>
                                    <th class="px-6 py-4">Product</th>
                                    <th class="px-6 py-4">Barcode</th>
                                    <th class="px-6 py-4">Category</th>
                                    <th class="px-6 py-4">Price</th>
                                    <th class="px-6 py-4">Stock</th>
                                    <th class="px-6 py-4 text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="products-table" class="divide-y divide-white/5 text-sm">
                                <tr><td colspan="6" class="px-6 py-12 text-center text-slate-500"><div class="inline-block loader mr-2"></div> Loading data...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Orders Tab -->
            <div id="tab-orders" class="tab-content hidden animate-enter">
                <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                    <div>
                        <h2 class="text-3xl font-bold text-white tracking-tight">Orders</h2>
                        <p class="text-slate-400 text-sm mt-1">Real-time transaction history</p>
                    </div>
                    <div class="flex flex-col md:flex-row gap-3 w-full md:w-auto">
                        <button onclick="exportOrdersCSV()" class="px-6 py-2.5 bg-slate-800 hover:bg-slate-700 text-white rounded-xl font-semibold border border-white/10 shadow-lg transition-all flex items-center justify-center gap-2 group">
                            <span class="material-symbols-rounded text-sm">download</span>
                            CSV
                        </button>
                        <button onclick="printOrders()" class="px-6 py-2.5 bg-slate-800 hover:bg-slate-700 text-white rounded-xl font-semibold border border-white/10 shadow-lg transition-all flex items-center justify-center gap-2 group">
                            <span class="material-symbols-rounded text-sm">print</span>
                            Print
                        </button>
                    </div>
                </div>
                
                <div class="glass-panel rounded-2xl overflow-hidden border border-white/5">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-slate-900/80 text-xs uppercase text-slate-400 font-medium tracking-wider">
                                <tr>
                                    <th class="px-6 py-4">Receipt #</th>
                                    <th class="px-6 py-4">Order #</th>
                                    <th class="px-6 py-4">Exit Code</th>
                                    <th class="px-6 py-4">Date & Time</th>
                                    <th class="px-6 py-4">Items</th>
                                    <th class="px-6 py-4">Total Amount</th>
                                    <th class="px-6 py-4">Method</th>
                                </tr>
                            </thead>
                            <tbody id="orders-table" class="divide-y divide-white/5 text-sm">
                                <tr><td colspan="7" class="px-6 py-12 text-center text-slate-500"><div class="inline-block loader mr-2"></div> Fetching orders...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Users Tab -->
            <div id="tab-users" class="tab-content hidden animate-enter">
                <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                    <div>
                        <h2 class="text-3xl font-bold text-white tracking-tight">Users</h2>
                        <p class="text-slate-400 text-sm mt-1">Customer management</p>
                    </div>
                    <div class="flex flex-col md:flex-row gap-3 w-full md:w-auto">
                        <button onclick="exportUsersCSV()" class="px-6 py-2.5 bg-slate-800 hover:bg-slate-700 text-white rounded-xl font-semibold border border-white/10 shadow-lg transition-all flex items-center justify-center gap-2 group">
                            <span class="material-symbols-rounded text-sm">download</span>
                            CSV
                        </button>
                        <button onclick="printUsers()" class="px-6 py-2.5 bg-slate-800 hover:bg-slate-700 text-white rounded-xl font-semibold border border-white/10 shadow-lg transition-all flex items-center justify-center gap-2 group">
                            <span class="material-symbols-rounded text-sm">print</span>
                            Print
                        </button>
                    </div>
                </div>
                
                <!-- User Stats -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="spotlight-card p-6 rounded-2xl">
                        <h3 class="text-slate-400 text-sm font-medium mb-2 uppercase tracking-wide">Total Users</h3>
                        <p class="text-3xl font-bold text-white" id="stat-total-users">0</p>
                    </div>
                    <div class="spotlight-card p-6 rounded-2xl">
                        <h3 class="text-slate-400 text-sm font-medium mb-2 uppercase tracking-wide">Active Users</h3>
                        <p class="text-3xl font-bold text-emerald-400" id="stat-active-users">0</p>
                    </div>
                    <div class="spotlight-card p-6 rounded-2xl">
                        <h3 class="text-slate-400 text-sm font-medium mb-2 uppercase tracking-wide">Suspended</h3>
                        <p class="text-3xl font-bold text-red-400" id="stat-suspended-users">0</p>
                    </div>
                </div>
                
                <div class="glass-panel rounded-2xl overflow-hidden border border-white/5">
                    <div class="p-4 border-b border-white/5 bg-slate-900/50">
                        <div class="relative">
                            <span class="material-symbols-rounded absolute left-4 top-3 text-slate-500">search</span>
                            <input type="text" id="search-users" onkeyup="filterUsers()" placeholder="Search by email or name..." 
                                class="w-full bg-slate-900/50 border border-slate-700 rounded-lg pl-12 pr-4 py-2.5 text-white placeholder-slate-500 focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all">
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead class="bg-slate-900/80 text-xs uppercase text-slate-400 font-medium tracking-wider">
                                <tr>
                                    <th class="px-6 py-4">Avatar</th>
                                    <th class="px-6 py-4">Email</th>
                                    <th class="px-6 py-4">Name</th>
                                    <th class="px-6 py-4">Phone</th>
                                    <th class="px-6 py-4">Role</th>
                                    <th class="px-6 py-4">Total Spent</th>
                                    <th class="px-6 py-4">Orders</th>
                                    <th class="px-6 py-4">Last Active</th>
                                    <th class="px-6 py-4">Status</th>
                                    <th class="px-6 py-4">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="users-table" class="divide-y divide-white/5 text-sm">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Ratings Tab -->
            <div id="tab-ratings" class="tab-content hidden animate-enter">
                <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                    <div>
                        <h2 class="text-3xl font-bold text-white tracking-tight">Product Ratings & Reviews</h2>
                        <p class="text-slate-400 text-sm mt-1">User ratings analytics across all products</p>
                    </div>
                    <div class="flex flex-col md:flex-row gap-3 w-full md:w-auto">
                        <button onclick="refreshRatingsData()" class="px-6 py-2.5 bg-primary-600 hover:bg-primary-700 text-white rounded-xl font-semibold border border-primary-500/10 shadow-lg shadow-primary-500/20 transition-all flex items-center justify-center gap-2 group">
                            <span class="material-symbols-rounded text-sm">refresh</span>
                            Refresh
                        </button>
                    </div>
                </div>

                <!-- Overall Stats Cards -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="spotlight-card rounded-2xl p-6">
                        <div class="flex items-center justify-between mb-4">
                            <span class="material-symbols-rounded text-orange-400 text-3xl">star</span>
                            <span class="text-xs font-semibold px-2.5 py-1 rounded-full bg-orange-500/20 text-orange-400">OVERALL</span>
                        </div>
                        <h3 class="text-3xl font-bold text-white mb-1" id="overall-avg-rating">0.0</h3>
                        <p class="text-slate-400 text-sm">Average Rating</p>
                    </div>
                    
                    <div class="spotlight-card rounded-2xl p-6">
                        <div class="flex items-center justify-between mb-4">
                            <span class="material-symbols-rounded text-blue-400 text-3xl">reviews</span>
                            <span class="text-xs font-semibold px-2.5 py-1 rounded-full bg-blue-500/20 text-blue-400">TOTAL</span>
                        </div>
                        <h3 class="text-3xl font-bold text-white mb-1" id="total-reviews">0</h3>
                        <p class="text-slate-400 text-sm">Total Reviews</p>
                    </div>
                    
                    <div class="spotlight-card rounded-2xl p-6">
                        <div class="flex items-center justify-between mb-4">
                            <span class="material-symbols-rounded text-green-400 text-3xl">inventory_2</span>
                            <span class="text-xs font-semibold px-2.5 py-1 rounded-full bg-green-500/20 text-green-400">PRODUCTS</span>
                        </div>
                        <h3  class="text-3xl font-bold text-white mb-1" id="rated-products">0</h3>
                        <p class="text-slate-400 text-sm">Rated Products</p>
                    </div>
                    
                    <div class="spotlight-card rounded-2xl p-6">
                        <div class="flex items-center justify-between mb-4">
                            <span class="material-symbols-rounded text-purple-400 text-3xl">person</span>
                            <span class="text-xs font-semibold px-2.5 py-1 rounded-full bg-purple-500/20 text-purple-400">USERS</span>
                        </div>
                        <h3 class="text-3xl font-bold text-white mb-1" id="active-reviewers">0</h3>
                        <p class="text-slate-400 text-sm">Active Reviewers</p>
                    </div>
                </div>

                <!-- Two Column Layout -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <!-- Most Reviewed Products -->
                    <div class="spotlight-card rounded-2xl p-6">
                        <h3 class="text-lg font-bold text-white mb-6 flex items-center gap-2">
                            <span class="material-symbols-rounded text-yellow-400">trending_up</span>
                            Most Reviewed Products
                        </h3>
                        <div id="top-rated-products" class="space-y-4">
                            <div class="flex items-center justify-center py-12 text-slate-500">
                                <span class="material-symbols-rounded text-4xl">hourglass_empty</span>
                                <p class="ml-3">Loading...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Rating Distribution -->
                    <div class="spotlight-card rounded-2xl p-6">
                        <h3 class="text-lg font-bold text-white mb-6 flex items-center gap-2">
                            <span class="material-symbols-rounded text-blue-400">bar_chart</span>
                            Rating Distribution
                        </h3>
                        <div id="rating-distribution" class="space-y-3">
                            <div class="flex items-center gap-3">
                                <span class="text-sm text-slate-400 w-8">5 ★</span>
                                <div class="flex-1 h-8 bg-slate-800 rounded-lg overflow-hidden">
                                    <div id="rating-bar-5" class="h-full bg-gradient-to-r from-yellow-500 to-orange-500 transition-all duration-500" style="width: 0%"></div>
                                </div>
                                <span id="rating-count-5" class="text-sm text-slate-300 w-12 text-right">0</span>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="text-sm text-slate-400 w-8">4 ★</span>
                                <div class="flex-1 h-8 bg-slate-800 rounded-lg overflow-hidden">
                                    <div id="rating-bar-4" class="h-full bg-gradient-to-r from-green-500 to-emerald-500 transition-all duration-500" style="width: 0%"></div>
                                </div>
                                <span id="rating-count-4" class="text-sm text-slate-300 w-12 text-right">0</span>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="text-sm text-slate-400 w-8">3 ★</span>
                                <div class="flex-1 h-8 bg-slate-800 rounded-lg overflow-hidden">
                                    <div id="rating-bar-3" class="h-full bg-gradient-to-r from-blue-500 to-cyan-500 transition-all duration-500" style="width: 0%"></div>
                                </div>
                                <span id="rating-count-3" class="text-sm text-slate-300 w-12 text-right">0</span>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="text-sm text-slate-400 w-8">2 ★</span>
                                <div class="flex-1 h-8 bg-slate-800 rounded-lg overflow-hidden">
                                    <div id="rating-bar-2" class="h-full bg-gradient-to-r from-orange-500 to-yellow-600 transition-all duration-500" style="width: 0%"></div>
                                </div>
                                <span id="rating-count-2" class="text-sm text-slate-300 w-12 text-right">0</span>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="text-sm text-slate-400 w-8">1 ★</span>
                                <div class="flex-1 h-8 bg-slate-800 rounded-lg overflow-hidden">
                                    <div id="rating-bar-1" class="h-full bg-gradient-to-r from-red-500 to-pink-500 transition-all duration-500" style="width: 0%"></div>
                                </div>
                                <span id="rating-count-1" class="text-sm text-slate-300 w-12 text-right">0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- User Ratings Table -->
                <div class="spotlight-card rounded-2xl p-6">
                    <h3 class="text-lg font-bold text-white mb-6 flex items-center gap-2">
                        <span class="material-symbols-rounded text-purple-400">people</span>
                        User Ratings Activity
                    </h3>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b border-white/10">
                                    <th class="px-6 py-3 text-left text-xs font-semibold text-slate-400 uppercase tracking-wider">User</th>
                                    <th class="px-6 py-3 text-left text-xs font-semibold text-slate-400 uppercase tracking-wider">Reviews Count</th>
                                    <th class="px-6 py-3 text-left text-xs font-semibold text-slate-400 uppercase tracking-wider">Avg Rating</th>
                                    <th class="px-6 py-3 text-left text-xs font-semibold text-slate-400 uppercase tracking-wider">Last Review</th>
                                </tr>
                            </thead>
                            <tbody id="user-ratings-tbody" class="divide-y divide-white/5">
                                <tr>
                                    <td colspan="4" class="px-6 py-12 text-center text-slate-500">
                                        <span class="material-symbols-rounded text-4xl mb-2">hourglass_empty</span>
                                        <p>Loading user ratings...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Analytics Tab -->
            <div id="tab-analytics" class="tab-content hidden animate-enter">
                <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                    <div>
                        <h2 class="text-3xl font-bold text-white tracking-tight">Analytics</h2>
                        <p class="text-slate-400 text-sm mt-1">Performance metrics and insights</p>
                    </div>
                    <div class="flex flex-col md:flex-row gap-3 w-full md:w-auto">
                        <button onclick="loadAnalyticsData()" class="px-6 py-2.5 bg-primary-600 hover:bg-primary-700 text-white rounded-xl font-semibold shadow-lg transition-all flex items-center gap-2">
                            <span class="material-symbols-rounded text-sm">refresh</span>
                            Refresh
                        </button>
                        <button onclick="exportAnalyticsCSV()" class="px-6 py-2.5 bg-slate-800 hover:bg-slate-700 text-white rounded-xl font-semibold border border-white/10 shadow-lg transition-all flex items-center justify-center gap-2 group">
                            <span class="material-symbols-rounded text-sm">download</span>
                            CSV
                        </button>
                        <button onclick="printAnalytics()" class="px-6 py-2.5 bg-slate-800 hover:bg-slate-700 text-white rounded-xl font-semibold border border-white/10 shadow-lg transition-all flex items-center justify-center gap-2 group">
                            <span class="material-symbols-rounded text-sm">print</span>
                            Print
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <!-- User Activity -->
                    <div class="spotlight-card rounded-2xl p-6">
                        <h3 class="text-lg font-bold text-white mb-6 flex items-center gap-2">
                            <span class="material-symbols-rounded text-purple-400">pie_chart</span>
                            User Activity
                        </h3>
                        <div class="relative" style="height: 300px;">
                            <canvas id="user-activity-chart"></canvas>
                        </div>
                    </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <div class="spotlight-card rounded-2xl p-6">
                        <h3 class="text-lg font-bold text-white mb-6 flex items-center gap-2">
                            <span class="material-symbols-rounded text-yellow-400">trophy</span>
                            Top Performing Products
                        </h3>
                        <div class="relative" style="height: 300px;">
                            <canvas id="top-products-chart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Stock Status -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <div class="spotlight-card rounded-2xl p-6">
                        <h3 class="text-lg font-bold text-white mb-6 flex items-center gap-2">
                            <span class="material-symbols-rounded text-orange-400">inventory_2</span>
                            Stock Status
                        </h3>
                        <div class="relative" style="height: 300px;">
                            <canvas id="stock-status-chart"></canvas>
                        </div>
                    </div>

                    <div class="spotlight-card rounded-2xl p-6">
                        <h3 class="text-lg font-bold text-white mb-6 flex items-center gap-2">
                            <span class="material-symbols-rounded text-pink-400">category</span>
                            Category Distribution
                        </h3>
                        <div class="relative" style="height: 300px;">
                            <canvas id="category-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Feedbacks Tab -->
            <div id="tab-feedbacks" class="tab-content hidden animate-enter">
                <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                    <div>
                        <h2 class="text-3xl font-bold text-white tracking-tight">User Feedbacks</h2>
                        <p class="text-slate-400 text-sm mt-1">Reviews and suggestions</p>
                    </div>
                    <div class="flex flex-col md:flex-row gap-3 w-full md:w-auto">
                        <button onclick="exportFeedbacksCSV()" class="px-6 py-2.5 bg-slate-800 hover:bg-slate-700 text-white rounded-xl font-semibold border border-white/10 shadow-lg transition-all flex items-center justify-center gap-2 group">
                            <span class="material-symbols-rounded text-sm">download</span>
                            CSV
                        </button>
                        <button onclick="printFeedbacks()" class="px-6 py-2.5 bg-slate-800 hover:bg-slate-700 text-white rounded-xl font-semibold border border-white/10 shadow-lg transition-all flex items-center justify-center gap-2 group">
                            <span class="material-symbols-rounded text-sm">print</span>
                            Print
                        </button>
                    </div>
                </div>
                
                <div class="glass-panel rounded-2xl overflow-hidden border border-white/5">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-slate-900/80 text-xs uppercase text-slate-400 font-medium tracking-wider">
                                <tr>
                                    <th class="px-6 py-4">User Email</th>
                                    <th class="px-6 py-4">Rating</th>
                                    <th class="px-6 py-4">Feedback</th>
                                    <th class="px-6 py-4">Category</th>
                                    <th class="px-6 py-4">Date</th>
                                </tr>
                            </thead>
                            <tbody id="feedbacks-table" class="divide-y divide-white/5 text-sm">
                                <tr><td colspan="5" class="px-6 py-12 text-center text-slate-500"><div class="inline-block loader mr-2"></div> Fetching feedbacks...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Bug Reports Tab -->
            <div id="tab-bug-reports" class="tab-content hidden animate-enter">
                <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                    <div>
                        <h2 class="text-3xl font-bold text-white tracking-tight">Bug Reports</h2>
                        <p class="text-slate-400 text-sm mt-1">Issues reported by users</p>
                    </div>
                    <div class="flex flex-col md:flex-row gap-3 w-full md:w-auto">
                        <button onclick="exportBugReportsCSV()" class="px-6 py-2.5 bg-slate-800 hover:bg-slate-700 text-white rounded-xl font-semibold border border-white/10 shadow-lg transition-all flex items-center justify-center gap-2 group">
                            <span class="material-symbols-rounded text-sm">download</span>
                            CSV
                        </button>
                        <button onclick="printBugReports()" class="px-6 py-2.5 bg-slate-800 hover:bg-slate-700 text-white rounded-xl font-semibold border border-white/10 shadow-lg transition-all flex items-center justify-center gap-2 group">
                            <span class="material-symbols-rounded text-sm">print</span>
                            Print
                        </button>
                    </div>
                </div>
                
                <div class="glass-panel rounded-2xl overflow-hidden border border-white/5">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-slate-900/80 text-xs uppercase text-slate-400 font-medium tracking-wider">
                                <tr>
                                    <th class="px-6 py-4">User Email</th>
                                    <th class="px-6 py-4">Title</th>
                                    <th class="px-6 py-4">Description</th>
                                    <th class="px-6 py-4">Status</th>
                                    <th class="px-6 py-4">Date</th>
                                </tr>
                            </thead>
                            <tbody id="bug-reports-table" class="divide-y divide-white/5 text-sm">
                                <tr><td colspan="5" class="px-6 py-12 text-center text-slate-500"><div class="inline-block loader mr-2"></div> Fetching bug reports...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Support Tickets Tab -->
            <div id="tab-support" class="tab-content hidden animate-enter">
                <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                    <div>
                        <h2 class="text-3xl font-bold text-white tracking-tight">Support Tickets</h2>
                        <p class="text-slate-400 text-sm mt-1">Manage customer support requests</p>
                    </div>
                </div>

                <!-- Ticket Stats -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                    <div class="glass-panel rounded-2xl p-4">
                        <div class="flex items-center justify-between">
                            <span class="text-blue-400 material-symbols-rounded">new_releases</span>
                            <span class="text-2xl font-bold text-blue-400" id="open-tickets">0</span>
                        </div>
                        <p class="text-white font-medium mt-2">Open</p>
                    </div>
                    <div class="glass-panel rounded-2xl p-4">
                        <div class="flex items-center justify-between">
                            <span class="text-yellow-400 material-symbols-rounded">pending</span>
                            <span class="text-2xl font-bold text-yellow-400" id="pending-tickets">0</span>
                        </div>
                        <p class="text-white font-medium mt-2">Pending</p>
                    </div>
                    <div class="glass-panel rounded-2xl p-4">
                        <div class="flex items-center justify-between">
                            <span class="text-orange-400 material-symbols-rounded">schedule</span>
                            <span class="text-2xl font-bold text-orange-400" id="inprogress-tickets">0</span>
                        </div>
                        <p class="text-white font-medium mt-2">In Progress</p>
                    </div>
                    <div class="glass-panel rounded-2xl p-4">
                        <div class="flex items-center justify-between">
                            <span class="text-green-400 material-symbols-rounded">check_circle</span>
                            <span class="text-2xl font-bold text-green-400" id="resolved-tickets">0</span>
                        </div>
                        <p class="text-white font-medium mt-2">Resolved</p>
                    </div>
                </div>

                <!-- Tickets Table -->
                <div class="glass-panel rounded-2xl overflow-hidden border border-white/5">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-slate-900/80 text-xs uppercase text-slate-400 font-medium tracking-wider">
                                <tr>
                                    <th class="px-6 py-4">ID</th>
                                    <th class="px-6 py-4">Customer</th>
                                    <th class="px-6 py-4">Subject</th>
                                    <th class="px-6 py-4">Priority</th>
                                    <th class="px-6 py-4">Status</th>
                                    <th class="px-6 py-4">Created</th>
                                    <th class="px-6 py-4 text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="tickets-table" class="divide-y divide-white/5 text-sm">
                                <tr><td colspan="7" class="px-6 py-12 text-center text-slate-500">Loading support tickets...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="tab-settings" class="tab-content hidden animate-enter">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-white tracking-tight">Settings</h2>
                    <p class="text-slate-400 text-sm mt-1">Configure app settings, loyalty program, and manage backups</p>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- App Settings -->
                    <div class="glass-panel rounded-2xl p-6">
                        <h3 class="text-xl font-bold text-white mb-6 flex items-center gap-2">
                            <span class="material-symbols-rounded text-blue-400">tune</span>
                            App Settings
                        </h3>
                        <form onsubmit="saveAppSettings(event)" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-2">Delivery Charge (₹)</label>
                                <input type="number" id="delivery-charge" step="0.01" value="50" required class="w-full px-4 py-2 bg-slate-900/50 border border-white/10 rounded-xl text-white">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-2">Tax Rate (%)</label>
                                <input type="number" id="tax-rate" step="0.01" value="18" required class="w-full px-4 py-2 bg-slate-900/50 border border-white/10 rounded-xl text-white">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-2">Minimum Order Value (₹)</label>
                                <input type="number" id="min-order-value" step="0.01" value="100" required class="w-full px-4 py-2 bg-slate-900/50 border border-white/10 rounded-xl text-white">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-2">Free Delivery Above (₹)</label>
                                <input type="number" id="free-delivery-above" step="0.01" value="500" required class="w-full px-4 py-2 bg-slate-900/50 border border-white/10 rounded-xl text-white">
                            </div>
                            <button type="submit" class="w-full px-4 py-2 bg-primary-600 hover:bg-primary-500 text-white rounded-xl font-semibold transition-colors">
                                Save Settings
                            </button>
                        </form>
                    </div>

                    <!-- Loyalty Program -->
                    <div class="glass-panel rounded-2xl p-6">
                        <h3 class="text-xl font-bold text-white mb-6 flex items-center gap-2">
                            <span class="material-symbols-rounded text-yellow-400">loyalty</span>
                            Loyalty Program
                        </h3>
                        <form onsubmit="saveLoyaltySettings(event)" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-2">Points per ₹100 Spent</label>
                                <input type="number" id="points-per-100" value="10" required class="w-full px-4 py-2 bg-slate-900/50 border border-white/10 rounded-xl text-white">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-2">Points Value (₹ per point)</label>
                                <input type="number" id="points-value" step="0.01" value="0.25" required class="w-full px-4 py-2 bg-slate-900/50 border border-white/10 rounded-xl text-white">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-2">Minimum Points to Redeem</label>
                                <input type="number" id="min-points-redeem" value="100" required class="w-full px-4 py-2 bg-slate-900/50 border border-white/10 rounded-xl text-white">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-2">Signup Bonus Points</label>
                                <input type="number" id="signup-bonus" value="50" required class="w-full px-4 py-2 bg-slate-900/50 border border-white/10 rounded-xl text-white">
                            </div>
                            <button type="submit" class="w-full px-4 py-2 bg-primary-600 hover:bg-primary-500 text-white rounded-xl font-semibold transition-colors">
                                Save Loyalty Settings
                            </button>
                        </form>
                    </div>

                    <!-- Featured Products -->
                    <div class="glass-panel rounded-2xl p-6">
                        <h3 class="text-xl font-bold text-white mb-6 flex items-center gap-2">
                            <span class="material-symbols-rounded text-purple-400">star</span>
                            Featured Products
                        </h3>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-slate-300 mb-2">Select Products to Feature</label>
                            <select id="featured-product-select" class="w-full px-4 py-2 bg-slate-900/50 border border-white/10 rounded-xl text-white mb-3">
                                <option value="">Loading products...</option>
                            </select>
                            <button onclick="addFeaturedProduct()" class="w-full px-4 py-2 bg-purple-600 hover:bg-purple-500 text-white rounded-xl font-semibold transition-colors">
                                Add to Featured
                            </button>
                        </div>
                        <div id="featured-products-list" class="space-y-2 mt-4">
                            <p class="text-slate-500 text-sm">No featured products yet</p>
                        </div>
                    </div>

                    <!-- Backup & Export -->
                    <div class="glass-panel rounded-2xl p-6">
                        <h3 class="text-xl font-bold text-white mb-6 flex items-center gap-2">
                            <span class="material-symbols-rounded text-green-400">backup</span>
                            Backup & Export
                        </h3>
                        <div class="space-y-3">
                            <button onclick="backupFullDatabase()" class="w-full px-4 py-3 bg-green-600 hover:bg-green-700 text-white rounded-xl font-semibold transition-colors flex items-center justify-center gap-2">
                                <span class="material-symbols-rounded">download</span>
                                Full Database Backup
                            </button>
                            <button onclick="exportAllProducts()" class="w-full px-4 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-semibold transition-colors flex items-center justify-center gap-2">
                                <span class="material-symbols-rounded">inventory</span>
                                Export All Products
                            </button>
                            <button onclick="exportAllOrders()" class="w-full px-4 py-3 bg-orange-600 hover:bg-orange-700 text-white rounded-xl font-semibold transition-colors flex items-center justify-center gap-2">
                                <span class="material-symbols-rounded">receipt_long</span>
                                Export All Orders
                            </button>
                            <button onclick="exportAllUsers()" class="w-full px-4 py-3 bg-purple-600 hover:bg-purple-700 text-white rounded-xl font-semibold transition-colors flex items-center justify-center gap-2">
                                <span class="material-symbols-rounded">people</span>
                                Export All Users
                            </button>
                        </div>
                        <div id="backup-status" class="mt-4 text-sm text-center text-slate-400"></div>
                    </div>
                </div>
            </div>

            <!-- Search Results Tab -->
            <div id="tab-search" class="tab-content hidden animate-enter">
                <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                    <div>
                        <h2 class="text-3xl font-bold text-white tracking-tight">Search Results</h2>
                        <p class="text-slate-400 text-sm" id="search-result-count">Enter search query to find items</p>
                    </div>
                </div>
                
                <div class="space-y-6">
                    <!-- Products Results -->
                    <div id="search-products" style="display:none;">
                        <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                            <span class="material-symbols-rounded text-emerald-400">inventory_2</span>
                            Products <span class="text-sm text-slate-500" id="search-products-count">(0)</span>
                        </h3>
                        <div class="glass-panel rounded-2xl overflow-hidden border border-white/5">
                            <div class="overflow-x-auto">
                                <table class="w-full text-left text-sm">
                                    <thead class="bg-slate-900/80 text-xs uppercase text-slate-400 font-medium tracking-wider">
                                        <tr>
                                            <th class="px-6 py-4">Name</th>
                                            <th class="px-6 py-4">Barcode</th>
                                            <th class="px-6 py-4">Category</th>
                                            <th class="px-6 py-4">Price</th>
                                            <th class="px-6 py-4">Stock</th>
                                        </tr>
                                    </thead>
                                    <tbody id="search-products-list" class="divide-y divide-white/5"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Orders Results -->
                    <div id="search-orders" style="display:none;">
                        <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                            <span class="material-symbols-rounded text-blue-400">shopping_bag</span>
                            Orders <span class="text-sm text-slate-500" id="search-orders-count">(0)</span>
                        </h3>
                        <div class="glass-panel rounded-2xl overflow-hidden border border-white/5">
                            <div class="overflow-x-auto">
                                <table class="w-full text-left text-sm">
                                    <thead class="bg-slate-900/80 text-xs uppercase text-slate-400 font-medium tracking-wider">
                                        <tr>
                                            <th class="px-6 py-4">Receipt ID</th>
                                            <th class="px-6 py-4">Exit Code</th>
                                            <th class="px-6 py-4">Date</th>
                                            <th class="px-6 py-4">Items</th>
                                            <th class="px-6 py-4">Total</th>
                                        </tr>
                                    </thead>
                                    <tbody id="search-orders-list" class="divide-y divide-white/5"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Users Results -->
                    <div id="search-users" style="display:none;">
                        <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                            <span class="material-symbols-rounded text-purple-400">people</span>
                            Users <span class="text-sm text-slate-500" id="search-users-count">(0)</span>
                        </h3>
                        <div class="glass-panel rounded-2xl overflow-hidden border border-white/5">
                            <div class="overflow-x-auto">
                                <table class="w-full text-left text-sm">
                                    <thead class="bg-slate-900/80 text-xs uppercase text-slate-400 font-medium tracking-wider">
                                        <tr>
                                            <th class="px-6 py-4">Email</th>
                                            <th class="px-6 py-4">Name</th>
                                            <th class="px-6 py-4">Role</th>
                                            <th class="px-6 py-4">Spent</th>
                                            <th class="px-6 py-4">Orders</th>
                                        </tr>
                                    </thead>
                                    <tbody id="search-users-list" class="divide-y divide-white/5"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Feedbacks Results -->
                    <div id="search-feedbacks" style="display:none;">
                        <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                            <span class="material-symbols-rounded text-yellow-400">feedback</span>
                            Feedbacks <span class="text-sm text-slate-500" id="search-feedbacks-count">(0)</span>
                        </h3>
                        <div class="glass-panel rounded-2xl overflow-hidden border border-white/5">
                            <div class="overflow-x-auto">
                                <table class="w-full text-left text-sm">
                                    <thead class="bg-slate-900/80 text-xs uppercase text-slate-400 font-medium tracking-wider">
                                        <tr>
                                            <th class="px-6 py-4">Email</th>
                                            <th class="px-6 py-4">Rating</th>
                                            <th class="px-6 py-4">Category</th>
                                            <th class="px-6 py-4">Message</th>
                                        </tr>
                                    </thead>
                                    <tbody id="search-feedbacks-list" class="divide-y divide-white/5"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Bug Reports Results -->
                    <div id="search-bugs" style="display:none;">
                        <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                            <span class="material-symbols-rounded text-red-400">bug_report</span>
                            Bug Reports <span class="text-sm text-slate-500" id="search-bugs-count">(0)</span>
                        </h3>
                        <div class="glass-panel rounded-2xl overflow-hidden border border-white/5">
                            <div class="overflow-x-auto">
                                <table class="w-full text-left text-sm">
                                    <thead class="bg-slate-900/80 text-xs uppercase text-slate-400 font-medium tracking-wider">
                                        <tr>
                                            <th class="px-6 py-4">Email</th>
                                            <th class="px-6 py-4">Title</th>
                                            <th class="px-6 py-4">Status</th>
                                            <th class="px-6 py-4">Description</th>
                                        </tr>
                                    </thead>
                                    <tbody id="search-bugs-list" class="divide-y divide-white/5"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- No Results Message -->
                    <div id="search-no-results" class="text-center py-12">
                        <span class="material-symbols-rounded text-6xl text-slate-600 mb-4 block">search_off</span>
                        <p class="text-slate-400 text-lg">No results found. Try a different search.</p>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- Modal -->
    <div id="modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 backdrop-blur-md bg-black/60 transition-opacity duration-300" onclick="if(event.target.id==='modal') closeModal()">
        <div class="glass-panel bg-slate-900 border border-white/10 rounded-2xl max-w-2xl w-full max-h-[85vh] overflow-y-auto shadow-2xl animate-enter" onclick="event.stopPropagation()">
            <div id="modal-content"></div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="fixed bottom-6 right-6 z-50 flex flex-col gap-3 pointer-events-none"></div>

    <script>
        // Mouse Tracking for Spotlight Effect
        function updateMouse(e) {
            const cards = document.getElementsByClassName('spotlight-card');
            for(const card of cards) {
                const rect = card.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                card.style.setProperty('--mouse-x', `${x}px`);
                card.style.setProperty('--mouse-y', `${y}px`);
            }
        }

        // Whitelist - Logic Preserved
        const ALLOWED_EMAILS = window.ALLOWED_EMAILS;
        const ALLOWED_EMAILS_LOWER = window.ALLOWED_EMAILS_LOWER;
        
        // Firebase Config
        const firebaseConfig = window.__FIREBASE_CONFIG;
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        
        // Make db globally accessible for emergency fix functions
        window.db = db;
        window.auth = auth;
        
        let products = [];
        let orders = [];
        let feedbacks = [];
        let bugReports = [];
        let users = [];
        
        // Auth Functions
        function signIn() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider).then(result => {
                // Safe check: ensure user and email exist and compare in lowercase
                const userEmail = result?.user?.email?.toLowerCase?.() || null;
                if (userEmail && ALLOWED_EMAILS_LOWER.includes(userEmail)) {
                    document.getElementById('login-screen').classList.add('hidden');
                    document.getElementById('app-container').classList.remove('hidden');
                    init();
                    showToast('Welcome back, Admin', 'success');
                } else {
                    auth.signOut();
                    showToast('Access Denied. Unauthorized account.', 'error');
                }
            }).catch(err => showToast('Sign-in failed: ' + err.message, 'error'));
        }
        
        function signOut() {
            auth.signOut().then(() => {
                location.reload();
            });
        }
        
        // Init
        function init() {
            loadProducts();
            loadOrders();
            loadUsers();
            loadNotificationHistory();
            loadCategories();
            loadSuppliers();
            loadActivityLogs();
            populateFeaturedProductSelect();
            // Note: Feedbacks, Bug Reports, Support Tickets, and Settings load on-demand when tabs are clicked
        }
        
        // Data Loading with error handling
        function loadProducts() {
            db.collection('products').orderBy('purchaseCount', 'desc').onSnapshot(
                snapshot => {
                    products = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    renderProducts();
                    updateDashboard();
                    updateAnalytics();
                },
                error => {
                    console.error('Error loading products:', error);
                    if (error.code === 'permission-denied') {
                        showToast('Permission denied. Admin access required.', 'error');
                        setTimeout(() => auth.signOut(), 2000);
                    }
                }
            );
        }
        
        function loadOrders() {
            db.collection('orders').orderBy('createdAt', 'desc').onSnapshot(
                snapshot => {
                    orders = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    renderOrders();
                    updateDashboard();
                },
                error => {
                    console.error('Error loading orders:', error);
                    if (error.code === 'permission-denied') {
                        showToast('Permission denied. Admin access required.', 'error');
                    }
                }
            );
        }
        
        function loadFeedbacks() {
            console.log('Loading feedbacks...');
            const tbody = document.getElementById('feedbacks-table');
            if (!tbody) {
                console.error('feedbacks-table element not found!');
                return;
            }
            tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-12 text-center text-slate-500"><div class="inline-block loader mr-2"></div> Fetching feedbacks...</td></tr>';
            
            db.collection('feedbacks').orderBy('timestamp', 'desc').get().then(
                snapshot => {
                    console.log('Feedbacks loaded:', snapshot.size);
                    feedbacks = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    renderFeedbacks();
                }
            ).catch(
                error => {
                    console.error('Error loading feedbacks:', error);
                    tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-12 text-center text-red-400">⚠️ Error loading feedbacks: ' + error.message + '</td></tr>';
                    if (error.code === 'permission-denied') {
                        showToast('Permission denied loading feedbacks', 'error');
                    } else {
                        showToast('Error loading feedbacks: ' + error.message, 'error');
                    }
                }
            );
        }
        
        function loadBugReports() {
            console.log('Loading bug reports...');
            const tbody = document.getElementById('bug-reports-table');
            if (!tbody) {
                console.error('bug-reports-table element not found!');
                return;
            }
            tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-12 text-center text-slate-500"><div class="inline-block loader mr-2"></div> Fetching bug reports...</td></tr>';
            
            db.collection('bug_reports').orderBy('timestamp', 'desc').get().then(
                snapshot => {
                    console.log('Bug reports loaded:', snapshot.size);
                    bugReports = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    renderBugReports();
                }
            ).catch(
                error => {
                    console.error('Error loading bug reports:', error);
                    tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-12 text-center text-red-400">⚠️ Error loading bug reports: ' + error.message + '</td></tr>';
                    if (error.code === 'permission-denied') {
                        showToast('Permission denied loading bug reports', 'error');
                    } else {
                        showToast('Error loading bug reports: ' + error.message, 'error');
                    }
                }
            );
        }

        function loadSettingsData() {
            console.log('Loading settings data...');
            
            // Check if settings form elements exist
            const deliveryCharge = document.getElementById('delivery-charge');
            const taxRate = document.getElementById('tax-rate');
            const minOrderValue = document.getElementById('min-order-value');
            const freeDeliveryAbove = document.getElementById('free-delivery-above');
            
            if (!deliveryCharge || !taxRate || !minOrderValue || !freeDeliveryAbove) {
                console.error('Settings form elements not found!');
                return;
            }
            
            // Load app settings
            db.collection('settings').doc('app_config').get().then(doc => {
                console.log('App settings loaded:', doc.exists);
                if (doc.exists) {
                    const data = doc.data();
                    deliveryCharge.value = (data.deliveryCharge || 0) / 100;
                    taxRate.value = data.taxRate || 0;
                    minOrderValue.value = (data.minOrderValue || 0) / 100;
                    freeDeliveryAbove.value = (data.freeDeliveryAbove || 0) / 100;
                } else {
                    console.log('No app settings found, using defaults');
                    showToast('No settings found. Using defaults.', 'info');
                }
            }).catch(err => {
                console.error('Error loading app settings:', err);
                showToast('Error loading settings: ' + err.message, 'error');
            });

            // Load loyalty settings
            loadLoyaltySettings();

            // Load featured products
            loadFeaturedProducts();

            // Populate product select
            populateFeaturedProductSelect();
        }

        function loadUsers() {
            console.log('Loading users with real-time updates...');
            db.collection('users').onSnapshot(
                snapshot => {
                    console.log('Users snapshot received, size:', snapshot.size);
                    users = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    console.log('Users loaded:', users.length);
                    console.log('Users data:', users);
                    renderUsers();
                    updateUserStats();
                },
                error => {
                    console.error('Error loading users:', error);
                    const tbody = document.getElementById('users-table');
                    if (error.code === 'permission-denied') {
                        showToast('Permission denied loading users. Make sure you\'re logged in as admin.', 'error');
                        tbody.innerHTML = '<tr><td colspan="9" class="px-6 py-12 text-center text-red-400">⚠️ Permission denied. Admin access required.</td></tr>';
                    } else {
                        showToast('Error loading users: ' + error.message, 'error');
                        tbody.innerHTML = '<tr><td colspan="9" class="px-6 py-12 text-center text-red-400">⚠️ Error: ' + error.message + '</td></tr>';
                    }
                }
            );
        }
        
        // Render Functions
        function renderProducts() {
            const tbody = document.getElementById('products-table');
            if (products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-12 text-center text-slate-500">No products found</td></tr>';
                return;
            }
            
            tbody.innerHTML = products.map(p => `
                <tr class="group hover:bg-white/5 transition-colors border-b border-white/5 last:border-0">
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-lg bg-slate-800 flex items-center justify-center text-xl shadow-inner border border-white/5">
                                ${p.imageEmoji || '📦'}
                            </div>
                            <div>
                                <div class="font-medium text-white group-hover:text-primary-400 transition-colors">${p.name}</div>
                                <div class="text-xs text-slate-500">${p.brand || 'Generic'}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 font-mono text-slate-400 text-xs">${p.barcode || 'N/A'}</td>
                    <td class="px-6 py-4">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-slate-800 text-slate-300 border border-white/10">
                            ${p.category || 'Uncategorized'}
                        </span>
                    </td>
                    <td class="px-6 py-4 font-semibold text-white">₹${((p.price || 0) / 100).toFixed(2)}</td>
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-2">
                            <div class="w-full max-w-[60px] h-1.5 bg-slate-800 rounded-full overflow-hidden">
                                <div class="h-full rounded-full ${p.stockQuantity < 10 ? 'bg-orange-500' : 'bg-emerald-500'}" style="width: ${Math.min(100, (p.stockQuantity/50)*100)}%"></div>
                            </div>
                            <span class="text-xs ${p.stockQuantity < 10 ? 'text-orange-400' : 'text-emerald-400'} font-medium">
                                ${p.stockQuantity || 0}
                            </span>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-right">
                        <div class="flex items-center justify-end gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="editProduct('${p.id}')" class="p-2 bg-blue-500/10 hover:bg-blue-500/20 text-blue-400 rounded-lg transition-colors hover:scale-110" title="Edit">
                                <span class="material-symbols-rounded text-lg">edit</span>
                            </button>
                            <button onclick="deleteProduct('${p.id}')" class="p-2 bg-red-500/10 hover:bg-red-500/20 text-red-400 rounded-lg transition-colors hover:scale-110" title="Delete">
                                <span class="material-symbols-rounded text-lg">delete</span>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }
        
        function renderOrders() {
            const tbody = document.getElementById('orders-table');
            if (orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-12 text-center text-slate-500">No orders recorded</td></tr>';
                return;
            }
            
            tbody.innerHTML = orders.slice(0, 50).map(o => {
                const date = o.createdAt ? new Date(o.createdAt.seconds * 1000).toLocaleString() : 'N/A';
                const total = (o.total || 0) / 100;
                const receiptId = o.receiptNo ? o.receiptNo.substring(0, 8).toUpperCase() : 'N/A';
                
                return `
                    <tr class="hover:bg-white/5 transition-colors border-b border-white/5 last:border-0">
                        <td class="px-6 py-4 font-mono text-xs">
                            <span class="text-primary-400">#</span><span class="text-slate-400">${receiptId}</span>
                        </td>
                        <td class="px-6 py-4 font-mono text-slate-400 text-xs">
                            <span class="text-primary-400">#</span>${o.orderNumber || o.id.substr(0, 8)}
                        </td>
                        <td class="px-6 py-4 font-mono text-slate-500 text-xs">${o.exitCode || 'N/A'}</td>
                        <td class="px-6 py-4 text-slate-300 text-xs">${date}</td>
                        <td class="px-6 py-4">
                             <div class="flex -space-x-2">
                                ${(o.items || []).slice(0,3).map(i => `
                                    <div class="w-6 h-6 rounded-full bg-slate-800 border border-slate-700 flex items-center justify-center text-[10px]" title="${i.name}">
                                        ${i.imageEmoji || '📦'}
                                    </div>
                                `).join('')}
                                ${(o.items || []).length > 3 ? `<div class="w-6 h-6 rounded-full bg-slate-700 border border-slate-600 flex items-center justify-center text-[8px] text-white">+${(o.items || []).length - 3}</div>` : ''}
                            </div>
                        </td>
                        <td class="px-6 py-4 font-semibold text-white">₹${total.toFixed(2)}</td>
                        <td class="px-6 py-4">
                            <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-md text-xs font-medium bg-emerald-500/10 text-emerald-400 border border-emerald-500/20">
                                <span class="w-1.5 h-1.5 rounded-full bg-emerald-500"></span>
                                ${o.paymentMethod || 'Cash'}
                            </span>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function renderFeedbacks() {
            console.log('Rendering feedbacks, count:', feedbacks.length);
            const tbody = document.getElementById('feedbacks-table');
            if (!tbody) {
                console.error('feedbacks-table element not found!');
                return;
            }
            if (feedbacks.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-12 text-center text-slate-500">No feedbacks yet. Feedbacks from users will appear here.</td></tr>';
                return;
            }
            tbody.innerHTML = feedbacks.slice(0, 100).map(f => {
                let date = f.timestamp ? new Date(f.timestamp.seconds * 1000).toLocaleString() : 'N/A';
                const stars = Array(f.rating || 0).fill('⭐').join('');
                return `
                    <tr class="hover:bg-white/5 transition-colors border-b border-white/5 last:border-0">
                        <td class="px-6 py-4 text-slate-300 text-xs"><span class="truncate max-w-xs block">${f.email || 'Anonymous'}</span></td>
                        <td class="px-6 py-4 text-sm text-yellow-400">${stars}</td>
                        <td class="px-6 py-4 text-slate-400 text-xs"><span class="truncate max-w-lg block">${f.message || ''}</span></td>
                        <td class="px-6 py-4"><span class="inline-flex items-center px-2.5 py-1 rounded-md text-xs font-medium bg-blue-500/10 text-blue-400 border border-blue-500/20">💬 ${f.category || 'General'}</span></td>
                        <td class="px-6 py-4 text-slate-400 text-xs flex items-center gap-2 justify-between">${date}
                            <button onclick="deleteFeedback('${f.id}')" class="p-2 bg-red-500/10 hover:bg-red-500/20 text-red-400 rounded-lg transition-colors hover:scale-110" title="Delete Feedback">
                                <span class="material-symbols-rounded text-lg">delete</span>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Delete Feedback (moved to global scope)
        async function deleteFeedback(id) {
            if (!confirm('Delete this feedback?')) return;
            try {
                await db.collection('feedbacks').doc(id).delete();
                showToast('Feedback deleted', 'success');
                loadFeedbacks();
            } catch (err) {
                showToast('Error deleting feedback: ' + err.message, 'error');
            }
        }
        
        function renderBugReports() {
            console.log('Rendering bug reports, count:', bugReports.length);
            const tbody = document.getElementById('bug-reports-table');
            if (!tbody) {
                console.error('bug-reports-table element not found!');
                return;
            }
            if (bugReports.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-12 text-center text-slate-500">No bug reports yet. Bug reports from users will appear here.</td></tr>';
                return;
            }
            tbody.innerHTML = bugReports.slice(0, 100).map(b => {
                let date = b.timestamp ? new Date(b.timestamp.seconds * 1000).toLocaleString() : 'N/A';
                const statusColor = b.status === 'open' ? 'bg-red-500/10 text-red-400 border-red-500/20' : 'bg-green-500/10 text-green-400 border-green-500/20';
                return `
                    <tr class="hover:bg-white/5 transition-colors border-b border-white/5 last:border-0">
                        <td class="px-6 py-4 text-slate-300 text-xs"><span class="truncate max-w-xs block">${b.email || 'Anonymous'}</span></td>
                        <td class="px-6 py-4 text-white text-xs font-semibold"><span class="truncate max-w-sm block">${b.title || 'Untitled'}</span></td>
                        <td class="px-6 py-4 text-slate-400 text-xs"><span class="truncate max-w-lg block">${b.description || ''}</span></td>
                        <td class="px-6 py-4"><span class="inline-flex items-center px-2.5 py-1 rounded-md text-xs font-medium ${statusColor} border capitalize">${b.status || 'open'}</span></td>
                        <td class="px-6 py-4 text-slate-400 text-xs flex items-center gap-2 justify-between">${date}
                            <button onclick="deleteBugReport('${b.id}')" class="p-2 bg-red-500/10 hover:bg-red-500/20 text-red-400 rounded-lg transition-colors hover:scale-110" title="Delete Bug Report">
                                <span class="material-symbols-rounded text-lg">delete</span>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Delete Bug Report (moved to global scope)
        async function deleteBugReport(id) {
            if (!confirm('Delete this bug report?')) return;
            try {
                await db.collection('bug_reports').doc(id).delete();
                showToast('Bug report deleted', 'success');
                loadBugReports();
            } catch (err) {
                showToast('Error deleting bug report: ' + err.message, 'error');
            }
        }
        
        // Updates
        function animateCounter(element, target, duration = 800) {
            let current = 0;
            const increment = target / (duration / 16);
            const timer = setInterval(() => {
                current += increment;
                if (current >= target) {
                    element.textContent = target;
                    clearInterval(timer);
                } else {
                    element.textContent = Math.floor(current);
                }
            }, 16);
        }

        function updateDashboard() {
            const statTotalProducts = document.getElementById('stat-total-products');
            const statLowStock = document.getElementById('stat-low-stock');
            const statTotalOrders = document.getElementById('stat-total-orders');
            const statTotalRevenue = document.getElementById('stat-total-revenue');
            const lowStockDiv = document.getElementById('low-stock-list');
            
            // Only update if dashboard elements exist (user is on dashboard tab)
            if (!statTotalProducts || !statLowStock || !statTotalOrders || !statTotalRevenue || !lowStockDiv) {
                console.log('Dashboard elements not found, skipping update');
                return;
            }
            
            animateCounter(statTotalProducts, products.length);
            animateCounter(statLowStock, products.filter(p => (p.stockQuantity || 0) < 10).length);
            animateCounter(statTotalOrders, orders.length);
            
            const totalRevenue = orders.reduce((sum, o) => sum + ((o.total || 0) / 100), 0);
            statTotalRevenue.textContent = '₹' + totalRevenue.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            
            const lowStockItems = products.filter(p => (p.stockQuantity || 0) < 10);
            
            if (lowStockItems.length === 0) {
                lowStockDiv.innerHTML = '<div class="text-center p-4 border border-dashed border-slate-700 rounded-xl text-slate-500 text-sm animate-fade">Stock levels are healthy</div>';
            } else {
                lowStockDiv.innerHTML = lowStockItems.map((p, i) => `
                    <div class="flex items-center justify-between p-3 bg-orange-500/5 border border-orange-500/10 rounded-xl hover:bg-orange-500/10 transition-colors animate-slide-up" style="animation-delay: ${i * 0.05}s;">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded bg-slate-800 flex items-center justify-center">${p.imageEmoji || '📦'}</div>
                            <div>
                                <div class="font-medium text-slate-200 text-sm">${p.name}</div>
                                <div class="text-xs text-orange-400 font-mono">Qty: ${p.stockQuantity}</div>
                            </div>
                        </div>
                        <button onclick="openRestockModal('${p.id}')" class="px-3 py-1 bg-slate-800 hover:bg-slate-700 text-xs text-white rounded border border-white/5 transition-colors hover:scale-105">Restock</button>
                    </div>
                `).join('');
            }
        }
        
        let topProductsChart = null;
        let categoryChart = null;
        let userActivityChart = null;
        let stockStatusChart = null;

        async function loadAnalyticsData() {
            try {
                showToast('Loading analytics data...', 'info');
                
                // Fetch data
                const ordersSnap = await db.collection('orders').orderBy('timestamp', 'desc').get();
                const usersSnap = await db.collection('users').get();
                const productsSnap = await db.collection('products').get();
                
                const orders = ordersSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const users = usersSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const productsData = productsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // User Activity Pie Chart (Active vs Inactive)
                const now = Date.now();
                const activeUsers = users.filter(u => {
                    const lastActive = (u.lastActive?.seconds || u.createdAt?.seconds || 0) * 1000;
                    return (now - lastActive) < (30 * 24 * 60 * 60 * 1000); // Active in last 30 days
                }).length;
                const inactiveUsers = users.length - activeUsers;
                
                if (userActivityChart) userActivityChart.destroy();
                const ctxUserActivity = document.getElementById('user-activity-chart');
                
                if (ctxUserActivity && users.length > 0) {
                    userActivityChart = new Chart(ctxUserActivity, {
                        type: 'doughnut',
                        data: {
                            labels: ['Active Users', 'Inactive Users'],
                            datasets: [{
                                data: [activeUsers, inactiveUsers],
                                backgroundColor: ['#3b82f6', '#64748b'],
                                borderColor: 'rgba(15, 23, 42, 0.8)',
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { 
                                    position: 'bottom', 
                                    labels: { color: '#cbd5e1', padding: 15, font: { size: 12 } } 
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(15, 23, 42, 0.9)',
                                    titleColor: '#cbd5e1',
                                    bodyColor: '#cbd5e1',
                                    borderColor: 'rgba(255, 255, 255, 0.1)',
                                    borderWidth: 1,
                                    padding: 12,
                                    callbacks: {
                                        label: function(context) {
                                            const value = context.parsed || 0;
                                            const percent = users.length > 0 ? ((value / users.length) * 100).toFixed(1) : 0;
                                            return context.label + ': ' + value + ' (' + percent + '%)';
                                        }
                                    }
                                }
                            }
                        }
                    });
                } else if (ctxUserActivity) {
                    ctxUserActivity.parentElement.innerHTML = '<p class="text-slate-500 text-center py-8">No user data</p>';
                }
                
                // Stock Status Pie Chart
                const stockStatus = {
                    'In Stock': productsData.filter(p => (p.stockQuantity || 0) > 10).length,
                    'Low Stock': productsData.filter(p => (p.stockQuantity || 0) > 0 && (p.stockQuantity || 0) <= 10).length,
                    'Out of Stock': productsData.filter(p => (p.stockQuantity || 0) === 0).length
                };
                
                if (stockStatusChart) stockStatusChart.destroy();
                const ctxStockStatus = document.getElementById('stock-status-chart');
                const ssEntries = Object.entries(stockStatus).filter(e => e[1] > 0);
                
                if (ctxStockStatus && ssEntries.length > 0) {
                    stockStatusChart = new Chart(ctxStockStatus, {
                        type: 'doughnut',
                        data: {
                            labels: ssEntries.map(e => e[0]),
                            datasets: [{
                                data: ssEntries.map(e => e[1]),
                                backgroundColor: ['#34d399', '#f59e0b', '#ef4444'],
                                borderColor: 'rgba(15, 23, 42, 0.8)',
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { 
                                    position: 'bottom', 
                                    labels: { color: '#cbd5e1', padding: 15, font: { size: 12 } } 
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(15, 23, 42, 0.9)',
                                    titleColor: '#cbd5e1',
                                    bodyColor: '#cbd5e1',
                                    borderColor: 'rgba(255, 255, 255, 0.1)',
                                    borderWidth: 1,
                                    padding: 12,
                                    callbacks: {
                                        label: function(context) {
                                            const value = context.parsed || 0;
                                            const total = productsData.length;
                                            const percent = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                            return context.label + ': ' + value + ' products (' + percent + '%)';
                                        }
                                    }
                                }
                            }
                        }
                    });
                } else if (ctxStockStatus) {
                    ctxStockStatus.parentElement.innerHTML = '<p class="text-slate-500 text-center py-8">No product data</p>';
                }
                
                showToast('Analytics data loaded successfully', 'success');
            } catch (err) {
                console.error('Error loading analytics:', err);
                showToast('Error loading analytics: ' + err.message, 'error');
            }
        }

        function updateAnalytics() {
            const topProducts = [...products].sort((a,b) => (b.purchaseCount || 0) - (a.purchaseCount || 0)).slice(0, 5);
            
            if (topProductsChart) topProductsChart.destroy();
            if (categoryChart) categoryChart.destroy();
            
            const ctxProducts = document.getElementById('top-products-chart');
            if (topProducts.length === 0) {
                ctxProducts.parentElement.innerHTML = '<p class="text-slate-500 text-center text-sm">No sales data yet</p>';
            } else {
                const productLabels = topProducts.map(p => p.name);
                const productData = topProducts.map(p => p.purchaseCount || 0);
                const productColors = ['#34d399', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6'];
                
                topProductsChart = new Chart(ctxProducts, {
                    type: 'doughnut',
                    data: {
                        labels: productLabels,
                        datasets: [{
                            data: productData,
                            backgroundColor: productColors,
                            borderColor: 'rgba(15, 23, 42, 0.8)',
                            borderWidth: 2,
                            hoverOffset: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: { color: '#cbd5e1', font: { size: 12, weight: '500' }, padding: 15, usePointStyle: true }
                            }
                        }
                    }
                });
            }
            
            const categories = {};
            products.forEach(p => { categories[p.category] = (categories[p.category] || 0) + 1; });
            const ctxCategory = document.getElementById('category-chart');
            const catEntries = Object.entries(categories).sort((a, b) => b[1] - a[1]);
            
            if (catEntries.length === 0) {
                ctxCategory.parentElement.innerHTML = '<p class="text-slate-500 text-center text-sm">No categories found</p>';
            } else {
                const catLabels = catEntries.map(e => e[0]);
                const catData = catEntries.map(e => e[1]);
                const catColors = ['#3b82f6', '#34d399', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#14b8a6', '#f97316'];
                
                categoryChart = new Chart(ctxCategory, {
                    type: 'doughnut',
                    data: {
                        labels: catLabels.map(c => c.charAt(0).toUpperCase() + c.slice(1)),
                        datasets: [{
                            data: catData,
                            backgroundColor: catColors.slice(0, catLabels.length),
                            borderColor: 'rgba(15, 23, 42, 0.8)',
                            borderWidth: 2,
                            hoverOffset: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: { color: '#cbd5e1', font: { size: 12, weight: '500' }, padding: 15, usePointStyle: true }
                            }
                        }
                    }
                });
            }
        }
        
        function filterProducts() {
            const search = document.getElementById('search-products').value.toLowerCase();
            const filtered = products.filter(p => 
                (p.name || '').toLowerCase().includes(search) ||
                (p.barcode || '').toLowerCase().includes(search) ||
                (p.category || '').toLowerCase().includes(search)
            );
            
            const tbody = document.getElementById('products-table');
            if(filtered.length === 0) {
                 tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-12 text-center text-slate-500">No matches found</td></tr>';
            } else {
                const originalProducts = products;
                products = filtered;
                renderProducts();
                products = originalProducts;
            }
        }
        
        function renderUsers() {
            const tbody = document.getElementById('users-table');
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="px-6 py-12 text-center text-slate-500">No users found</td></tr>';
                return;
            }
            
            tbody.innerHTML = users.map(u => {
                const userOrders = orders.filter(o => o.userId === u.id || o.email === u.email);
                const totalSpent = userOrders.reduce((sum, o) => sum + ((o.total || 0) / 100), 0);
                const lastActive = u.lastLoginTime ? new Date(u.lastLoginTime.seconds * 1000).toLocaleDateString() : 'Never';
                const isActive = !u.isSuspended;
                const statusColor = isActive ? 'bg-emerald-500/10 text-emerald-400 border-emerald-500/20' : 'bg-red-500/10 text-red-400 border-red-500/20';
                const statusText = isActive ? 'Active' : 'Suspended';
                const suspendBtnColor = isActive ? 'bg-red-500/20 hover:bg-red-500/30 text-red-300' : 'bg-emerald-500/20 hover:bg-emerald-500/30 text-emerald-300';
                const suspendBtnText = isActive ? '🚫 Suspend' : '✅ Activate';
                const role = u.role || 'customer';
                const phone = u.phone || 'N/A';
                
                // Avatar: Show Google profile pic if available, otherwise emoji
                const avatarEmoji = u.avatarEmoji || '👤';
                let avatarHtml = '';
                if (u.photoURL) {
                    avatarHtml = `<img src="${u.photoURL}" alt="${u.name}" class="w-10 h-10 rounded-full border-2 border-white/10" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" /><div style="display:none;" class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-xl">${avatarEmoji}</div>`;
                } else {
                    avatarHtml = `<div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-xl">${avatarEmoji}</div>`;
                }
                
                return `
                    <tr class="group hover:bg-white/5 transition-colors border-b border-white/5 last:border-0">
                        <td class="px-6 py-4">${avatarHtml}</td>
                        <td class="px-6 py-4 text-slate-300 text-xs">${u.email || 'N/A'}</td>
                        <td class="px-6 py-4 text-white font-medium">${u.name || 'Unknown'}</td>
                        <td class="px-6 py-4 text-slate-400 text-xs">${phone}</td>
                        <td class="px-6 py-4"><span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-slate-800 text-slate-300 border border-white/10 capitalize">${role}</span></td>
                        <td class="px-6 py-4 text-white font-semibold">₹${totalSpent.toFixed(2)}</td>
                        <td class="px-6 py-4 text-slate-300">${userOrders.length}</td>
                        <td class="px-6 py-4 text-slate-400 text-xs">${lastActive}</td>
                        <td class="px-6 py-4"><span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium border ${statusColor}">${statusText}</span></td>
                        <td class="px-6 py-4 text-right">
                            <div class="flex items-center justify-end gap-2">
                                <button onclick="toggleUserStatus('${u.id}', ${isActive})" class="px-3 py-1.5 rounded-lg ${suspendBtnColor} border border-white/10 text-xs font-semibold transition-all hover:scale-105" title="${isActive ? 'Suspend this user' : 'Activate this user'}">
                                    ${suspendBtnText}
                                </button>
                                <button onclick="viewUserDetails('${u.id}')" class="p-2 rounded-lg bg-blue-500/10 hover:bg-blue-500/20 text-blue-400 transition-colors hover:scale-110 border border-white/10" title="View Details">
                                    <span class="material-symbols-rounded text-lg">info</span>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function updateUserStats() {
            const totalUsersEl = document.getElementById('stat-total-users');
            const activeUsersEl = document.getElementById('stat-active-users');
            const suspendedUsersEl = document.getElementById('stat-suspended-users');
            
            if (!totalUsersEl || !activeUsersEl || !suspendedUsersEl) {
                console.log('User stats elements not found, skipping update');
                return;
            }
            
            totalUsersEl.textContent = users.length;
            const activeUsers = users.filter(u => !u.isSuspended).length;
            const suspendedUsers = users.filter(u => u.isSuspended).length;
            activeUsersEl.textContent = activeUsers;
            suspendedUsersEl.textContent = suspendedUsers;
        }

        function filterUsers() {
            const search = document.getElementById('search-users').value.toLowerCase();
            const filtered = users.filter(u => 
                (u.email || '').toLowerCase().includes(search) ||
                (u.name || '').toLowerCase().includes(search)
            );
            
            const tbody = document.getElementById('users-table');
            if(filtered.length === 0) {
                 tbody.innerHTML = '<tr><td colspan="10" class="px-6 py-12 text-center text-slate-500">No matches found</td></tr>';
            } else {
                const originalUsers = users;
                users = filtered;
                renderUsers();
                users = originalUsers;
            }
        }

        function toggleUserStatus(userId, isCurrentlyActive) {
            const action = isCurrentlyActive ? 'suspend' : 'activate';
            const newStatus = isCurrentlyActive; // If currently active (true), set isSuspended to true
            
            if (!confirm(`Are you sure you want to ${action} this user?`)) return;
            
            console.log(`Toggling user ${userId}: currently active = ${isCurrentlyActive}, setting isSuspended = ${newStatus}`);
            
            db.collection('users').doc(userId).update({
                isSuspended: newStatus,
                lastStatusChange: firebase.firestore.FieldValue.serverTimestamp(),
                statusChangedBy: auth.currentUser.email
            }).then(() => {
                showToast(`User ${action}d successfully! 🎉`, 'success');
                console.log(`User ${userId} ${action}d successfully`);
            }).catch(err => {
                console.error('Error toggling user status:', err);
                showToast('Error: ' + err.message, 'error');
            });
        }

        function viewUserDetails(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;
            
            const userOrders = orders.filter(o => o.userId === userId || o.email === user.email);
            const totalSpent = userOrders.reduce((sum, o) => sum + ((o.total || 0) / 100), 0);
            
            const modalContent = document.getElementById('modal-content');
            modalContent.innerHTML = `
                <div class="p-8">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold text-white">User Details</h3>
                        <button onclick="closeModal()" class="text-slate-500 hover:text-white transition-colors"><span class="material-symbols-rounded">close</span></button>
                    </div>
                    
                    <div class="space-y-6">
                        <div>
                            <h4 class="text-slate-400 text-sm font-medium mb-3">Personal Information</h4>
                            <div class="glass-panel p-4 rounded-xl space-y-2">
                                <div><span class="text-slate-500">Email:</span> <span class="text-white">${user.email}</span></div>
                                <div><span class="text-slate-500">Name:</span> <span class="text-white">${user.name || 'N/A'}</span></div>
                                <div><span class="text-slate-500">Role:</span> <span class="text-white capitalize">${user.role || 'customer'}</span></div>
                                <div><span class="text-slate-500">Status:</span> <span class="${user.isSuspended ? 'text-red-400' : 'text-emerald-400'}">${user.isSuspended ? 'Suspended' : 'Active'}</span></div>
                            </div>
                        </div>
                        
                        <div>
                            <h4 class="text-slate-400 text-sm font-medium mb-3">Spending Analytics</h4>
                            <div class="glass-panel p-4 rounded-xl space-y-2">
                                <div><span class="text-slate-500">Total Spent:</span> <span class="text-white font-semibold">₹${totalSpent.toFixed(2)}</span></div>
                                <div><span class="text-slate-500">Total Orders:</span> <span class="text-white">${userOrders.length}</span></div>
                                <div><span class="text-slate-500">Avg Order Value:</span> <span class="text-white">₹${(userOrders.length > 0 ? totalSpent / userOrders.length : 0).toFixed(2)}</span></div>
                            </div>
                        </div>
                        
                        <div class="pt-4 flex gap-3">
                            <button onclick="editUserInfo('${user.id}')" class="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg font-medium transition-colors">
                                Edit Info
                            </button>
                            <button onclick="toggleUserStatus('${user.id}', ${!user.isSuspended})" class="flex-1 px-4 py-2 ${user.isSuspended ? 'bg-emerald-600 hover:bg-emerald-500' : 'bg-red-600 hover:bg-red-500'} text-white rounded-lg font-medium transition-colors">
                                ${user.isSuspended ? 'Activate' : 'Suspend'}
                            </button>
                            <button onclick="closeModal()" class="flex-1 px-4 py-2 bg-slate-800 hover:bg-slate-700 text-white rounded-lg font-medium transition-colors">
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modal').classList.remove('hidden');
        }

        function editUserInfo(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;
            
            const modalContent = document.getElementById('modal-content');
            modalContent.innerHTML = `
                <div class="p-8">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold text-white">Edit User Information</h3>
                        <button onclick="closeModal()" class="text-slate-500 hover:text-white transition-colors"><span class="material-symbols-rounded">close</span></button>
                    </div>
                    
                    <form onsubmit="saveUserInfo(event, '${user.id}')" class="space-y-5">
                        <div>
                            <label class="block text-xs font-medium text-slate-400 mb-1.5 uppercase tracking-wide">Email Address</label>
                            <input type="email" id="edit-user-email" name="email" value="${user.email}" required class="w-full bg-slate-950/50 border border-slate-700 rounded-lg px-4 py-2.5 text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all" placeholder="user@example.com">
                        </div>
                        
                        <div>
                            <label class="block text-xs font-medium text-slate-400 mb-1.5 uppercase tracking-wide">Full Name</label>
                            <input type="text" id="edit-user-name" name="name" value="${user.name || ''}" required class="w-full bg-slate-950/50 border border-slate-700 rounded-lg px-4 py-2.5 text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all" placeholder="John Doe">
                        </div>
                        
                        <div>
                            <label class="block text-xs font-medium text-slate-400 mb-1.5 uppercase tracking-wide">Phone Number</label>
                            <input type="tel" id="edit-user-phone" name="phone" value="${user.phone || ''}" class="w-full bg-slate-950/50 border border-slate-700 rounded-lg px-4 py-2.5 text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all" placeholder="+91-XXXXXXXXXX">
                        </div>
                        
                        <div>
                            <label class="block text-xs font-medium text-slate-400 mb-1.5 uppercase tracking-wide">Address</label>
                            <textarea id="edit-user-address" name="address" rows="3" class="w-full bg-slate-950/50 border border-slate-700 rounded-lg px-4 py-2.5 text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all" placeholder="Street Address, City, State, Postal Code">${user.address || ''}</textarea>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-medium text-slate-400 mb-1.5 uppercase tracking-wide">City</label>
                                <input type="text" id="edit-user-city" name="city" value="${user.city || ''}" class="w-full bg-slate-950/50 border border-slate-700 rounded-lg px-4 py-2.5 text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all" placeholder="City">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-slate-400 mb-1.5 uppercase tracking-wide">State</label>
                                <input type="text" id="edit-user-state" name="state" value="${user.state || ''}" class="w-full bg-slate-950/50 border border-slate-700 rounded-lg px-4 py-2.5 text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all" placeholder="State">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-medium text-slate-400 mb-1.5 uppercase tracking-wide">Postal Code</label>
                                <input type="text" id="edit-user-postal" name="postalCode" value="${user.postalCode || ''}" class="w-full bg-slate-950/50 border border-slate-700 rounded-lg px-4 py-2.5 text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all" placeholder="123456">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-slate-400 mb-1.5 uppercase tracking-wide">Country</label>
                                <input type="text" id="edit-user-country" name="country" value="${user.country || 'India'}" class="w-full bg-slate-950/50 border border-slate-700 rounded-lg px-4 py-2.5 text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all" placeholder="Country">
                            </div>
                        </div>
                        
                        <div class="pt-4 flex gap-3">
                            <button type="button" onclick="closeModal()" class="flex-1 px-4 py-3 bg-slate-800 hover:bg-slate-700 text-white rounded-xl font-medium transition-colors">Cancel</button>
                            <button type="submit" class="flex-1 px-4 py-3 bg-gradient-to-r from-primary-600 to-emerald-600 hover:from-primary-500 hover:to-emerald-500 text-white rounded-xl font-bold shadow-lg shadow-primary-500/20 transition-all transform active:scale-95">Save Changes</button>
                        </div>
                    </form>
                </div>
            `;
            document.getElementById('modal').classList.remove('hidden');
        }

        async function saveUserInfo(event, userId) {
            event.preventDefault();
            
            const updates = {
                email: document.getElementById('edit-user-email').value.trim(),
                name: document.getElementById('edit-user-name').value.trim(),
                phone: document.getElementById('edit-user-phone').value.trim(),
                address: document.getElementById('edit-user-address').value.trim(),
                city: document.getElementById('edit-user-city').value.trim(),
                state: document.getElementById('edit-user-state').value.trim(),
                postalCode: document.getElementById('edit-user-postal').value.trim(),
                country: document.getElementById('edit-user-country').value.trim(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            try {
                await db.collection('users').doc(userId).update(updates);
                showToast('User information updated successfully', 'success');
                closeModal();
                loadUsers();
            } catch (err) {
                showToast('Error updating user: ' + err.message, 'error');
            }
        }
        
        // Modals
        function openAddProductModal() {
            const modalContent = document.getElementById('modal-content');
            modalContent.innerHTML = `
                <div class="p-8">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold text-white">Add Product</h3>
                        <button onclick="closeModal()" class="text-slate-500 hover:text-white transition-colors"><span class="material-symbols-rounded">close</span></button>
                    </div>
                    <form onsubmit="addProduct(event)" class="space-y-5">
                        <div class="grid grid-cols-2 gap-5">
                            <div>
                                <label class="block text-xs font-medium text-slate-400 mb-1.5 uppercase tracking-wide">Barcode</label>
                                <input type="text" name="barcode" required class="w-full bg-slate-950/50 border border-slate-700 rounded-lg px-4 py-2.5 text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all placeholder-slate-600" placeholder="Scan or enter...">
                            </div>
                             <div>
                                <label class="block text-xs font-medium text-slate-400 mb-1.5 uppercase tracking-wide">Brand</label>
                                <input type="text" name="brand" required class="w-full bg-slate-950/50 border border-slate-700 rounded-lg px-4 py-2.5 text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all" placeholder="e.g. Nestle">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-xs font-medium text-slate-400 mb-1.5 uppercase tracking-wide">Product Name</label>
                            <input type="text" name="name" required class="w-full bg-slate-950/50 border border-slate-700 rounded-lg px-4 py-2.5 text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all" placeholder="e.g. Maggi Noodles">
                        </div>

                        <div class="grid grid-cols-2 gap-5">
                             <div>
                                <label class="block text-xs font-medium text-slate-400 mb-1.5 uppercase tracking-wide">Category</label>
                                <input type="text" name="category" required class="w-full bg-slate-950/50 border border-slate-700 rounded-lg px-4 py-2.5 text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all" placeholder="e.g. Snacks">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-slate-400 mb-1.5 uppercase tracking-wide">Emoji Icon</label>
                                <input type="text" name="emoji" placeholder="📦" class="w-full bg-slate-950/50 border border-slate-700 rounded-lg px-4 py-2.5 text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all">
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-5">
                            <div>
                                <label class="block text-xs font-medium text-slate-400 mb-1.5 uppercase tracking-wide">Price (₹)</label>
                                <div class="relative">
                                    <span class="absolute left-4 top-2.5 text-slate-500">₹</span>
                                    <input type="number" name="price" step="0.01" required class="w-full bg-slate-950/50 border border-slate-700 rounded-lg pl-8 pr-4 py-2.5 text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all">
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-slate-400 mb-1.5 uppercase tracking-wide">Initial Stock</label>
                                <input type="number" name="stock" required class="w-full bg-slate-950/50 border border-slate-700 rounded-lg px-4 py-2.5 text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all">
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs font-medium text-slate-400 mb-2 uppercase tracking-wide">Product Tags</label>
                            <div class="grid grid-cols-3 gap-2 mb-3">
                                <label class="flex items-center gap-2 p-2 bg-slate-950/50 border border-slate-700 rounded-lg cursor-pointer hover:border-primary-500 transition-colors">
                                    <input type="checkbox" name="tag_vegan" class="w-4 h-4 text-primary-600 bg-slate-800 border-slate-600 rounded focus:ring-primary-500">
                                    <span class="text-sm text-slate-300">🌱 Vegan</span>
                                </label>
                                <label class="flex items-center gap-2 p-2 bg-slate-950/50 border border-slate-700 rounded-lg cursor-pointer hover:border-primary-500 transition-colors">
                                    <input type="checkbox" name="tag_glutenFree" class="w-4 h-4 text-primary-600 bg-slate-800 border-slate-600 rounded focus:ring-primary-500">
                                    <span class="text-sm text-slate-300">🌾 Gluten Free</span>
                                </label>
                                <label class="flex items-center gap-2 p-2 bg-slate-950/50 border border-slate-700 rounded-lg cursor-pointer hover:border-primary-500 transition-colors">
                                    <input type="checkbox" name="tag_organic" class="w-4 h-4 text-primary-600 bg-slate-800 border-slate-600 rounded focus:ring-primary-500">
                                    <span class="text-sm text-slate-300">🌿 Organic</span>
                                </label>
                                <label class="flex items-center gap-2 p-2 bg-slate-950/50 border border-slate-700 rounded-lg cursor-pointer hover:border-primary-500 transition-colors">
                                    <input type="checkbox" name="tag_keto" class="w-4 h-4 text-primary-600 bg-slate-800 border-slate-600 rounded focus:ring-primary-500">
                                    <span class="text-sm text-slate-300">⚡ Keto</span>
                                </label>
                                <label class="flex items-center gap-2 p-2 bg-slate-950/50 border border-slate-700 rounded-lg cursor-pointer hover:border-primary-500 transition-colors">
                                    <input type="checkbox" name="tag_lowSodium" class="w-4 h-4 text-primary-600 bg-slate-800 border-slate-600 rounded focus:ring-primary-500">
                                    <span class="text-sm text-slate-300">🧂 Low Sodium</span>
                                </label>
                                <label class="flex items-center gap-2 p-2 bg-slate-950/50 border border-slate-700 rounded-lg cursor-pointer hover:border-primary-500 transition-colors">
                                    <input type="checkbox" name="tag_bestSeller" class="w-4 h-4 text-primary-600 bg-slate-800 border-slate-600 rounded focus:ring-primary-500">
                                    <span class="text-sm text-slate-300">⭐ Best Seller</span>
                                </label>
                                <label class="flex items-center gap-2 p-2 bg-slate-950/50 border border-slate-700 rounded-lg cursor-pointer hover:border-primary-500 transition-colors">
                                    <input type="checkbox" name="tag_new" class="w-4 h-4 text-primary-600 bg-slate-800 border-slate-600 rounded focus:ring-primary-500">
                                    <span class="text-sm text-slate-300">🆕 New</span>
                                </label>
                                <label class="flex items-center gap-2 p-2 bg-slate-950/50 border border-slate-700 rounded-lg cursor-pointer hover:border-primary-500 transition-colors">
                                    <input type="checkbox" name="tag_sale" class="w-4 h-4 text-primary-600 bg-slate-800 border-slate-600 rounded focus:ring-primary-500">
                                    <span class="text-sm text-slate-300">🏷️ Sale</span>
                                </label>
                                <label class="flex items-center gap-2 p-2 bg-slate-950/50 border border-slate-700 rounded-lg cursor-pointer hover:border-primary-500 transition-colors">
                                    <input type="checkbox" name="tag_premium" class="w-4 h-4 text-primary-600 bg-slate-800 border-slate-600 rounded focus:ring-primary-500">
                                    <span class="text-sm text-slate-300">💎 Premium</span>
                                </label>
                                <label class="flex items-center gap-2 p-2 bg-slate-950/50 border border-slate-700 rounded-lg cursor-pointer hover:border-primary-500 transition-colors">
                                    <input type="checkbox" name="tag_exclusive" class="w-4 h-4 text-primary-600 bg-slate-800 border-slate-600 rounded focus:ring-primary-500">
                                    <span class="text-sm text-slate-300">💫 Exclusive</span>
                                </label>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-slate-400 mb-1.5">Custom Tags (comma-separated)</label>
                                <input type="text" name="customTags" placeholder="e.g. Handmade, Local, Eco-Friendly" class="w-full bg-slate-950/50 border border-slate-700 rounded-lg px-4 py-2.5 text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all placeholder-slate-600">
                                <p class="text-xs text-slate-500 mt-1">Add custom tags separated by commas</p>
                            </div>
                        </div>

                        <div class="pt-4 flex gap-3">
                            <button type="button" onclick="closeModal()" class="flex-1 px-4 py-3 bg-slate-800 hover:bg-slate-700 text-white rounded-xl font-medium transition-colors">Cancel</button>
                            <button type="submit" class="flex-1 px-4 py-3 bg-gradient-to-r from-primary-600 to-emerald-600 hover:from-primary-500 hover:to-emerald-500 text-white rounded-xl font-bold shadow-lg shadow-primary-500/20 transition-all transform active:scale-95">Create Product</button>
                        </div>
                    </form>
                </div>
            `;
            document.getElementById('modal').classList.remove('hidden');
        }

        function editProduct(id) {
            const product = products.find(p => p.id === id);
            if (!product) return;
            
            const modalContent = document.getElementById('modal-content');
            modalContent.innerHTML = `
                <div class="p-8">
                     <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold text-white">Edit Product</h3>
                        <button onclick="closeModal()" class="text-slate-500 hover:text-white transition-colors"><span class="material-symbols-rounded">close</span></button>
                    </div>
                    <form onsubmit="updateProduct(event, '${id}')" class="space-y-5">
                        <div class="grid grid-cols-2 gap-5">
                            <div>
                                <label class="block text-xs font-medium text-slate-400 mb-1.5 uppercase tracking-wide">Barcode</label>
                                <input type="text" name="barcode" value="${product.barcode || ''}" required class="w-full bg-slate-950/50 border border-slate-700 rounded-lg px-4 py-2.5 text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all">
                            </div>
                             <div>
                                <label class="block text-xs font-medium text-slate-400 mb-1.5 uppercase tracking-wide">Brand</label>
                                <input type="text" name="brand" value="${product.brand || ''}" required class="w-full bg-slate-950/50 border border-slate-700 rounded-lg px-4 py-2.5 text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-xs font-medium text-slate-400 mb-1.5 uppercase tracking-wide">Name</label>
                            <input type="text" name="name" value="${product.name || ''}" required class="w-full bg-slate-950/50 border border-slate-700 rounded-lg px-4 py-2.5 text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all">
                        </div>

                         <div class="grid grid-cols-2 gap-5">
                             <div>
                                <label class="block text-xs font-medium text-slate-400 mb-1.5 uppercase tracking-wide">Category</label>
                                <input type="text" name="category" value="${product.category || ''}" required class="w-full bg-slate-950/50 border border-slate-700 rounded-lg px-4 py-2.5 text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-slate-400 mb-1.5 uppercase tracking-wide">Emoji</label>
                                <input type="text" name="emoji" value="${product.imageEmoji || '📦'}" class="w-full bg-slate-950/50 border border-slate-700 rounded-lg px-4 py-2.5 text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all">
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-5">
                             <div>
                                <label class="block text-xs font-medium text-slate-400 mb-1.5 uppercase tracking-wide">Price (₹)</label>
                                <input type="number" name="price" step="0.01" value="${((product.price || 0) / 100).toFixed(2)}" required class="w-full bg-slate-950/50 border border-slate-700 rounded-lg px-4 py-2.5 text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all">
                            </div>
                             <div>
                                <label class="block text-xs font-medium text-slate-400 mb-1.5 uppercase tracking-wide">Stock</label>
                                <input type="number" name="stock" value="${product.stockQuantity || 0}" required class="w-full bg-slate-950/50 border border-slate-700 rounded-lg px-4 py-2.5 text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all">
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs font-medium text-slate-400 mb-2 uppercase tracking-wide">Product Tags</label>
                            <div class="grid grid-cols-3 gap-2 mb-3">
                                <label class="flex items-center gap-2 p-2 bg-slate-950/50 border border-slate-700 rounded-lg cursor-pointer hover:border-primary-500 transition-colors">
                                    <input type="checkbox" name="tag_vegan" ${(product.tags || product.dietaryBadges || []).includes('vegan') ? 'checked' : ''} class="w-4 h-4 text-primary-600 bg-slate-800 border-slate-600 rounded focus:ring-primary-500">
                                    <span class="text-sm text-slate-300">🌱 Vegan</span>
                                </label>
                                <label class="flex items-center gap-2 p-2 bg-slate-950/50 border border-slate-700 rounded-lg cursor-pointer hover:border-primary-500 transition-colors">
                                    <input type="checkbox" name="tag_glutenFree" ${(product.tags || product.dietaryBadges || []).includes('glutenFree') ? 'checked' : ''} class="w-4 h-4 text-primary-600 bg-slate-800 border-slate-600 rounded focus:ring-primary-500">
                                    <span class="text-sm text-slate-300">🌾 Gluten Free</span>
                                </label>
                                <label class="flex items-center gap-2 p-2 bg-slate-950/50 border border-slate-700 rounded-lg cursor-pointer hover:border-primary-500 transition-colors">
                                    <input type="checkbox" name="tag_organic" ${(product.tags || product.dietaryBadges || []).includes('organic') ? 'checked' : ''} class="w-4 h-4 text-primary-600 bg-slate-800 border-slate-600 rounded focus:ring-primary-500">
                                    <span class="text-sm text-slate-300">🌿 Organic</span>
                                </label>
                                <label class="flex items-center gap-2 p-2 bg-slate-950/50 border border-slate-700 rounded-lg cursor-pointer hover:border-primary-500 transition-colors">
                                    <input type="checkbox" name="tag_keto" ${(product.tags || product.dietaryBadges || []).includes('keto') ? 'checked' : ''} class="w-4 h-4 text-primary-600 bg-slate-800 border-slate-600 rounded focus:ring-primary-500">
                                    <span class="text-sm text-slate-300">⚡ Keto</span>
                                </label>
                                <label class="flex items-center gap-2 p-2 bg-slate-950/50 border border-slate-700 rounded-lg cursor-pointer hover:border-primary-500 transition-colors">
                                    <input type="checkbox" name="tag_lowSodium" ${(product.tags || product.dietaryBadges || []).includes('lowSodium') ? 'checked' : ''} class="w-4 h-4 text-primary-600 bg-slate-800 border-slate-600 rounded focus:ring-primary-500">
                                    <span class="text-sm text-slate-300">🧂 Low Sodium</span>
                                </label>
                                <label class="flex items-center gap-2 p-2 bg-slate-950/50 border border-slate-700 rounded-lg cursor-pointer hover:border-primary-500 transition-colors">
                                    <input type="checkbox" name="tag_bestSeller" ${(product.tags || product.dietaryBadges || []).includes('bestSeller') ? 'checked' : ''} class="w-4 h-4 text-primary-600 bg-slate-800 border-slate-600 rounded focus:ring-primary-500">
                                    <span class="text-sm text-slate-300">⭐ Best Seller</span>
                                </label>
                                <label class="flex items-center gap-2 p-2 bg-slate-950/50 border border-slate-700 rounded-lg cursor-pointer hover:border-primary-500 transition-colors">
                                    <input type="checkbox" name="tag_new" ${(product.tags || product.dietaryBadges || []).includes('new') ? 'checked' : ''} class="w-4 h-4 text-primary-600 bg-slate-800 border-slate-600 rounded focus:ring-primary-500">
                                    <span class="text-sm text-slate-300">🆕 New</span>
                                </label>
                                <label class="flex items-center gap-2 p-2 bg-slate-950/50 border border-slate-700 rounded-lg cursor-pointer hover:border-primary-500 transition-colors">
                                    <input type="checkbox" name="tag_sale" ${(product.tags || product.dietaryBadges || []).includes('sale') ? 'checked' : ''} class="w-4 h-4 text-primary-600 bg-slate-800 border-slate-600 rounded focus:ring-primary-500">
                                    <span class="text-sm text-slate-300">🏷️ Sale</span>
                                </label>
                                <label class="flex items-center gap-2 p-2 bg-slate-950/50 border border-slate-700 rounded-lg cursor-pointer hover:border-primary-500 transition-colors">
                                    <input type="checkbox" name="tag_premium" ${(product.tags || product.dietaryBadges || []).includes('premium') ? 'checked' : ''} class="w-4 h-4 text-primary-600 bg-slate-800 border-slate-600 rounded focus:ring-primary-500">
                                    <span class="text-sm text-slate-300">💎 Premium</span>
                                </label>
                                <label class="flex items-center gap-2 p-2 bg-slate-950/50 border border-slate-700 rounded-lg cursor-pointer hover:border-primary-500 transition-colors">
                                    <input type="checkbox" name="tag_exclusive" ${(product.tags || product.dietaryBadges || []).includes('exclusive') ? 'checked' : ''} class="w-4 h-4 text-primary-600 bg-slate-800 border-slate-600 rounded focus:ring-primary-500">
                                    <span class="text-sm text-slate-300">💫 Exclusive</span>
                                </label>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-slate-400 mb-1.5">Custom Tags (comma-separated)</label>
                                <input type="text" name="customTags" value="${((product.tags || product.dietaryBadges || []).filter(t => !['vegan', 'glutenFree', 'organic', 'keto', 'lowSodium', 'bestSeller', 'new', 'sale', 'premium', 'exclusive'].includes(t))).join(', ')}" placeholder="e.g. Handmade, Local, Eco-Friendly" class="w-full bg-slate-950/50 border border-slate-700 rounded-lg px-4 py-2.5 text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all placeholder-slate-600">
                                <p class="text-xs text-slate-500 mt-1">Add custom tags separated by commas</p>
                            </div>
                        </div>

                        <div class="pt-4 flex gap-3">
                            <button type="button" onclick="closeModal()" class="flex-1 px-4 py-3 bg-slate-800 hover:bg-slate-700 text-white rounded-xl font-medium transition-colors">Cancel</button>
                            <button type="submit" class="flex-1 px-4 py-3 bg-primary-600 hover:bg-primary-500 text-white rounded-xl font-bold shadow-lg shadow-primary-500/20 transition-all">Save Changes</button>
                        </div>
                    </form>
                </div>
            `;
            document.getElementById('modal').classList.remove('hidden');
        }
        
        // Operations
        function addProduct(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            // Collect selected preset tags
            const tags = [];
            if (formData.get('tag_vegan')) tags.push('vegan');
            if (formData.get('tag_glutenFree')) tags.push('glutenFree');
            if (formData.get('tag_organic')) tags.push('organic');
            if (formData.get('tag_keto')) tags.push('keto');
            if (formData.get('tag_lowSodium')) tags.push('lowSodium');
            if (formData.get('tag_bestSeller')) tags.push('bestSeller');
            if (formData.get('tag_new')) tags.push('new');
            if (formData.get('tag_sale')) tags.push('sale');
            if (formData.get('tag_premium')) tags.push('premium');
            if (formData.get('tag_exclusive')) tags.push('exclusive');
            
            // Collect custom tags
            const customTags = formData.get('customTags');
            if (customTags && customTags.trim()) {
                const customTagArray = customTags.split(',').map(t => t.trim()).filter(t => t.length > 0);
                tags.push(...customTagArray);
            }
            
            const product = {
                barcode: formData.get('barcode'),
                name: formData.get('name'),
                category: formData.get('category'),
                brand: formData.get('brand'),
                price: Math.round(parseFloat(formData.get('price')) * 100),
                stockQuantity: parseInt(formData.get('stock')),
                imageEmoji: formData.get('emoji') || '📦',
                tags: tags,
                isActive: true,
                purchaseCount: 0,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            db.collection('products').add(product)
                .then(() => { showToast('Product added successfully', 'success'); closeModal(); })
                .catch(err => showToast('Error: ' + err.message, 'error'));
        }

        function updateProduct(e, id) {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            // Collect selected preset tags
            const tags = [];
            if (formData.get('tag_vegan')) tags.push('vegan');
            if (formData.get('tag_glutenFree')) tags.push('glutenFree');
            if (formData.get('tag_organic')) tags.push('organic');
            if (formData.get('tag_keto')) tags.push('keto');
            if (formData.get('tag_lowSodium')) tags.push('lowSodium');
            if (formData.get('tag_bestSeller')) tags.push('bestSeller');
            if (formData.get('tag_new')) tags.push('new');
            if (formData.get('tag_sale')) tags.push('sale');
            if (formData.get('tag_premium')) tags.push('premium');
            if (formData.get('tag_exclusive')) tags.push('exclusive');
            
            // Collect custom tags
            const customTags = formData.get('customTags');
            if (customTags && customTags.trim()) {
                const customTagArray = customTags.split(',').map(t => t.trim()).filter(t => t.length > 0);
                tags.push(...customTagArray);
            }
            
            const updates = {
                barcode: formData.get('barcode'),
                name: formData.get('name'),
                category: formData.get('category'),
                brand: formData.get('brand'),
                price: Math.round(parseFloat(formData.get('price')) * 100),
                stockQuantity: parseInt(formData.get('stock')),
                imageEmoji: formData.get('emoji') || '📦',
                tags: tags,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            db.collection('products').doc(id).update(updates)
                .then(() => { showToast('Product updated successfully', 'success'); closeModal(); })
                .catch(err => showToast('Error: ' + err.message, 'error'));
        }

        function deleteProduct(id) {
            if (!confirm('Are you sure you want to delete this product?')) return;
            db.collection('products').doc(id).delete()
                .then(() => showToast('Product deleted', 'success'))
                .catch(err => showToast('Error: ' + err.message, 'error'));
        }
        
        // UI Helpers
        let ratingsLoaded = false;  // Track if ratings data has been loaded
        let analyticsLoaded = false;  // Track if analytics data has been loaded
        let feedbacksLoaded = false;  // Track if feedbacks data has been loaded
        let supportLoaded = false;  // Track if support tickets have been loaded
        let bugReportsLoaded = false;  // Track if bug reports have been loaded
        let settingsLoaded = false;  // Track if settings have been loaded
        
        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById('tab-' + tabId).classList.remove('hidden');
            
            document.querySelectorAll('.nav-tab').forEach(el => el.classList.remove('active', 'text-white'));
            const activeTab = document.querySelector(`.nav-tab[data-target="${tabId}"]`);
            if(activeTab) activeTab.classList.add('active', 'text-white');

            // Load ratings data when Ratings tab is first shown
            if (tabId === 'ratings' && !ratingsLoaded) {
                setTimeout(() => loadRatingsData(), 100);
                ratingsLoaded = true;
            }

            // Load analytics data when Analytics tab is first shown
            if (tabId === 'analytics' && !analyticsLoaded) {
                setTimeout(() => loadAnalyticsData(), 100);
                analyticsLoaded = true;
            }

            // Load feedbacks data when Feedbacks tab is first shown
            if (tabId === 'feedbacks' && !feedbacksLoaded) {
                setTimeout(() => loadFeedbacks(), 100);
                feedbacksLoaded = true;
            }

            // Load support tickets when Support tab is first shown
            if (tabId === 'support' && !supportLoaded) {
                setTimeout(() => loadSupportTickets(), 100);
                supportLoaded = true;
            }

            // Load bug reports when Bug Reports tab is first shown
            if (tabId === 'bug-reports' && !bugReportsLoaded) {
                setTimeout(() => loadBugReports(), 100);
                bugReportsLoaded = true;
            }

            // Load settings when Settings tab is first shown
            if (tabId === 'settings' && !settingsLoaded) {
                setTimeout(() => loadSettingsData(), 100);
                settingsLoaded = true;
            }
        }

        function closeModal() {
            document.getElementById('modal').classList.add('hidden');
        }

        function showToast(message, type = 'normal') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            
            let borderColor = 'border-slate-700';
            let icon = 'info';
            let iconColor = 'text-blue-400';
            
            if(type === 'success') { borderColor = 'border-emerald-500/50'; icon = 'check_circle'; iconColor = 'text-emerald-400'; }
            if(type === 'error') { borderColor = 'border-red-500/50'; icon = 'error'; iconColor = 'text-red-400'; }

            toast.className = `glass-panel pointer-events-auto flex items-center gap-3 px-5 py-4 rounded-xl shadow-2xl border ${borderColor} animate-enter min-w-[300px]`;
            toast.innerHTML = `
                <span class="material-symbols-rounded ${iconColor}">${icon}</span>
                <span class="text-sm font-medium text-white">${message}</span>
            `;
            
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(10px)';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Toggle Theme (Simplified for Single Dark Mode Focus)
        function toggleTheme() {
            // Feature hidden in this premium dark version, but logic kept
            document.documentElement.classList.toggle('dark');
        }

        // CSV & PRINT FUNCTIONS
        function downloadCSV(filename, data) {
            const csv = data;
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
        }

        function exportProductsCSV() {
            let csv = 'Name,Barcode,Category,Brand,Price (₹),Stock\n';
            products.forEach(p => {
                csv += `"${p.name || ''}","${p.barcode || ''}","${p.category || ''}","${p.brand || ''}","${((p.price || 0) / 100).toFixed(2)}","${p.stockQuantity || 0}"\n`;
            });
            downloadCSV('products_' + new Date().toISOString().split('T')[0] + '.csv', csv);
            showToast('Products exported to CSV', 'success');
        }

        function exportOrdersCSV() {
            let csv = 'Receipt ID,Exit Code,Date,Items,Total (₹)\n';
            orders.forEach(o => {
                const date = o.createdAt ? new Date(o.createdAt.seconds * 1000).toLocaleString() : 'N/A';
                const itemCount = (o.items || []).length;
                const total = ((o.total || 0) / 100).toFixed(2);
                const receiptId = o.receiptNo ? o.receiptNo.substring(0, 8).toUpperCase() : 'N/A';
                const exitCode = o.exitCode || 'N/A';
                csv += `"${receiptId}","${exitCode}","${date}","${itemCount}","${total}"\n`;
            });
            downloadCSV('orders_' + new Date().toISOString().split('T')[0] + '.csv', csv);
            showToast('Orders exported to CSV', 'success');
        }

        function exportAnalyticsCSV() {
            let csv = 'Metric,Value\n';
            csv += `Total Products,${products.length}\n`;
            csv += `Total Orders,${orders.length}\n`;
            csv += `Low Stock Items,${products.filter(p => (p.stockQuantity || 0) < 10).length}\n`;
            const totalRevenue = orders.reduce((sum, o) => sum + ((o.total || 0) / 100), 0);
            csv += `Total Revenue (₹),${totalRevenue.toFixed(2)}\n`;
            csv += `\nTop Products\n`;
            const topProducts = [...products].sort((a,b) => (b.purchaseCount || 0) - (a.purchaseCount || 0)).slice(0, 5);
            topProducts.forEach(p => {
                csv += `"${p.name}","${p.purchaseCount || 0} sales"\n`;
            });
            downloadCSV('analytics_' + new Date().toISOString().split('T')[0] + '.csv', csv);
            showToast('Analytics exported to CSV', 'success');
        }

        function exportFeedbacksCSV() {
            let csv = 'Email,Rating,Category,Message,Date\n';
            feedbacks.forEach(f => {
                let date = 'N/A';
                if (f.timestamp && f.timestamp.seconds) {
                    date = new Date(f.timestamp.seconds * 1000).toLocaleString();
                }
                const email = f.email || f.userId || 'Anonymous';
                const rating = f.rating || 0;
                const category = f.category || 'general';
                const message = (f.message || '').replace(/"/g, '""');
                csv += `"${email}","${rating}","${category}","${message}","${date}"\n`;
            });
            downloadCSV('feedbacks_' + new Date().toISOString().split('T')[0] + '.csv', csv);
            showToast('Feedbacks exported to CSV', 'success');
        }

        function exportBugReportsCSV() {
            let csv = 'Email,Title,Description,Status,Date\n';
            bugReports.forEach(b => {
                let date = 'N/A';
                if (b.timestamp && b.timestamp.seconds) {
                    date = new Date(b.timestamp.seconds * 1000).toLocaleString();
                }
                const email = b.email || b.userId || 'Anonymous';
                const title = (b.title || '').replace(/"/g, '""');
                const description = (b.description || '').replace(/"/g, '""');
                const status = b.status || 'open';
                csv += `"${email}","${title}","${description}","${status}","${date}"\n`;
            });
            downloadCSV('bug_reports_' + new Date().toISOString().split('T')[0] + '.csv', csv);
            showToast('Bug reports exported to CSV', 'success');
        }

        function exportUsersCSV() {
            let csv = 'Email,Name,Role,Total Spent (₹),Orders,Last Active,Status\n';
            users.forEach(u => {
                const userOrders = orders.filter(o => o.userId === u.id || o.email === u.email);
                const totalSpent = userOrders.reduce((sum, o) => sum + ((o.total || 0) / 100), 0);
                const lastActive = u.lastLoginTime ? new Date(u.lastLoginTime.seconds * 1000).toLocaleDateString() : 'Never';
                const status = u.isSuspended ? 'Suspended' : 'Active';
                csv += `"${u.email}","${u.name || ''}","${u.role || 'customer'}","${totalSpent.toFixed(2)}","${userOrders.length}","${lastActive}","${status}"\n`;
            });
            downloadCSV('users_' + new Date().toISOString().split('T')[0] + '.csv', csv);
            showToast('Users exported to CSV', 'success');
        }

        function printProducts() {
            let html = '<h1>Product Inventory Report</h1>';
            html += '<p>Generated: ' + new Date().toLocaleString() + '</p>';
            html += '<table border="1" style="width:100%; border-collapse:collapse;"><tr><th>Name</th><th>Barcode</th><th>Category</th><th>Price</th><th>Stock</th></tr>';
            products.forEach(p => {
                html += `<tr><td>${p.name || ''}</td><td>${p.barcode || ''}</td><td>${p.category || ''}</td><td>₹${((p.price || 0) / 100).toFixed(2)}</td><td>${p.stockQuantity || 0}</td></tr>`;
            });
            html += '</table>';
            openPrintWindow(html);
        }

        function printOrders() {
            let html = '<h1>Orders Report</h1>';
            html += '<p>Generated: ' + new Date().toLocaleString() + '</p>';
            html += '<table border="1" style="width:100%; border-collapse:collapse;"><tr><th>Receipt ID</th><th>Exit Code</th><th>Date</th><th>Items</th><th>Total</th></tr>';
            orders.forEach(o => {
                const date = o.createdAt ? new Date(o.createdAt.seconds * 1000).toLocaleString() : 'N/A';
                const itemCount = (o.items || []).length;
                const total = ((o.total || 0) / 100).toFixed(2);
                const receiptId = o.receiptNo ? o.receiptNo.substring(0, 8).toUpperCase() : 'N/A';
                const exitCode = o.exitCode || 'N/A';
                html += `<tr><td>${receiptId}</td><td>${exitCode}</td><td>${date}</td><td>${itemCount}</td><td>₹${total}</td></tr>`;
            });
            html += '</table>';
            openPrintWindow(html);
        }

        function printAnalytics() {
            const topProducts = [...products].sort((a,b) => (b.purchaseCount || 0) - (a.purchaseCount || 0)).slice(0, 5);
            const totalRevenue = orders.reduce((sum, o) => sum + ((o.total || 0) / 100), 0);
            let html = '<h1>Analytics Report</h1>';
            html += '<p>Generated: ' + new Date().toLocaleString() + '</p>';
            html += '<h3>Summary</h3>';
            html += `<p>Total Products: ${products.length}</p>`;
            html += `<p>Total Orders: ${orders.length}</p>`;
            html += `<p>Low Stock Items: ${products.filter(p => (p.stockQuantity || 0) < 10).length}</p>`;
            html += `<p>Total Revenue: ₹${totalRevenue.toFixed(2)}</p>`;
            html += '<h3>Top 5 Products</h3>';
            html += '<table border="1" style="width:100%; border-collapse:collapse;"><tr><th>Product</th><th>Sales</th></tr>';
            topProducts.forEach(p => {
                html += `<tr><td>${p.name}</td><td>${p.purchaseCount || 0}</td></tr>`;
            });
            html += '</table>';
            openPrintWindow(html);
        }

        function printFeedbacks() {
            let html = '<h1>Feedbacks Report</h1>';
            html += '<p>Generated: ' + new Date().toLocaleString() + '</p>';
            html += '<table border="1" style="width:100%; border-collapse:collapse;"><tr><th>Email</th><th>Rating</th><th>Category</th><th>Message</th></tr>';
            feedbacks.forEach(f => {
                const email = f.email || f.userId || 'Anonymous';
                const rating = f.rating || 0;
                const category = f.category || 'general';
                const message = f.message || '';
                html += `<tr><td>${email}</td><td>${rating}/5</td><td>${category}</td><td>${message.substring(0, 100)}</td></tr>`;
            });
            html += '</table>';
            openPrintWindow(html);
        }

        function printBugReports() {
            let html = '<h1>Bug Reports</h1>';
            html += '<p>Generated: ' + new Date().toLocaleString() + '</p>';
            html += '<table border="1" style="width:100%; border-collapse:collapse;"><tr><th>Email</th><th>Title</th><th>Status</th><th>Description</th></tr>';
            bugReports.forEach(b => {
                const email = b.email || b.userId || 'Anonymous';
                const title = b.title || '';
                const status = b.status || 'open';
                const description = (b.description || '').substring(0, 100);
                html += `<tr><td>${email}</td><td>${title}</td><td>${status}</td><td>${description}</td></tr>`;
            });
            html += '</table>';
            openPrintWindow(html);
        }

        function printUsers() {
            let html = '<h1>Users Report</h1>';
            html += '<p>Generated: ' + new Date().toLocaleString() + '</p>';
            html += '<table border="1" style="width:100%; border-collapse:collapse;"><tr><th>Email</th><th>Name</th><th>Role</th><th>Total Spent (₹)</th><th>Orders</th><th>Status</th></tr>';
            users.forEach(u => {
                const userOrders = orders.filter(o => o.userId === u.id || o.email === u.email);
                const totalSpent = userOrders.reduce((sum, o) => sum + ((o.total || 0) / 100), 0);
                const status = u.isSuspended ? 'Suspended' : 'Active';
                html += `<tr><td>${u.email}</td><td>${u.name || ''}</td><td>${u.role || 'customer'}</td><td>₹${totalSpent.toFixed(2)}</td><td>${userOrders.length}</td><td>${status}</td></tr>`;
            });
            html += '</table>';
            openPrintWindow(html);
        }

        function openPrintWindow(html) {
            const printWindow = window.open('', '', 'height=600,width=800');
            printWindow.document.write(`<html><head><title>Print Report</title><style>body{font-family:Arial;margin:20px;} h1{color:#333;} table{border-collapse:collapse; width:100%;} th,td{border:1px solid #ddd; padding:8px; text-align:left;} th{background-color:#f2f2f2;}</style></head><body>${html}</body></html>`);
            printWindow.document.close();
            printWindow.print();
        }

        function globalSearch(query) {
            const searchQuery = query.toLowerCase().trim();
            
            // Show search tab and hide no results message
            const searchNavBtn = document.getElementById('search-nav-btn');
            const noResults = document.getElementById('search-no-results');
            
            if (!searchQuery) {
                searchNavBtn.style.display = 'none';
                noResults.style.display = 'block';
                // Hide all search sections
                document.getElementById('search-products').style.display = 'none';
                document.getElementById('search-orders').style.display = 'none';
                document.getElementById('search-users').style.display = 'none';
                document.getElementById('search-feedbacks').style.display = 'none';
                document.getElementById('search-bugs').style.display = 'none';
                document.getElementById('search-result-count').textContent = 'Enter search query to find items';
                return;
            }
            
            searchNavBtn.style.display = 'block';
            
            // Search Products - ensure products is an array
            const productsArray = Array.isArray(products) ? products : [];
            const matchedProducts = productsArray.filter(p => {
                if (!p) return false;
                return (p.name || '').toLowerCase().includes(searchQuery) ||
                       (p.barcode || '').toLowerCase().includes(searchQuery) ||
                       (p.category || '').toLowerCase().includes(searchQuery) ||
                       (p.brand || '').toLowerCase().includes(searchQuery) ||
                       (p.imageEmoji || '').toLowerCase().includes(searchQuery);
            });
            
            // Search Orders - ensure orders is an array
            const ordersArray = Array.isArray(orders) ? orders : [];
            const matchedOrders = ordersArray.filter(o => {
                if (!o) return false;
                return (o.receiptNo || '').toLowerCase().includes(searchQuery) ||
                       (o.exitCode || '').toLowerCase().includes(searchQuery);
            });
            
            // Search Users - ensure users is an array
            const usersArray = Array.isArray(users) ? users : [];
            const matchedUsers = usersArray.filter(u => {
                if (!u) return false;
                return (u.email || '').toLowerCase().includes(searchQuery) ||
                       (u.name || '').toLowerCase().includes(searchQuery) ||
                       (u.id || '').toLowerCase().includes(searchQuery);
            });
            
            // Search Feedbacks - ensure feedbacks is an array
            const feedbacksArray = Array.isArray(feedbacks) ? feedbacks : [];
            const matchedFeedbacks = feedbacksArray.filter(f => {
                if (!f) return false;
                return (f.email || '').toLowerCase().includes(searchQuery) ||
                       (f.category || '').toLowerCase().includes(searchQuery) ||
                       (f.message || '').toLowerCase().includes(searchQuery);
            });
            
            // Search Bug Reports - ensure bugReports is an array
            const bugReportsArray = Array.isArray(bugReports) ? bugReports : [];
            const matchedBugReports = bugReportsArray.filter(b => {
                if (!b) return false;
                return (b.email || '').toLowerCase().includes(searchQuery) ||
                       (b.title || '').toLowerCase().includes(searchQuery) ||
                       (b.description || '').toLowerCase().includes(searchQuery) ||
                       (b.status || '').toLowerCase().includes(searchQuery);
            });
            
            const totalResults = matchedProducts.length + matchedOrders.length + matchedUsers.length + matchedFeedbacks.length + matchedBugReports.length;
            
            // Update result count
            document.getElementById('search-result-count').textContent = `Found ${totalResults} results for "${query}"`;
            
            // Render Products
            const searchProductsDiv = document.getElementById('search-products');
            const searchProductsList = document.getElementById('search-products-list');
            if (matchedProducts.length > 0) {
                searchProductsDiv.style.display = 'block';
                document.getElementById('search-products-count').textContent = `(${matchedProducts.length})`;
                searchProductsList.innerHTML = matchedProducts.map(p => `
                    <tr class="hover:bg-white/5 transition-colors">
                        <td class="px-6 py-4 font-medium text-white">${p.name || 'N/A'}</td>
                        <td class="px-6 py-4 text-slate-400">${p.barcode || 'N/A'}</td>
                        <td class="px-6 py-4 text-slate-400">${p.category || 'N/A'}</td>
                        <td class="px-6 py-4 text-slate-400">₹${((p.price || 0) / 100).toFixed(2)}</td>
                        <td class="px-6 py-4"><span class="px-3 py-1 rounded-full text-xs font-semibold ${p.stockQuantity > 0 ? 'bg-emerald-500/20 text-emerald-400' : 'bg-red-500/20 text-red-400'}">${p.stockQuantity || 0}</span></td>
                    </tr>
                `).join('');
            } else {
                searchProductsDiv.style.display = 'none';
            }
            
            // Render Orders
            const searchOrdersDiv = document.getElementById('search-orders');
            const searchOrdersList = document.getElementById('search-orders-list');
            if (matchedOrders.length > 0) {
                searchOrdersDiv.style.display = 'block';
                document.getElementById('search-orders-count').textContent = `(${matchedOrders.length})`;
                searchOrdersList.innerHTML = matchedOrders.map(o => {
                    let dateStr = 'N/A';
                    if (o.createdAt && o.createdAt.seconds) {
                        dateStr = new Date(o.createdAt.seconds * 1000).toLocaleDateString();
                    } else if (o.createdAt) {
                        dateStr = new Date(o.createdAt).toLocaleDateString();
                    }
                    return `
                        <tr class="hover:bg-white/5 transition-colors">
                            <td class="px-6 py-4 font-mono text-primary-400">${o.receiptNo || 'N/A'}</td>
                            <td class="px-6 py-4 font-mono text-slate-400">${o.exitCode || 'N/A'}</td>
                            <td class="px-6 py-4 text-slate-400">${dateStr}</td>
                            <td class="px-6 py-4 text-slate-400">${(o.items || []).length}</td>
                            <td class="px-6 py-4 font-semibold text-white">₹${((o.total || 0) / 100).toFixed(2)}</td>
                        </tr>
                    `;
                }).join('');
            } else {
                searchOrdersDiv.style.display = 'none';
            }
            
            // Render Users
            const searchUsersDiv = document.getElementById('search-users');
            const searchUsersList = document.getElementById('search-users-list');
            if (matchedUsers.length > 0) {
                searchUsersDiv.style.display = 'block';
                document.getElementById('search-users-count').textContent = `(${matchedUsers.length})`;
                searchUsersList.innerHTML = matchedUsers.map(u => {
                    const userOrders = Array.isArray(orders) ? orders.filter(o => o.userId === u.id) : [];
                    const totalSpent = (userOrders.reduce((sum, o) => sum + (o.total || 0), 0) / 100).toFixed(2);
                    const orderCount = userOrders.length;
                    return `
                        <tr class="hover:bg-white/5 transition-colors">
                            <td class="px-6 py-4 text-slate-400">${u.email || 'N/A'}</td>
                            <td class="px-6 py-4 text-white font-medium">${u.name || 'N/A'}</td>
                            <td class="px-6 py-4"><span class="px-2 py-1 rounded text-xs font-semibold ${u.role === 'admin' ? 'bg-purple-500/20 text-purple-400' : 'bg-slate-500/20 text-slate-400'}">${u.role || 'user'}</span></td>
                            <td class="px-6 py-4 font-semibold text-white">₹${totalSpent}</td>
                            <td class="px-6 py-4 text-slate-400">${orderCount}</td>
                        </tr>
                    `;
                }).join('');
            } else {
                searchUsersDiv.style.display = 'none';
            }
            
            // Render Feedbacks
            const searchFeedbacksDiv = document.getElementById('search-feedbacks');
            const searchFeedbacksList = document.getElementById('search-feedbacks-list');
            if (matchedFeedbacks.length > 0) {
                searchFeedbacksDiv.style.display = 'block';
                document.getElementById('search-feedbacks-count').textContent = `(${matchedFeedbacks.length})`;
                searchFeedbacksList.innerHTML = matchedFeedbacks.map(f => `
                    <tr class="hover:bg-white/5 transition-colors">
                        <td class="px-6 py-4 text-slate-400">${f.email || 'N/A'}</td>
                        <td class="px-6 py-4">${'⭐'.repeat(f.rating || 0)}<span class="text-slate-500 text-xs ml-2">${f.rating || 0}/5</span></td>
                        <td class="px-6 py-4 text-slate-400">${f.category || 'General'}</td>
                        <td class="px-6 py-4 text-slate-400 max-w-xs truncate">${f.message || 'N/A'}</td>
                    </tr>
                `).join('');
            } else {
                searchFeedbacksDiv.style.display = 'none';
            }
            
            // Render Bug Reports
            const searchBugsDiv = document.getElementById('search-bugs');
            const searchBugsList = document.getElementById('search-bugs-list');
            if (matchedBugReports.length > 0) {
                searchBugsDiv.style.display = 'block';
                document.getElementById('search-bugs-count').textContent = `(${matchedBugReports.length})`;
                searchBugsList.innerHTML = matchedBugReports.map(b => `
                    <tr class="hover:bg-white/5 transition-colors">
                        <td class="px-6 py-4 text-slate-400">${b.email || 'N/A'}</td>
                        <td class="px-6 py-4 font-medium text-white">${b.title || 'N/A'}</td>
                        <td class="px-6 py-4"><span class="px-2 py-1 rounded text-xs font-semibold ${b.status === 'closed' ? 'bg-emerald-500/20 text-emerald-400' : b.status === 'in-progress' ? 'bg-yellow-500/20 text-yellow-400' : 'bg-red-500/20 text-red-400'}">${b.status || 'open'}</span></td>
                        <td class="px-6 py-4 text-slate-400 max-w-xs truncate">${b.description || 'N/A'}</td>
                    </tr>
                `).join('');
            } else {
                searchBugsDiv.style.display = 'none';
            }
            
            // Show/hide no results message
            if (totalResults === 0) {
                noResults.style.display = 'block';
            } else {
                noResults.style.display = 'none';
            }
        }

        // Init Check
        auth.onAuthStateChanged(async user => {
            // Safe check on auth state change
            const currentUserEmail = user?.email?.toLowerCase?.() || null;

            if (currentUserEmail && ALLOWED_EMAILS_LOWER.includes(currentUserEmail)) {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                init();
            } else {
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('app-container').classList.add('hidden');
            }
        });
    </script>

    <!-- Notification JS moved here -->
    <script>
    // Send notification to all users
    async function sendNotificationToAll(e) {
        e.preventDefault();
        const title = document.getElementById('notify-title').value.trim();
        const message = document.getElementById('notify-message').value.trim();
        const statusDiv = document.getElementById('notify-status');
        statusDiv.textContent = 'Sending...';
        try {
            // Save to global notifications collection
            const notifDoc = await db.collection('notifications').add({
                title,
                message,
                timestamp: new Date(),
            });
            // Get all users
            const usersSnap = await db.collection('users').get();
            const batch = db.batch();
            usersSnap.forEach(userDoc => {
                const notifRef = db.collection('users').doc(userDoc.id).collection('notifications').doc(notifDoc.id);
                batch.set(notifRef, {
                    title: title,
                    message: message,
                    timestamp: new Date(),
                    read: false
                });
            });
            await batch.commit();
            statusDiv.textContent = 'Notification sent to all users!';
            document.getElementById('notify-form').reset();
            loadNotificationHistory();
        } catch (err) {
            statusDiv.textContent = 'Error: ' + err.message;
        }
    }

    // Load notification history from global notifications collection
    async function loadNotificationHistory() {
        const table = document.getElementById('notification-history-table');
        table.innerHTML = '<tr><td colspan="4" class="px-4 py-8 text-center text-slate-500">Loading history...</td></tr>';
        try {
            const snap = await db.collection('notifications').orderBy('timestamp', 'desc').limit(20).get();
            if (snap.empty) {
                table.innerHTML = '<tr><td colspan="4" class="px-4 py-8 text-center text-slate-500">No notifications sent yet.</td></tr>';
                return;
            }
            table.innerHTML = '';
            snap.forEach(doc => {
                const data = doc.data();
                const date = data.timestamp && data.timestamp.toDate ? data.timestamp.toDate() : new Date();
                table.innerHTML += `
                    <tr>
                        <td class="px-4 py-3 text-white font-semibold">${data.title || ''}</td>
                        <td class="px-4 py-3 text-slate-300 break-words whitespace-pre-line max-w-xs" style="word-break:break-word;">${data.message || ''}</td>
                        <td class="px-4 py-3 text-slate-400">${date.toLocaleString()}</td>
                        <td class="px-4 py-3 text-right">
                            <button onclick="deleteNotificationFromAllUsers('${doc.id}')" class="p-2 bg-red-500/10 hover:bg-red-500/20 text-red-400 rounded-lg transition-colors hover:scale-110" title="Delete everywhere">
                                <span class="material-symbols-rounded text-lg">delete</span>
                            </button>
                        </td>
                    </tr>
                `;
            });
        } catch (err) {
            table.innerHTML = `<tr><td colspan="4" class="px-4 py-8 text-center text-red-400">Error loading history: ${err.message}</td></tr>`;
        }
    }

    // Delete notification from all users and global history
    async function deleteNotificationFromAllUsers(notifId) {
        if (!confirm('Delete this notification from all users?')) return;
        try {
            // Remove from global notifications
            await db.collection('notifications').doc(notifId).delete();
            // Remove from all users
            const usersSnap = await db.collection('users').get();
            const batch = db.batch();
            usersSnap.forEach(userDoc => {
                const notifRef = db.collection('users').doc(userDoc.id).collection('notifications').doc(notifId);
                batch.delete(notifRef);
            });
            await batch.commit();
            loadNotificationHistory();
        } catch (err) {
            alert('Error deleting notification: ' + err.message);
        }
    }

    // ============================
    // SALES ANALYTICS FUNCTIONS
    // ============================

    async function loadSalesData() {
        try {
            // Fetch orders
            const ordersSnap = await db.collection('orders').get();
            const orders = ordersSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            // Calculate stats
            const totalRevenue = orders.reduce((sum, order) => sum + (order.total || 0), 0);
            const totalOrders = orders.length;
            const avgOrderValue = totalOrders > 0 ? totalRevenue / totalOrders : 0;

            // Update stats cards
            document.getElementById('stat-total-revenue').textContent = `₹${(totalRevenue / 100).toLocaleString('en-IN', { minimumFractionDigits: 2 })}`;
            document.getElementById('stat-total-orders').textContent = totalOrders.toLocaleString('en-IN');
            document.getElementById('avg-order-value').textContent = `₹${(avgOrderValue / 100).toLocaleString('en-IN', { minimumFractionDigits: 2 })}`;

            // Fetch products with sales data
            const productsSnap = await db.collection('products').get();
            const productsWithSales = productsSnap.docs.map(doc => {
                const data = doc.data();
                return {
                    id: doc.id,
                    name: data.name,
                    emoji: data.imageEmoji || '📦',
                    purchaseCount: data.purchaseCount || 0,
                    price: data.price || 0,
                    stock: data.stockQuantity || 0,
                    revenue: (data.purchaseCount || 0) * (data.price || 0)
                };
            });

            // Sort by purchase count
            productsWithSales.sort((a, b) => b.purchaseCount - a.purchaseCount);

            // Display top 10 products
            const tbody = document.getElementById('top-products-tbody');
            tbody.innerHTML = productsWithSales.slice(0, 10).map(p => `
                <tr class="hover:bg-white/5 transition-colors">
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">${p.emoji}</span>
                            <span class="text-white font-medium">${p.name}</span>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-slate-300">${p.purchaseCount} units</td>
                    <td class="px-6 py-4 text-emerald-400 font-semibold">₹${(p.revenue / 100).toLocaleString('en-IN')}</td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 rounded-lg text-xs font-semibold ${p.stock < 10 ? 'bg-red-500/20 text-red-400' : 'bg-green-500/20 text-green-400'}">
                            ${p.stock} left
                        </span>
                    </td>
                </tr>
            `).join('') || '<tr><td colspan="4" class="px-6 py-8 text-center text-slate-500">No sales data</td></tr>';

            // Display low stock alerts
            const lowStock = productsWithSales.filter(p => p.stock < 10 && p.stock > 0);
            const statLowStock = document.getElementById('stat-low-stock');
            const lowStockList = document.getElementById('low-stock-list');
            if (statLowStock) statLowStock.textContent = lowStock.length;
            if (lowStockList) lowStockList.innerHTML = lowStock.length > 0 
                ? lowStock.map(p => `
                    <div class="flex items-center justify-between p-4 bg-red-950/30 border border-red-500/20 rounded-xl">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">${p.emoji}</span>
                            <div>
                                <div class="text-white font-medium">${p.name}</div>
                                <div class="text-xs text-red-400">Only ${p.stock} left in stock</div>
                            </div>
                        </div>
                        <button onclick="editProduct('${p.id}')" class="px-3 py-1.5 bg-red-600 hover:bg-red-700 text-white rounded-lg text-xs font-semibold transition-colors">
                            Restock
                        </button>
                    </div>
                `).join('')
                : '<p class="text-slate-500 text-center py-4">All products well stocked! ✨</p>';

        } catch (err) {
            console.error('Error loading sales data:', err);
            showToast('Error loading sales data: ' + err.message, 'error');
        }
    }

    // ============================
    // RATINGS ANALYTICS FUNCTIONS
    // ============================

    async function loadRatingsData() {
        try {
            console.log('Loading ratings data...');
            
            // Get all products
            const productsSnap = await db.collection('products').get();
            const allReviews = [];
            const productRatings = [];
            const userReviews = {};

            // For each product, fetch its reviews
            for (const productDoc of productsSnap.docs) {
                const productData = productDoc.data();
                const reviewsSnap = await db.collection('products')
                    .doc(productDoc.id)
                    .collection('reviews')
                    .get();

                if (!reviewsSnap.empty) {
                    const reviews = reviewsSnap.docs.map(doc => ({
                        ...doc.data(),
                        productId: productDoc.id,
                        productName: productData.name
                    }));

                    allReviews.push(...reviews);

                    // Calculate product average
                    const avgRating = reviews.reduce((sum, r) => sum + r.rating, 0) / reviews.length;
                    productRatings.push({
                        productId: productDoc.id,
                        productName: productData.name,
                        avgRating: avgRating,
                        reviewCount: reviews.length,
                        emoji: productData.imageEmoji || '📦'
                    });

                    // Track user reviews (use userId or fallback to userName for grouping)
                    reviews.forEach(review => {
                        const userKey = review.userId || `userName_${review.userName}`;
                        if (!userReviews[userKey]) {
                            userReviews[userKey] = {
                                userId: review.userId || '',
                                userName: review.userName,
                                reviews: [],
                                totalRating: 0
                            };
                        }
                        userReviews[userKey].reviews.push(review);
                        userReviews[userKey].totalRating += review.rating;
                    });
                }
            }

            console.log('✅ Loaded reviews:', allReviews.length);
            console.log('📦 Product ratings calculated:', productRatings);
            console.log('👥 User reviews aggregated:', userReviews);

            // Update overall stats
            const totalReviews = allReviews.length;
            const overallAvg = totalReviews > 0 
                ? allReviews.reduce((sum, r) => sum + r.rating, 0) / totalReviews 
                : 0;

            console.log('📊 Overall Stats:', {
                totalReviews,
                overallAvg: overallAvg.toFixed(1),
                ratedProducts: productRatings.length,
                activeReviewers: Object.keys(userReviews).length
            });

            // Verify calculation
            const ratingSum = allReviews.reduce((sum, r) => sum + r.rating, 0);
            console.log('🔢 Rating Calculation: ' + ratingSum + ' ÷ ' + totalReviews + ' = ' + overallAvg.toFixed(1));

            document.getElementById('overall-avg-rating').textContent = overallAvg.toFixed(1);
            document.getElementById('total-reviews').textContent = totalReviews;
            document.getElementById('rated-products').textContent = productRatings.length;
            document.getElementById('active-reviewers').textContent = Object.keys(userReviews).length;

            // Update rating distribution
            const distribution = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };
            allReviews.forEach(r => {
                const star = Math.floor(r.rating);
                distribution[star] = (distribution[star] || 0) + 1;
            });

            console.log('⭐ Rating Distribution:', distribution);

            const maxCount = Math.max(...Object.values(distribution), 1);
            for (let i = 1; i <= 5; i++) {
                const count = distribution[i] || 0;
                const percentage = (count / maxCount * 100).toFixed(0);
                document.getElementById(`rating-bar-${i}`).style.width = `${percentage}%`;
                document.getElementById(`rating-count-${i}`).textContent = count;
            }

            // Show most reviewed products (sorted by review count, not rating)
            const topProducts = productRatings
                .sort((a, b) => b.reviewCount - a.reviewCount)
                .slice(0, 10);

            const topProductsHtml = topProducts.length > 0 
                ? topProducts.map((p, idx) => `
                    <div class="flex items-center gap-4 p-4 bg-slate-800/50 rounded-xl hover:bg-slate-800 transition-all">
                        <div class="flex items-center justify-center w-8 h-8 rounded-full bg-slate-700 text-slate-300 font-bold text-sm">
                            ${idx + 1}
                        </div>
                        <div class="text-2xl">${p.emoji}</div>
                        <div class="flex-1">
                            <div class="font-medium text-white">${p.productName}</div>
                            <div class="text-xs text-slate-400">${p.reviewCount} review${p.reviewCount !== 1 ? 's' : ''}</div>
                        </div>
                        <div class="flex items-center gap-1 px-3 py-1.5 rounded-lg bg-orange-500/20 border border-orange-500/30">
                            <span class="material-symbols-rounded text-orange-400 text-sm">star</span>
                            <span class="font-bold text-orange-400">${p.avgRating.toFixed(1)}</span>
                        </div>
                    </div>
                `).join('')
                : '<div class="text-center py-8 text-slate-500">No rated products yet</div>';

            const topRatedElem = document.getElementById('top-rated-products');
            if (topRatedElem) topRatedElem.innerHTML = topProductsHtml;

            // Show user ratings activity (grouped by userKey to handle duplicates)
            const userRatingsArray = Object.entries(userReviews).map(([userKey, data]) => ({
                userId: data.userId,
                userName: data.userName,
                reviewCount: data.reviews.length,
                avgRating: data.totalRating / data.reviews.length,
                lastReview: new Date(Math.max(...data.reviews.map(r => 
                    r.createdAt ? new Date(r.createdAt).getTime() : 0
                )))
            })).sort((a, b) => b.reviewCount - a.reviewCount);

            console.log('👤 User Ratings Array:', userRatingsArray.map(u => ({
                userName: u.userName,
                userId: u.userId,
                reviews: u.reviewCount,
                avgRating: u.avgRating.toFixed(1)
            })));

            const userTableHtml = userRatingsArray.length > 0
                ? userRatingsArray.map(u => `
                    <tr class="hover:bg-white/5 transition-colors">
                        <td class="px-6 py-4">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-purple-500/20 flex items-center justify-center">
                                    <span class="text-purple-400 font-bold">${u.userName[0].toUpperCase()}</span>
                                </div>
                                <span class="text-white font-medium">${u.userName}</span>
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            <span class="px-3 py-1 rounded-full bg-blue-500/20 text-blue-400 font-semibold">
                                ${u.reviewCount}
                            </span>
                        </td>
                        <td class="px-6 py-4">
                            <div class="flex items-center gap-2">
                                <span class="material-symbols-rounded text-orange-400 text-sm">star</span>
                                <span class="text-white font-semibold">${u.avgRating.toFixed(1)}</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 text-slate-400">
                            ${u.lastReview.toLocaleDateString()}
                        </td>
                    </tr>
                `).join('')
                : '<tr><td colspan="4" class="px-6 py-12 text-center text-slate-500">No user reviews yet</td></tr>';

            const userRatingsElem = document.getElementById('user-ratings-tbody');
            if (userRatingsElem) userRatingsElem.innerHTML = userTableHtml;

            console.log('Ratings data loaded successfully');
        } catch (error) {
            console.error('Error loading ratings:', error);
            showToast('Error loading ratings: ' + error.message, 'error');
        }
    }

    function refreshRatingsData() {
        showToast('Refreshing ratings data...', 'info');
        loadRatingsData();
    }

    // ============================
    // CATEGORY MANAGEMENT
    // ============================

    function loadCategories() {
        db.collection('categories').orderBy('name').onSnapshot(snapshot => {
            const categories = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderCategories(categories);
        }, err => showToast('Error loading categories: ' + err.message, 'error'));
    }

    function renderCategories(categories) {
        const grid = document.getElementById('categories-grid');
        if (!grid) return; // Element doesn't exist in DOM yet
        if (categories.length === 0) {
            grid.innerHTML = '<div class="col-span-full text-center py-12"><span class="material-symbols-rounded text-4xl text-slate-600 mb-2 block">category</span><p class="text-slate-500">No categories yet</p></div>';
            return;
        }
        grid.innerHTML = categories.map(c => `
            <div class="spotlight-card rounded-2xl p-6 hover:shadow-xl transition-all group">
                <div class="flex items-center justify-between mb-4">
                    <div class="text-4xl">${c.icon || '📦'}</div>
                    <div class="flex gap-2">
                        <button onclick="editCategory('${c.id}')" class="p-2 bg-slate-800 hover:bg-slate-700 rounded-lg transition-colors">
                            <span class="material-symbols-rounded text-sm text-blue-400">edit</span>
                        </button>
                        <button onclick="deleteCategory('${c.id}')" class="p-2 bg-slate-800 hover:bg-red-900 rounded-lg transition-colors">
                            <span class="material-symbols-rounded text-sm text-red-400">delete</span>
                        </button>
                    </div>
                </div>
                <h3 class="text-lg font-bold text-white mb-2">${c.name}</h3>
                <p class="text-sm text-slate-400 line-clamp-2">${c.description || 'No description'}</p>
            </div>
        `).join('');
    }

    function showAddCategoryModal() {
        const modalContent = document.getElementById('modal-content');
        modalContent.innerHTML = `
            <div class="glass-panel rounded-2xl p-6 w-full max-w-md">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-white">Add Category</h3>
                    <button onclick="closeModal()" class="text-slate-500 hover:text-white transition-colors">
                        <span class="material-symbols-rounded">close</span>
                    </button>
                </div>
                <form onsubmit="addCategory(event)" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-2">Category Name</label>
                        <input type="text" id="category-name" required class="w-full px-4 py-2 bg-slate-900/50 border border-white/10 rounded-xl text-white focus:ring-2 focus:ring-primary-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-2">Emoji Icon</label>
                        <input type="text" id="category-icon" placeholder="📦" maxlength="2" class="w-full px-4 py-2 bg-slate-900/50 border border-white/10 rounded-xl text-white focus:ring-2 focus:ring-primary-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-2">Description</label>
                        <textarea id="category-description" rows="3" class="w-full px-4 py-2 bg-slate-900/50 border border-white/10 rounded-xl text-white focus:ring-2 focus:ring-primary-500"></textarea>
                    </div>
                    <div class="flex gap-3">
                        <button type="button" onclick="closeModal()" class="flex-1 px-4 py-2 bg-slate-800 hover:bg-slate-700 text-white rounded-xl transition-colors">Cancel</button>
                        <button type="submit" class="flex-1 px-4 py-2 bg-primary-600 hover:bg-primary-500 text-white rounded-xl font-semibold transition-colors">Create</button>
                    </div>
                </form>
            </div>
        `;
        document.getElementById('modal').classList.remove('hidden');
    }

    function addCategory(e) {
        e.preventDefault();
        const data = {
            name: document.getElementById('category-name').value,
            icon: document.getElementById('category-icon').value || '📦',
            description: document.getElementById('category-description').value,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        db.collection('categories').add(data)
            .then(() => {
                showToast('Category added successfully', 'success');
                closeModal();
            })
            .catch(err => showToast('Error: ' + err.message, 'error'));
    }

    function editCategory(id) {
        db.collection('categories').doc(id).get().then(doc => {
            const cat = doc.data();
            const modalContent = document.getElementById('modal-content');
            modalContent.innerHTML = `
                <div class="glass-panel rounded-2xl p-6 w-full max-w-md">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-bold text-white">Edit Category</h3>
                        <button onclick="closeModal()" class="text-slate-500 hover:text-white transition-colors">
                            <span class="material-symbols-rounded">close</span>
                        </button>
                    </div>
                    <form onsubmit="updateCategory(event, '${id}')" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-2">Category Name</label>
                            <input type="text" id="category-name" value="${cat.name}" required class="w-full px-4 py-2 bg-slate-900/50 border border-white/10 rounded-xl text-white focus:ring-2 focus:ring-primary-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-2">Emoji Icon</label>
                            <input type="text" id="category-icon" value="${cat.icon}" maxlength="2" class="w-full px-4 py-2 bg-slate-900/50 border border-white/10 rounded-xl text-white focus:ring-2 focus:ring-primary-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-2">Description</label>
                            <textarea id="category-description" rows="3" class="w-full px-4 py-2 bg-slate-900/50 border border-white/10 rounded-xl text-white focus:ring-2 focus:ring-primary-500">${cat.description || ''}</textarea>
                        </div>
                        <div class="flex gap-3">
                            <button type="button" onclick="closeModal()" class="flex-1 px-4 py-2 bg-slate-800 hover:bg-slate-700 text-white rounded-xl transition-colors">Cancel</button>
                            <button type="submit" class="flex-1 px-4 py-2 bg-primary-600 hover:bg-primary-500 text-white rounded-xl font-semibold transition-colors">Update</button>
                        </div>
                    </form>
                </div>
            `;
            document.getElementById('modal').classList.remove('hidden');
        });
    }

    function updateCategory(e, id) {
        e.preventDefault();
        const data = {
            name: document.getElementById('category-name').value,
            icon: document.getElementById('category-icon').value || '📦',
            description: document.getElementById('category-description').value,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        db.collection('categories').doc(id).update(data)
            .then(() => {
                showToast('Category updated successfully', 'success');
                closeModal();
            })
            .catch(err => showToast('Error: ' + err.message, 'error'));
    }

    function deleteCategory(id) {
        if (confirm('Delete this category? This action cannot be undone.')) {
            db.collection('categories').doc(id).delete()
                .then(() => showToast('Category deleted', 'success'))
                .catch(err => showToast('Error: ' + err.message, 'error'));
        }
    }

    // ============================
    // BULK CSV IMPORT/EXPORT
    // ============================

    function exportProductsCSV() {
        const headers = ['Barcode', 'Name', 'Category', 'Brand', 'Price', 'Stock', 'ImageEmoji', 'Tags', 'Description'];
        const rows = products.map(p => [
            p.barcodeContent || '',
            p.name || '',
            p.category || '',
            p.brand || '',
            (p.price / 100).toFixed(2),
            p.stockQuantity || 0,
            p.imageEmoji || '',
            (p.tags || []).join(';'),
            p.description || ''
        ]);
        const csv = [headers, ...rows].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `products_${Date.now()}.csv`;
        a.click();
        URL.revokeObjectURL(url);
        showToast('Products exported successfully', 'success');
    }

    function handleCSVImport(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const csv = e.target.result;
                const lines = csv.split('\n').filter(line => line.trim());
                const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim());
                
                let imported = 0;
                const batch = db.batch();
                
                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split(',').map(v => v.replace(/"/g, '').trim());
                    const product = {
                        barcodeContent: values[0] || '',
                        name: values[1] || 'Unnamed Product',
                        category: values[2] || 'General',
                        brand: values[3] || '',
                        price: Math.round(parseFloat(values[4] || 0) * 100),
                        stockQuantity: parseInt(values[5] || 0),
                        imageEmoji: values[6] || '📦',
                        tags: (values[7] || '').split(';').filter(t => t),
                        description: values[8] || '',
                        purchaseCount: 0,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    const ref = db.collection('products').doc();
                    batch.set(ref, product);
                    imported++;
                    
                    // Track stock history
                    await logStockChange(ref.id, 0, product.stockQuantity, 'Initial import');
                    
                    if (imported % 500 === 0) {
                        await batch.commit();
                    }
                }
                
                if (imported % 500 !== 0) {
                    await batch.commit();
                }
                
                await logActivity('Bulk Import', `Imported ${imported} products via CSV`);
                showToast(`Successfully imported ${imported} products`, 'success');
                event.target.value = '';
            } catch (err) {
                showToast('Import failed: ' + err.message, 'error');
            }
        };
        reader.readAsText(file);
    }

    // ============================
    // SUPPLIER MANAGEMENT
    // ============================

    function loadSuppliers() {
        db.collection('suppliers').orderBy('name').onSnapshot(snapshot => {
            const suppliers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderSuppliers(suppliers);
        }, err => showToast('Error loading suppliers: ' + err.message, 'error'));
    }

    function renderSuppliers(suppliers) {
        const grid = document.getElementById('suppliers-grid');
        if (!grid) return; // Element doesn't exist in DOM yet
        if (suppliers.length === 0) {
            grid.innerHTML = '<div class="col-span-full text-center py-12"><span class="material-symbols-rounded text-4xl text-slate-600 mb-2 block">local_shipping</span><p class="text-slate-500">No suppliers yet</p></div>';
            return;
        }
        grid.innerHTML = suppliers.map(s => `
            <div class="spotlight-card rounded-2xl p-6 hover:shadow-xl transition-all">
                <div class="flex items-center justify-between mb-4">
                    <div class="text-4xl">${s.icon || '🏭'}</div>
                    <div class="flex gap-2">
                        <button onclick="editSupplier('${s.id}')" class="p-2 bg-slate-800 hover:bg-slate-700 rounded-lg transition-colors">
                            <span class="material-symbols-rounded text-sm text-blue-400">edit</span>
                        </button>
                        <button onclick="deleteSupplier('${s.id}')" class="p-2 bg-slate-800 hover:bg-red-900 rounded-lg transition-colors">
                            <span class="material-symbols-rounded text-sm text-red-400">delete</span>
                        </button>
                    </div>
                </div>
                <h3 class="text-lg font-bold text-white mb-2">${s.name}</h3>
                <p class="text-sm text-slate-400 mb-2">${s.contact || 'No contact'}</p>
                <p class="text-sm text-slate-400 mb-2">${s.email || 'No email'}</p>
                <p class="text-xs text-slate-500">${s.address || 'No address'}</p>
                <div class="mt-4 pt-4 border-t border-white/10">
                    <p class="text-xs text-slate-400">${s.productsCount || 0} products supplied</p>
                </div>
            </div>
        `).join('');
    }

    function showAddSupplierModal() {
        const modalContent = document.getElementById('modal-content');
        modalContent.innerHTML = `
            <div class="glass-panel rounded-2xl p-6 w-full max-w-md">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-white">Add Supplier</h3>
                    <button onclick="closeModal()" class="text-slate-500 hover:text-white transition-colors">
                        <span class="material-symbols-rounded">close</span>
                    </button>
                </div>
                <form onsubmit="addSupplier(event)" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-2">Supplier Name</label>
                        <input type="text" id="supplier-name" required class="w-full px-4 py-2 bg-slate-900/50 border border-white/10 rounded-xl text-white focus:ring-2 focus:ring-primary-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-2">Icon Emoji</label>
                        <input type="text" id="supplier-icon" placeholder="🏭" maxlength="2" class="w-full px-4 py-2 bg-slate-900/50 border border-white/10 rounded-xl text-white focus:ring-2 focus:ring-primary-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-2">Contact Person</label>
                        <input type="text" id="supplier-contact" class="w-full px-4 py-2 bg-slate-900/50 border border-white/10 rounded-xl text-white focus:ring-2 focus:ring-primary-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-2">Email</label>
                        <input type="email" id="supplier-email" class="w-full px-4 py-2 bg-slate-900/50 border border-white/10 rounded-xl text-white focus:ring-2 focus:ring-primary-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-2">Phone</label>
                        <input type="tel" id="supplier-phone" class="w-full px-4 py-2 bg-slate-900/50 border border-white/10 rounded-xl text-white focus:ring-2 focus:ring-primary-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-2">Address</label>
                        <textarea id="supplier-address" rows="3" class="w-full px-4 py-2 bg-slate-900/50 border border-white/10 rounded-xl text-white focus:ring-2 focus:ring-primary-500"></textarea>
                    </div>
                    <div class="flex gap-3">
                        <button type="button" onclick="closeModal()" class="flex-1 px-4 py-2 bg-slate-800 hover:bg-slate-700 text-white rounded-xl transition-colors">Cancel</button>
                        <button type="submit" class="flex-1 px-4 py-2 bg-primary-600 hover:bg-primary-500 text-white rounded-xl font-semibold transition-colors">Create</button>
                    </div>
                </form>
            </div>
        `;
        document.getElementById('modal').classList.remove('hidden');
    }

    async function addSupplier(e) {
        e.preventDefault();
        const data = {
            name: document.getElementById('supplier-name').value,
            icon: document.getElementById('supplier-icon').value || '🏭',
            contact: document.getElementById('supplier-contact').value,
            email: document.getElementById('supplier-email').value,
            phone: document.getElementById('supplier-phone').value,
            address: document.getElementById('supplier-address').value,
            productsCount: 0,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        try {
            await db.collection('suppliers').add(data);
            await logActivity('Add Supplier', `Added supplier: ${data.name}`);
            showToast('Supplier added successfully', 'success');
            closeModal();
        } catch (err) {
            showToast('Error: ' + err.message, 'error');
        }
    }

    function editSupplier(id) {
        db.collection('suppliers').doc(id).get().then(async doc => {
            const sup = doc.data();
            const modalContent = document.getElementById('modal-content');
            modalContent.innerHTML = `
                <div class="glass-panel rounded-2xl p-6 w-full max-w-md">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-bold text-white">Edit Supplier</h3>
                        <button onclick="closeModal()" class="text-slate-500 hover:text-white transition-colors">
                            <span class="material-symbols-rounded">close</span>
                        </button>
                    </div>
                    <form onsubmit="updateSupplier(event, '${id}')" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-2">Supplier Name</label>
                            <input type="text" id="supplier-name" value="${sup.name}" required class="w-full px-4 py-2 bg-slate-900/50 border border-white/10 rounded-xl text-white focus:ring-2 focus:ring-primary-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-2">Icon Emoji</label>
                            <input type="text" id="supplier-icon" value="${sup.icon}" maxlength="2" class="w-full px-4 py-2 bg-slate-900/50 border border-white/10 rounded-xl text-white focus:ring-2 focus:ring-primary-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-2">Contact Person</label>
                            <input type="text" id="supplier-contact" value="${sup.contact || ''}" class="w-full px-4 py-2 bg-slate-900/50 border border-white/10 rounded-xl text-white focus:ring-2 focus:ring-primary-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-2">Email</label>
                            <input type="email" id="supplier-email" value="${sup.email || ''}" class="w-full px-4 py-2 bg-slate-900/50 border border-white/10 rounded-xl text-white focus:ring-2 focus:ring-primary-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-2">Phone</label>
                            <input type="tel" id="supplier-phone" value="${sup.phone || ''}" class="w-full px-4 py-2 bg-slate-900/50 border border-white/10 rounded-xl text-white focus:ring-2 focus:ring-primary-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-2">Address</label>
                            <textarea id="supplier-address" rows="3" class="w-full px-4 py-2 bg-slate-900/50 border border-white/10 rounded-xl text-white focus:ring-2 focus:ring-primary-500">${sup.address || ''}</textarea>
                        </div>
                        <div class="flex gap-3">
                            <button type="button" onclick="closeModal()" class="flex-1 px-4 py-2 bg-slate-800 hover:bg-slate-700 text-white rounded-xl transition-colors">Cancel</button>
                            <button type="submit" class="flex-1 px-4 py-2 bg-primary-600 hover:bg-primary-500 text-white rounded-xl font-semibold transition-colors">Update</button>
                        </div>
                    </form>
                </div>
            `;
            document.getElementById('modal').classList.remove('hidden');
        });
    }

    async function updateSupplier(e, id) {
        e.preventDefault();
        const data = {
            name: document.getElementById('supplier-name').value,
            icon: document.getElementById('supplier-icon').value || '🏭',
            contact: document.getElementById('supplier-contact').value,
            email: document.getElementById('supplier-email').value,
            phone: document.getElementById('supplier-phone').value,
            address: document.getElementById('supplier-address').value,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        try {
            await db.collection('suppliers').doc(id).update(data);
            await logActivity('Update Supplier', `Updated supplier: ${data.name}`);
            showToast('Supplier updated successfully', 'success');
            closeModal();
        } catch (err) {
            showToast('Error: ' + err.message, 'error');
        }
    }

    async function deleteSupplier(id) {
        if (confirm('Delete this supplier? This action cannot be undone.')) {
            try {
                const doc = await db.collection('suppliers').doc(id).get();
                await db.collection('suppliers').doc(id).delete();
                await logActivity('Delete Supplier', `Deleted supplier: ${doc.data().name}`);
                showToast('Supplier deleted', 'success');
            } catch (err) {
                showToast('Error: ' + err.message, 'error');
            }
        }
    }

    // ============================
    // ACTIVITY LOGS
    // ============================

    async function logActivity(action, details) {
        try {
            await db.collection('activity_logs').add({
                action: action,
                details: details,
                admin: auth.currentUser.email,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                ipAddress: 'N/A' // You can integrate IP detection if needed
            });
        } catch (err) {
            console.error('Error logging activity:', err);
        }
    }

    function loadActivityLogs() {
        db.collection('activity_logs').orderBy('timestamp', 'desc').limit(100).onSnapshot(snapshot => {
            const logs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderActivityLogs(logs);
        }, err => showToast('Error loading logs: ' + err.message, 'error'));
    }

    function renderActivityLogs(logs) {
        const table = document.getElementById('logs-table');
        if (!table) return; // Element doesn't exist in DOM yet
        if (logs.length === 0) {
            table.innerHTML = '<tr><td colspan="5" class="px-6 py-12 text-center text-slate-500">No activity logs yet</td></tr>';
            return;
        }
        table.innerHTML = logs.map(log => {
            const date = log.timestamp?.toDate ? log.timestamp.toDate() : new Date();
            return `
                <tr class="hover:bg-white/5 transition-colors">
                    <td class="px-6 py-4 text-slate-300">${date.toLocaleString()}</td>
                    <td class="px-6 py-4 text-white font-medium">${log.admin}</td>
                    <td class="px-6 py-4">
                        <span class="px-3 py-1 rounded-full bg-blue-500/20 text-blue-400 font-semibold text-xs">
                            ${log.action}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-slate-400">${log.details}</td>
                    <td class="px-6 py-4 text-slate-500">${log.ipAddress || 'N/A'}</td>
                </tr>
            `;
        }).join('');
    }

    async function clearOldLogs() {
        if (!confirm('Delete logs older than 30 days?')) return;
        
        try {
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            
            const snapshot = await db.collection('activity_logs')
                .where('timestamp', '<', firebase.firestore.Timestamp.fromDate(thirtyDaysAgo))
                .get();
            
            const batch = db.batch();
            snapshot.docs.forEach(doc => batch.delete(doc.ref));
            await batch.commit();
            
            await logActivity('Clear Logs', `Deleted ${snapshot.size} old logs`);
            showToast(`Deleted ${snapshot.size} old logs`, 'success');
        } catch (err) {
            showToast('Error: ' + err.message, 'error');
        }
    }

    function exportLogsCSV() {
        db.collection('activity_logs').orderBy('timestamp', 'desc').get().then(snapshot => {
            const logs = snapshot.docs.map(doc => doc.data());
            const headers = ['Timestamp', 'Admin', 'Action', 'Details', 'IP Address'];
            const rows = logs.map(log => [
                log.timestamp?.toDate ? log.timestamp.toDate().toLocaleString() : '',
                log.admin || '',
                log.action || '',
                log.details || '',
                log.ipAddress || 'N/A'
            ]);
            const csv = [headers, ...rows].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `activity_logs_${Date.now()}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('Logs exported successfully', 'success');
        });
    }

    // ============================
    // APP SETTINGS & BACKUP
    // ============================

    function loadAppSettings() {
        db.collection('settings').doc('app_config').get().then(doc => {
            if (doc.exists) {
                const data = doc.data();
                document.getElementById('delivery-charge').value = (data.deliveryCharge || 0) / 100;
                document.getElementById('tax-rate').value = data.taxRate || 0;
                document.getElementById('min-order-value').value = (data.minOrderValue || 0) / 100;
                document.getElementById('free-delivery-above').value = (data.freeDeliveryAbove || 0) / 100;
            }
        });
    }

    async function saveAppSettings(e) {
        e.preventDefault();
        const data = {
            deliveryCharge: Math.round(parseFloat(document.getElementById('delivery-charge').value) * 100),
            taxRate: parseFloat(document.getElementById('tax-rate').value),
            minOrderValue: Math.round(parseFloat(document.getElementById('min-order-value').value) * 100),
            freeDeliveryAbove: Math.round(parseFloat(document.getElementById('free-delivery-above').value) * 100),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        try {
            await db.collection('settings').doc('app_config').set(data, { merge: true });
            await logActivity('Update Settings', 'Updated app settings');
            showToast('Settings saved successfully', 'success');
        } catch (err) {
            showToast('Error: ' + err.message, 'error');
        }
    }

    function loadLoyaltySettings() {
        const pointsPer100 = document.getElementById('points-per-100');
        const pointsValue = document.getElementById('points-value');
        const minPointsRedeem = document.getElementById('min-points-redeem');
        const signupBonus = document.getElementById('signup-bonus');
        
        if (!pointsPer100 || !pointsValue || !minPointsRedeem || !signupBonus) {
            console.log('Loyalty settings elements not found yet');
            return;
        }
        
        db.collection('settings').doc('loyalty_program').get().then(doc => {
            if (doc.exists) {
                const data = doc.data();
                pointsPer100.value = data.pointsPer100 || 10;
                pointsValue.value = (data.pointsValue || 0) / 100;
                minPointsRedeem.value = data.minPointsRedeem || 100;
                signupBonus.value = data.signupBonus || 50;
            }
        }).catch(err => {
            console.error('Error loading loyalty settings:', err);
        });
    }

    async function saveLoyaltySettings(e) {
        e.preventDefault();
        const data = {
            pointsPer100: parseInt(document.getElementById('points-per-100').value),
            pointsValue: Math.round(parseFloat(document.getElementById('points-value').value) * 100),
            minPointsRedeem: parseInt(document.getElementById('min-points-redeem').value),
            signupBonus: parseInt(document.getElementById('signup-bonus').value),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        try {
            await db.collection('settings').doc('loyalty_program').set(data, { merge: true });
            await logActivity('Update Loyalty', 'Updated loyalty program settings');
            showToast('Loyalty settings saved successfully', 'success');
        } catch (err) {
            showToast('Error: ' + err.message, 'error');
        }
    }

    function populateFeaturedProductSelect() {
        const select = document.getElementById('featured-product-select');
        if (products.length > 0) {
            select.innerHTML = '<option value="">Select a product...</option>' + 
                products.map(p => `<option value="${p.id}">${p.imageEmoji} ${p.name}</option>`).join('');
        }
    }

    function loadFeaturedProducts() {
        db.collection('settings').doc('featured_products').get().then(doc => {
            const list = document.getElementById('featured-products-list');
            if (doc.exists && doc.data().products && doc.data().products.length > 0) {
                const featured = doc.data().products;
                list.innerHTML = featured.map(productId => {
                    const product = products.find(p => p.id === productId);
                    if (!product) return '';
                    return `
                        <div class="flex items-center justify-between p-3 bg-slate-800 rounded-lg">
                            <div class="flex items-center gap-3">
                                <span class="text-2xl">${product.imageEmoji}</span>
                                <span class="text-white font-medium">${product.name}</span>
                            </div>
                            <button onclick="removeFeaturedProduct('${productId}')" class="p-1 hover:bg-red-900 rounded transition-colors">
                                <span class="material-symbols-rounded text-red-400 text-sm">close</span>
                            </button>
                        </div>
                    `;
                }).join('');
            } else {
                list.innerHTML = '<p class="text-slate-500 text-sm">No featured products yet</p>';
            }
        });
    }

    async function addFeaturedProduct() {
        const select = document.getElementById('featured-product-select');
        const productId = select.value;
        if (!productId) {
            showToast('Please select a product', 'warning');
            return;
        }
        
        try {
            const doc = await db.collection('settings').doc('featured_products').get();
            const current = doc.exists ? (doc.data().products || []) : [];
            
            if (current.includes(productId)) {
                showToast('Product already featured', 'warning');
                return;
            }
            
            current.push(productId);
            await db.collection('settings').doc('featured_products').set({ products: current }, { merge: true });
            await logActivity('Add Featured', `Added product to featured list`);
            loadFeaturedProducts();
            showToast('Product added to featured list', 'success');
        } catch (err) {
            showToast('Error: ' + err.message, 'error');
        }
    }

    async function removeFeaturedProduct(productId) {
        try {
            const doc = await db.collection('settings').doc('featured_products').get();
            const current = doc.data().products || [];
            const updated = current.filter(id => id !== productId);
            await db.collection('settings').doc('featured_products').set({ products: updated }, { merge: true });
            await logActivity('Remove Featured', `Removed product from featured list`);
            loadFeaturedProducts();
            showToast('Product removed from featured list', 'success');
        } catch (err) {
            showToast('Error: ' + err.message, 'error');
        }
    }

    async function backupFullDatabase() {
        document.getElementById('backup-status').textContent = 'Creating backup...';
        try {
            const backup = {
                products: [],
                orders: [],
                users: [],
                categories: [],
                suppliers: [],
                settings: {},
                timestamp: new Date().toISOString()
            };
            
            const productsSnap = await db.collection('products').get();
            backup.products = productsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            const ordersSnap = await db.collection('orders').get();
            backup.orders = ordersSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            const usersSnap = await db.collection('users').get();
            backup.users = usersSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            const categoriesSnap = await db.collection('categories').get();
            backup.categories = categoriesSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            const suppliersSnap = await db.collection('suppliers').get();
            backup.suppliers = suppliersSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            const settingsSnap = await db.collection('settings').get();
            settingsSnap.docs.forEach(doc => {
                backup.settings[doc.id] = doc.data();
            });
            
            const json = JSON.stringify(backup, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `smartcart_backup_${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            await logActivity('Database Backup', 'Created full database backup');
            document.getElementById('backup-status').textContent = 'Backup completed successfully!';
            showToast('Database backup completed', 'success');
            
            setTimeout(() => {
                document.getElementById('backup-status').textContent = '';
            }, 3000);
        } catch (err) {
            document.getElementById('backup-status').textContent = 'Backup failed';
            showToast('Backup failed: ' + err.message, 'error');
        }
    }

    function exportAllProducts() {
        exportProductsCSV();
        logActivity('Export Products', 'Exported all products');
    }

    function exportAllOrders() {
        exportOrdersCSV();
        logActivity('Export Orders', 'Exported all orders');
    }

    async function exportAllUsers() {
        try {
            const snapshot = await db.collection('users').get();
            const users = snapshot.docs.map(doc => doc.data());
            const headers = ['Name', 'Email', 'Phone', 'Joined', 'Total Orders', 'Lifetime Value'];
            const rows = users.map(u => [
                u.displayName || '',
                u.email || '',
                u.phoneNumber || '',
                u.createdAt ? new Date(u.createdAt.seconds * 1000).toLocaleDateString() : '',
                u.totalOrders || 0,
                ((u.lifetimeValue || 0) / 100).toFixed(2)
            ]);
            const csv = [headers, ...rows].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `users_${Date.now()}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            await logActivity('Export Users', 'Exported all users');
            showToast('Users exported successfully', 'success');
        } catch (err) {
            showToast('Export failed: ' + err.message, 'error');
        }
    }

    // ============================
    // CUSTOMER MANAGEMENT
    // ============================

    async function loadCustomers() {
        try {
            const usersSnap = await db.collection('users').get();
            const ordersSnap = await db.collection('orders').get();
            
            const customerData = [];
            
            for (const userDoc of usersSnap.docs) {
                const user = { id: userDoc.id, ...userDoc.data() };
                const userOrders = ordersSnap.docs.filter(o => o.data().userId === user.id);
                
                const totalOrders = userOrders.length;
                const lifetimeValue = userOrders.reduce((sum, o) => sum + (o.data().total || 0), 0);
                const lastPurchase = userOrders.length > 0 
                    ? Math.max(...userOrders.map(o => (o.data().timestamp?.seconds || 0) * 1000))
                    : null;
                
                const daysSinceLastPurchase = lastPurchase 
                    ? Math.floor((Date.now() - lastPurchase) / (1000 * 60 * 60 * 24))
                    : 999;
                
                let segment = 'at-risk';
                if (lifetimeValue > 5000000) segment = 'vip'; // > 50,000
                else if (daysSinceLastPurchase < 30) segment = 'regular';
                
                customerData.push({
                    ...user,
                    totalOrders,
                    lifetimeValue,
                    lastPurchase,
                    segment,
                    loyaltyPoints: user.loyaltyPoints || 0
                });
            }
            
            renderCustomers(customerData);
            updateCustomerSegments(customerData);
        } catch (err) {
            console.error('Error loading customers:', err);
            showToast('Error loading customers: ' + err.message, 'error');
        }
    }

    function renderCustomers(customers) {
        const table = document.getElementById('customers-table');
        if (customers.length === 0) {
            table.innerHTML = '<tr><td colspan="7" class="px-6 py-12 text-center text-slate-500">No customers yet</td></tr>';
            return;
        }
        
        table.innerHTML = customers.map(c => {
            const segmentColors = {
                'vip': 'bg-yellow-500/20 text-yellow-400',
                'regular': 'bg-green-500/20 text-green-400',
                'at-risk': 'bg-red-500/20 text-red-400'
            };
            
            return `
                <tr class="hover:bg-white/5 transition-colors">
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-primary-500/20 flex items-center justify-center">
                                <span class="text-primary-400 font-bold">${(c.displayName || c.email || '?')[0].toUpperCase()}</span>
                            </div>
                            <div>
                                <div class="text-white font-medium">${c.displayName || 'N/A'}</div>
                                <div class="text-xs text-slate-400">${c.email}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <span class="px-3 py-1 rounded-full ${segmentColors[c.segment]} font-semibold text-xs uppercase">
                            ${c.segment}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-white font-semibold">${c.totalOrders}</td>
                    <td class="px-6 py-4 text-emerald-400 font-semibold">₹${(c.lifetimeValue / 100).toLocaleString('en-IN')}</td>
                    <td class="px-6 py-4 text-yellow-400 font-semibold">${c.loyaltyPoints}</td>
                    <td class="px-6 py-4 text-slate-400">${c.lastPurchase ? new Date(c.lastPurchase).toLocaleDateString() : 'Never'}</td>
                    <td class="px-6 py-4 text-right">
                        <button onclick="viewCustomerDetails('${c.id}')" class="p-2 bg-blue-500/10 hover:bg-blue-500/20 rounded-lg transition-colors">
                            <span class="material-symbols-rounded text-blue-400 text-sm">visibility</span>
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
    }

    function updateCustomerSegments(customers) {
        document.getElementById('vip-count').textContent = customers.filter(c => c.segment === 'vip').length;
        document.getElementById('regular-count').textContent = customers.filter(c => c.segment === 'regular').length;
        document.getElementById('atrisk-count').textContent = customers.filter(c => c.segment === 'at-risk').length;
    }

    function filterCustomers() {
        const query = document.getElementById('search-customers').value.toLowerCase();
        const rows = document.querySelectorAll('#customers-table tr');
        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(query) ? '' : 'none';
        });
    }

    function viewCustomerDetails(customerId) {
        showToast('Customer details view - Coming soon!', 'info');
    }

    function exportCustomersCSV() {
        showToast('Exporting customers...', 'info');
        exportAllUsers();
    }

    // ============================
    // SUPPORT TICKETS
    // ============================

    function loadSupportTickets() {
        console.log('Loading support tickets...');
        const table = document.getElementById('tickets-table');
        if (!table) {
            console.error('tickets-table element not found!');
            return;
        }
        table.innerHTML = '<tr><td colspan="7" class="px-6 py-12 text-center text-slate-500"><div class="inline-block loader mr-2"></div> Loading support tickets...</td></tr>';
        
        db.collection('support_tickets').orderBy('createdAt', 'desc').get().then(snapshot => {
            console.log('Support tickets loaded:', snapshot.size);
            const tickets = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderSupportTickets(tickets);
            updateTicketStats(tickets);
        }).catch(err => {
            console.error('Error loading support tickets:', err);
            table.innerHTML = '<tr><td colspan="7" class="px-6 py-12 text-center text-red-400">⚠️ Error loading tickets: ' + err.message + '</td></tr>';
            showToast('Error loading tickets: ' + err.message, 'error');
        });
    }

    function renderSupportTickets(tickets) {
        console.log('Rendering support tickets, count:', tickets.length);
        const table = document.getElementById('tickets-table');
        if (!table) {
            console.error('tickets-table element not found!');
            return;
        }
        if (tickets.length === 0) {
            table.innerHTML = '<tr><td colspan="7" class="px-6 py-12 text-center text-slate-500">No support tickets yet. Support requests from users will appear here.</td></tr>';
            return;
        }
        
        table.innerHTML = tickets.map(t => {
            const priorityColors = {
                'high': 'bg-red-500/20 text-red-400',
                'medium': 'bg-yellow-500/20 text-yellow-400',
                'low': 'bg-green-500/20 text-green-400'
            };
            
            const statusColors = {
                'open': 'bg-blue-500/20 text-blue-400',
                'pending': 'bg-yellow-500/20 text-yellow-400',
                'inprogress': 'bg-orange-500/20 text-orange-400',
                'resolved': 'bg-green-500/20 text-green-400'
            };
            
            return `
                <tr class="hover:bg-white/5 transition-colors">
                    <td class="px-6 py-4 text-white font-mono text-xs">#${t.id.substring(0, 8)}</td>
                    <td class="px-6 py-4">
                        <div class="text-white font-medium">${t.customerName || t.customerEmail}</div>
                        <div class="text-xs text-slate-400">${t.customerEmail}</div>
                    </td>
                    <td class="px-6 py-4 text-white">${t.subject}</td>
                    <td class="px-6 py-4">
                        <span class="px-3 py-1 rounded-full ${priorityColors[t.priority]} font-semibold text-xs uppercase">
                            ${t.priority}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <span class="px-3 py-1 rounded-full ${statusColors[t.status]} font-semibold text-xs uppercase">
                            ${t.status}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-slate-400">${t.createdAt?.toDate ? t.createdAt.toDate().toLocaleDateString() : 'N/A'}</td>
                    <td class="px-6 py-4 text-right">
                        <button onclick="updateTicketStatus('${t.id}')" class="p-2 bg-green-500/10 hover:bg-green-500/20 rounded-lg transition-colors">
                            <span class="material-symbols-rounded text-green-400 text-sm">check_circle</span>
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
    }

    function updateTicketStats(tickets) {
        document.getElementById('open-tickets').textContent = tickets.filter(t => t.status === 'open').length;
        document.getElementById('pending-tickets').textContent = tickets.filter(t => t.status === 'pending').length;
        document.getElementById('inprogress-tickets').textContent = tickets.filter(t => t.status === 'inprogress').length;
        document.getElementById('resolved-tickets').textContent = tickets.filter(t => t.status === 'resolved').length;
    }

    async function updateTicketStatus(ticketId) {
        try {
            await db.collection('support_tickets').doc(ticketId).update({
                status: 'resolved',
                resolvedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            await logActivity('Resolve Ticket', `Resolved support ticket #${ticketId.substring(0, 8)}`);
            showToast('Ticket marked as resolved', 'success');
        } catch (err) {
            showToast('Error: ' + err.message, 'error');
        }
    }

    // ============================
    // STOCK HISTORY TRACKING
    // ============================

    async function logStockChange(productId, oldStock, newStock, reason) {
        try {
            await db.collection('products').doc(productId).collection('stock_history').add({
                oldStock: oldStock,
                newStock: newStock,
                change: newStock - oldStock,
                reason: reason || 'Manual update',
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                admin: auth.currentUser.email
            });
        } catch (err) {
            console.error('Error logging stock change:', err);
        }
    }

    </script>

    <!-- EMERGENCY FIX FOR BLANK TABS -->
    <style>
    .tab-hidden {
        display: none !important;
        visibility: hidden !important;
        opacity: 0 !important;
    }
    .tab-visible {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
    }
    .active-menu {
        background: rgba(16, 185, 129, 0.2) !important;
        color: white !important;
    }
    </style>
    <script>
    // ============================
    // EMERGENCY FIX FOR BLANK TABS
    // ============================

    console.log('🚨 Applying emergency tab fixes...');

    // Fix 1: Ensure all tab content divs exist and are properly structured
    function ensureTabContentExists() {
        const allTabIds = ['dashboard', 'notify', 'products', 'orders', 'users', 'ratings', 'analytics', 'feedbacks', 'support', 'settings', 'bug-reports', 'search'];
        
        allTabIds.forEach(tabId => {
            const tabDiv = document.getElementById('tab-' + tabId);
            if (!tabDiv) {
                console.error(`Missing tab: ${tabId}`);
            } else {
                console.log(`✅ Tab exists: ${tabId}`);
                if (!tabDiv.classList.contains('tab-content')) {
                    tabDiv.classList.add('tab-content');
                }
                
                // Hide all tabs except dashboard initially
                if (tabId === 'dashboard') {
                    tabDiv.style.setProperty('display', 'block', 'important');
                    tabDiv.style.setProperty('visibility', 'visible', 'important');
                    tabDiv.style.setProperty('opacity', '1', 'important');
                    tabDiv.style.setProperty('height', 'auto', 'important');
                    tabDiv.style.setProperty('overflow', 'visible', 'important');
                } else {
                    tabDiv.style.setProperty('display', 'none', 'important');
                    tabDiv.style.setProperty('visibility', 'hidden', 'important');
                    tabDiv.style.setProperty('opacity', '0', 'important');
                    tabDiv.style.setProperty('height', '0', 'important');
                    tabDiv.style.setProperty('overflow', 'hidden', 'important');
                }
            }
        });
    }

    // Fix 2: Override showTab with debugging
    window.showTab = function(tabId) {
        console.log(`🔄 Switching to tab: ${tabId}`);
        
        // Force hide ALL tabs with aggressive styling
        document.querySelectorAll('.tab-content').forEach(el => {
            el.style.setProperty('display', 'none', 'important');
            el.style.setProperty('visibility', 'hidden', 'important');
            el.style.setProperty('opacity', '0', 'important');
            el.style.setProperty('height', '0', 'important');
            el.style.setProperty('overflow', 'hidden', 'important');
        });
        
        // Force show selected tab with aggressive styling
        const selectedTab = document.getElementById('tab-' + tabId);
        if (selectedTab) {
            selectedTab.style.setProperty('display', 'block', 'important');
            selectedTab.style.setProperty('visibility', 'visible', 'important');
            selectedTab.style.setProperty('opacity', '1', 'important');
            selectedTab.style.setProperty('height', 'auto', 'important');
            selectedTab.style.setProperty('overflow', 'visible', 'important');
            console.log(`  ✅ Shown: tab-${tabId}`);
        } else {
            console.error(`  ❌ Tab not found: tab-${tabId}`);
            showToast(`Error: Tab "${tabId}" not found`, 'error');
            return;
        }
        
        // Update navigation buttons
        document.querySelectorAll('.nav-tab').forEach(el => {
            el.classList.remove('active', 'text-white');
        });
        const activeNavBtn = document.querySelector(`.nav-tab[data-target="${tabId}"]`);
        if (activeNavBtn) {
            activeNavBtn.classList.add('active', 'text-white');
        }

        // Load data for the tab
        setTimeout(() => {
            console.log(`  📊 Loading data for: ${tabId}`);
            
            switch(tabId) {
                case 'feedbacks':
                    if (!window.feedbacksLoaded) {
                        loadFeedbacksFixed();
                        window.feedbacksLoaded = true;
                    }
                    break;
                case 'support':
                    if (!window.supportLoaded) {
                        loadSupportTicketsFixed();
                        window.supportLoaded = true;
                    }
                    break;
                case 'bug-reports':
                    if (!window.bugReportsLoaded) {
                        loadBugReportsFixed();
                        window.bugReportsLoaded = true;
                    }
                    break;
                case 'settings':
                    if (!window.settingsLoaded) {
                        loadSettingsDataFixed();
                        window.settingsLoaded = true;
                    }
                    break;
                case 'ratings':
                    if (!window.ratingsLoaded && typeof loadRatingsData === 'function') {
                        loadRatingsData();
                        window.ratingsLoaded = true;
                    }
                    break;
                case 'analytics':
                    if (!window.analyticsLoaded && typeof loadAnalyticsData === 'function') {
                        loadAnalyticsData();
                        window.analyticsLoaded = true;
                    }
                    break;
            }
        }, 200);
    };

    // Fix 3: Safe loading functions with better error handling
    function loadFeedbacksFixed() {
        console.log('📝 Loading feedbacks...');
        const tbody = document.getElementById('feedbacks-table');
        
        if (!tbody) {
            console.error('❌ feedbacks-table not found');
            showToast('Error: Feedbacks table not found in page', 'error');
            
            const tab = document.getElementById('tab-feedbacks');
            if (tab) {
                tab.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-96">
                        <span class="material-symbols-rounded text-6xl text-red-400 mb-4">error</span>
                        <h3 class="text-xl font-bold text-white mb-2">Loading Error</h3>
                        <p class="text-slate-400">Feedbacks table element not found in HTML</p>
                        <button onclick="location.reload()" class="mt-4 px-4 py-2 bg-primary-600 rounded-lg text-white">Reload Page</button>
                    </div>
                `;
            }
            return;
        }
        
        tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-12 text-center text-slate-400"><div class="inline-block loader mr-2"></div> Loading feedbacks...</td></tr>';
        
        if (!window.db) {
            tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-12 text-center text-red-400">❌ Database not initialized</td></tr>';
            return;
        }
        
        window.db.collection('feedbacks').orderBy('timestamp', 'desc').limit(50).get()
            .then(snapshot => {
                console.log(`✅ Loaded ${snapshot.size} feedbacks`);
                
                if (snapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-12 text-center text-slate-500">No feedbacks yet. User feedback will appear here.</td></tr>';
                    return;
                }
                
                window.feedbacks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                if (typeof renderFeedbacks === 'function') {
                    renderFeedbacks();
                } else {
                    tbody.innerHTML = window.feedbacks.map(f => {
                        const date = f.timestamp?.toDate?.() || new Date();
                        return `
                            <tr class="hover:bg-white/5">
                                <td class="px-6 py-4 text-slate-300">${f.email || 'Anonymous'}</td>
                                <td class="px-6 py-4 text-yellow-400">${'⭐'.repeat(f.rating || 0)}</td>
                                <td class="px-6 py-4 text-slate-400">${(f.message || '').substring(0, 100)}</td>
                                <td class="px-6 py-4 text-slate-500">${f.category || 'General'}</td>
                                <td class="px-6 py-4 text-slate-500">${date.toLocaleDateString()}</td>
                            </tr>
                        `;
                    }).join('');
                }
            })
            .catch(error => {
                console.error('❌ Error loading feedbacks:', error);
                tbody.innerHTML = `<tr><td colspan="5" class="px-6 py-12 text-center text-red-400">❌ Error: ${error.message}</td></tr>`;
                showToast('Error loading feedbacks: ' + error.message, 'error');
            });
    }

    function loadBugReportsFixed() {
        console.log('🐛 Loading bug reports...');
        const tbody = document.getElementById('bug-reports-table');
        
        if (!tbody) {
            console.error('❌ bug-reports-table not found');
            showToast('Error: Bug reports table not found', 'error');
            
            const tab = document.getElementById('tab-bug-reports');
            if (tab) {
                tab.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-96">
                        <span class="material-symbols-rounded text-6xl text-red-400 mb-4">error</span>
                        <h3 class="text-xl font-bold text-white mb-2">Loading Error</h3>
                        <p class="text-slate-400">Bug reports table element not found</p>
                        <button onclick="location.reload()" class="mt-4 px-4 py-2 bg-primary-600 rounded-lg text-white">Reload Page</button>
                    </div>
                `;
            }
            return;
        }
        
        tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-12 text-center text-slate-400"><div class="inline-block loader mr-2"></div> Loading bug reports...</td></tr>';
        
        if (!window.db) {
            tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-12 text-center text-red-400">❌ Database not initialized</td></tr>';
            return;
        }
        
        window.db.collection('bug_reports').orderBy('timestamp', 'desc').limit(50).get()
            .then(snapshot => {
                console.log(`✅ Loaded ${snapshot.size} bug reports`);
                
                if (snapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-12 text-center text-slate-500">No bug reports yet. User reports will appear here.</td></tr>';
                    return;
                }
                
                window.bugReports = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                if (typeof renderBugReports === 'function') {
                    renderBugReports();
                } else {
                    tbody.innerHTML = window.bugReports.map(b => {
                        const date = b.timestamp?.toDate?.() || new Date();
                        return `
                            <tr class="hover:bg-white/5">
                                <td class="px-6 py-4 text-slate-300">${b.email || 'Anonymous'}</td>
                                <td class="px-6 py-4 text-white font-medium">${b.title || 'Untitled'}</td>
                                <td class="px-6 py-4 text-slate-400">${(b.description || '').substring(0, 100)}</td>
                                <td class="px-6 py-4"><span class="px-2 py-1 rounded text-xs ${b.status === 'resolved' ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'}">${b.status || 'open'}</span></td>
                                <td class="px-6 py-4 text-slate-500">${date.toLocaleDateString()}</td>
                            </tr>
                        `;
                    }).join('');
                }
            })
            .catch(error => {
                console.error('❌ Error loading bug reports:', error);
                tbody.innerHTML = `<tr><td colspan="5" class="px-6 py-12 text-center text-red-400">❌ Error: ${error.message}</td></tr>`;
                showToast('Error loading bug reports: ' + error.message, 'error');
            });
    }

    function loadSupportTicketsFixed() {
        console.log('🎫 Loading support tickets...');
        const tbody = document.getElementById('tickets-table');
        
        if (!tbody) {
            console.error('❌ tickets-table not found');
            showToast('Error: Support tickets table not found', 'error');
            
            const tab = document.getElementById('tab-support');
            if (tab) {
                tab.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-96">
                        <span class="material-symbols-rounded text-6xl text-red-400 mb-4">error</span>
                        <h3 class="text-xl font-bold text-white mb-2">Loading Error</h3>
                        <p class="text-slate-400">Support tickets table element not found</p>
                        <button onclick="location.reload()" class="mt-4 px-4 py-2 bg-primary-600 rounded-lg text-white">Reload Page</button>
                    </div>
                `;
            }
            return;
        }
        
        tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-12 text-center text-slate-400"><div class="inline-block loader mr-2"></div> Loading support tickets...</td></tr>';
        
        if (!window.db) {
            tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-12 text-center text-red-400">❌ Database not initialized</td></tr>';
            return;
        }
        
        window.db.collection('support_tickets').orderBy('createdAt', 'desc').limit(50).get()
            .then(snapshot => {
                console.log(`✅ Loaded ${snapshot.size} support tickets`);
                
                if (snapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-12 text-center text-slate-500">No support tickets yet. Support requests will appear here.</td></tr>';
                    
                    ['open', 'pending', 'inprogress', 'resolved'].forEach(status => {
                        const elem = document.getElementById(`${status}-tickets`);
                        if (elem) elem.textContent = '0';
                    });
                    return;
                }
                
                const tickets = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                if (typeof renderSupportTickets === 'function') {
                    renderSupportTickets(tickets);
                } else {
                    tbody.innerHTML = tickets.map(t => {
                        const date = t.createdAt?.toDate?.() || new Date();
                        return `
                            <tr class="hover:bg-white/5">
                                <td class="px-6 py-4 font-mono text-xs">#${t.id.substring(0, 8)}</td>
                                <td class="px-6 py-4 text-white">${t.customerEmail || 'Unknown'}</td>
                                <td class="px-6 py-4 text-white">${t.subject || 'No subject'}</td>
                                <td class="px-6 py-4"><span class="px-2 py-1 rounded text-xs bg-yellow-500/20 text-yellow-400">${t.priority || 'medium'}</span></td>
                                <td class="px-6 py-4"><span class="px-2 py-1 rounded text-xs bg-blue-500/20 text-blue-400">${t.status || 'open'}</span></td>
                                <td class="px-6 py-4 text-slate-400">${date.toLocaleDateString()}</td>
                                <td class="px-6 py-4 text-right">
                                    <button onclick="alert('Ticket #${t.id.substring(0, 8)}')" class="p-2 bg-blue-500/10 rounded-lg">
                                        <span class="material-symbols-rounded text-sm text-blue-400">visibility</span>
                                    </button>
                                </td>
                            </tr>
                        `;
                    }).join('');
                }
                
                if (typeof updateTicketStats === 'function') {
                    updateTicketStats(tickets);
                }
            })
            .catch(error => {
                console.error('❌ Error loading support tickets:', error);
                tbody.innerHTML = `<tr><td colspan="7" class="px-6 py-12 text-center text-red-400">❌ Error: ${error.message}</td></tr>`;
                showToast('Error loading support tickets: ' + error.message, 'error');
            });
    }

    function loadSettingsDataFixed() {
        console.log('⚙️ Loading settings...');
        
        const elements = {
            deliveryCharge: document.getElementById('delivery-charge'),
            taxRate: document.getElementById('tax-rate'),
            minOrderValue: document.getElementById('min-order-value'),
            freeDeliveryAbove: document.getElementById('free-delivery-above')
        };
        
        const missing = Object.keys(elements).filter(key => !elements[key]);
        
        if (missing.length > 0) {
            console.error('❌ Missing settings elements:', missing);
            showToast('Error: Settings form incomplete', 'error');
            return;
        }
        
        if (!window.db) {
            showToast('Database not initialized', 'error');
            return;
        }
        
        window.db.collection('settings').doc('app_config').get()
            .then(doc => {
                if (doc.exists) {
                    const data = doc.data();
                    elements.deliveryCharge.value = ((data.deliveryCharge || 5000) / 100).toFixed(2);
                    elements.taxRate.value = (data.taxRate || 18).toFixed(2);
                    elements.minOrderValue.value = ((data.minOrderValue || 10000) / 100).toFixed(2);
                    elements.freeDeliveryAbove.value = ((data.freeDeliveryAbove || 50000) / 100).toFixed(2);
                    console.log('✅ App settings loaded');
                } else {
                    console.log('ℹ️ No app settings found, using defaults');
                }
            })
            .catch(err => {
                console.error('❌ Error loading app settings:', err);
                showToast('Error loading settings: ' + err.message, 'error');
            });
        
        const loyaltyElements = {
            pointsPer100: document.getElementById('points-per-100'),
            pointsValue: document.getElementById('points-value'),
            minPointsRedeem: document.getElementById('min-points-redeem'),
            signupBonus: document.getElementById('signup-bonus')
        };
        
        if (Object.values(loyaltyElements).every(el => el)) {
            window.db.collection('settings').doc('loyalty_program').get()
                .then(doc => {
                    if (doc.exists) {
                        const data = doc.data();
                        loyaltyElements.pointsPer100.value = data.pointsPer100 || 10;
                        loyaltyElements.pointsValue.value = ((data.pointsValue || 25) / 100).toFixed(2);
                        loyaltyElements.minPointsRedeem.value = data.minPointsRedeem || 100;
                        loyaltyElements.signupBonus.value = data.signupBonus || 50;
                        console.log('✅ Loyalty settings loaded');
                    }
                })
                .catch(err => console.error('Error loading loyalty settings:', err));
        }
        
        if (typeof loadFeaturedProducts === 'function') loadFeaturedProducts();
        if (typeof populateFeaturedProductSelect === 'function') populateFeaturedProductSelect();
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        console.log('🚀 Page loaded, checking tabs...');
        ensureTabContentExists();
    });

    // Also run immediately in case DOM is already loaded
    if (document.readyState === 'complete' || document.readyState === 'interactive') {
        setTimeout(() => {
            console.log('🚀 Running immediate tab check...');
            ensureTabContentExists();
        }, 100);
    }

    console.log('✅ Emergency tab fixes loaded!');

    // ================================
    // SLIDE-OUT MENU FUNCTIONS
    // ================================

    let menuOpen = false;

    function toggleMenu() {
        console.log('🎯 MENU BUTTON CLICKED!');
        const menu = document.getElementById('slide-menu');
        const overlay = document.getElementById('menu-overlay');

        if (!menu || !overlay) {
            console.error('Menu elements not found!');
            return;
        }

        if (menuOpen) {
            console.log('🔒 Closing menu...');
            // Hide menu
            menu.classList.add('transform', '-translate-x-full');
            menu.classList.remove('translate-x-0');
            overlay.classList.add('opacity-0', 'invisible');
            overlay.classList.remove('opacity-100', 'visible');
            document.body.style.overflow = '';
            // Delay display none to allow transition
            setTimeout(() => {
                menu.style.display = 'none';
                overlay.style.display = 'none';
            }, 300);
        } else {
            console.log('🔓 Opening menu...');
            // Show menu
            menu.style.display = 'block';
            overlay.style.display = 'block';
            // Force reflow
            menu.offsetHeight;
            overlay.offsetHeight;
            // Apply transform
            menu.classList.remove('transform', '-translate-x-full');
            menu.classList.add('translate-x-0');
            overlay.classList.remove('opacity-0', 'invisible');
            overlay.classList.add('opacity-100', 'visible');
            document.body.style.overflow = 'hidden';
        }

        menuOpen = !menuOpen;
        console.log('📊 Menu state:', menuOpen ? 'OPEN' : 'CLOSED');
    }

    function selectMenuItem(tabId, iconName, displayName) {
        // Update current tab indicator
        const currentIcon = document.getElementById('current-tab-icon');
        const currentName = document.getElementById('current-tab-name');

        if (currentIcon) currentIcon.textContent = iconName;
        if (currentName) currentName.textContent = displayName;

        // Update active menu item
        document.querySelectorAll('.menu-item').forEach(item => {
            item.classList.remove('active-menu', 'text-white', 'bg-primary-500/20');
            item.classList.add('text-slate-300');
        });

        const activeItem = document.querySelector(`.menu-item[data-target="${tabId}"]`);
        if (activeItem) {
            activeItem.classList.add('active-menu', 'text-white', 'bg-primary-500/20');
            activeItem.classList.remove('text-slate-300');
        }

        // Show the selected tab
        showTab(tabId);

        // Close menu on mobile
        if (window.innerWidth < 768) {
            toggleMenu();
        }
    }

    // Close menu on escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && menuOpen) {
            toggleMenu();
        }
    });

    // Initialize menu state
    document.addEventListener('DOMContentLoaded', function() {
        // Set initial active menu item
        const activeItem = document.querySelector('.menu-item[data-target="dashboard"]');
        if (activeItem) {
            activeItem.classList.add('active-menu', 'text-white', 'bg-primary-500/20');
            activeItem.classList.remove('text-slate-300');
        }
    });

</script>
</body>
</html>